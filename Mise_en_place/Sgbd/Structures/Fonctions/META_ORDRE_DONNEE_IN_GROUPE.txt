##
META_ORDRE_DONNEE_IN_GROUPE
=SQL=
create or replace
FUNCTION META_ORDRE_DONNEE_IN_GROUPE(
      p_company_id VARCHAR2,
      p_id_groupe  VARCHAR2,
      p_nom_donnee VARCHAR2)
    RETURN NUMBER
  IS
    v_ordreDonneeOuGroupe NUMBER;
    v_retour              NUMBER;
  BEGIN
    BEGIN
      IF NOT SUBSTR(p_nom_donnee,1,1)='#' OR INSTR(p_nom_donnee,'£')=0 THEN
        SELECT ORDRE
        INTO v_retour
        FROM META_GROUPE_DONNEES
        WHERE COMPANY_ID=p_company_id
        AND ID_GROUPE   =p_id_groupe
        AND NOM_DONNEE  =p_nom_donnee;
      ELSE
        SELECT ORDRE
        INTO v_retour
        FROM META_GROUPE_DONNEES
        WHERE COMPANY_ID=p_company_id
        AND ID_GROUPE   =p_id_groupe
        AND NOM_DONNEE  =SUBSTR(p_nom_donnee,1,INSTR(p_nom_donnee,'£')-1)
        AND ID_GROUPE   =SUBSTR(p_nom_donnee,INSTR(p_nom_donnee,'£')  +1);
      END IF;
      v_ordreDonneeOuGroupe := v_retour;
    EXCEPTION
    WHEN NO_DATA_FOUND THEN
      v_retour := 0;
      DECLARE
        CURSOR v_tabSousGroupes
        IS
          SELECT *
          FROM META_GROUPE_DONNEES
          WHERE COMPANY_ID=p_company_id
          AND ID_GROUPE   =p_id_groupe
          AND NOM_DONNEE LIKE '#GROUPE%';
        v_ligneSousGroupe META_GROUPE_DONNEES%ROWTYPE;
        v_ordreTmp NUMBER;
      BEGIN
        OPEN v_tabSousGroupes;
        LOOP
          FETCH v_tabSousGroupes INTO v_ligneSousGroupe;
          EXIT
        WHEN v_tabSousGroupes%NOTFOUND OR v_retour>0;
          v_ordreTmp                             := META_ORDRE_DONNEE_IN_GROUPE(p_company_id, v_ligneSousGroupe.SUFFIXE_OU_LIBELLE, p_nom_donnee);
          IF v_ordreTmp                           >0 THEN
            v_retour                             := v_ligneSousGroupe.ORDRE+v_ordreTmp-1;
            v_ordreDonneeOuGroupe                := v_ligneSousGroupe.ORDRE;
          END IF;
        END LOOP;
        CLOSE v_tabSousGroupes;
      END;
    WHEN OTHERS THEN
      RETURN 0;
    END;
    IF v_retour IS NULL OR v_retour=0 THEN
      RETURN 0;
    END IF;
    DECLARE
      CURSOR v_tabSousGroupes
      IS
        SELECT *
        FROM META_GROUPE_DONNEES
        WHERE COMPANY_ID=p_company_id
        AND ID_GROUPE   =p_id_groupe
        AND NOM_DONNEE LIKE '#GROUPE%'
        AND ORDRE<v_ordreDonneeOuGroupe;
      v_ligneSousGroupe META_GROUPE_DONNEES%ROWTYPE;
    BEGIN
      OPEN v_tabSousGroupes;
      LOOP
        FETCH v_tabSousGroupes INTO v_ligneSousGroupe;
        EXIT
      WHEN v_tabSousGroupes%NOTFOUND OR v_retour>1000;
        v_retour                               := v_retour+(META_MAX_ORDRE_GROUPE_DONNEES(p_company_id, v_ligneSousGroupe.SUFFIXE_OU_LIBELLE)-1);
      END LOOP;
      CLOSE v_tabSousGroupes;
    END;
    RETURN v_retour;
  END META_ORDRE_DONNEE_IN_GROUPE;
  