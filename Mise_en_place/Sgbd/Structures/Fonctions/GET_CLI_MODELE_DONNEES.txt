##
GET_CLI_MODELE_DONNEES
=SQL=
create or replace FUNCTION GET_CLI_MODELE_DONNEES ( numpac varchar2) RETURN T_TABCLI_MODELE_DONNES AS
 p_retour T_TABCLI_MODELE_DONNES      := T_TABCLI_MODELE_DONNES ();
 
 type MODELE_DONNEES
 IS
 record
 (
 ESPACE	VARCHAR2(50),
 REGROUPEMENT	VARCHAR2(50),
 THEME	VARCHAR2(50),
 LIBELLE_PAGE	VARCHAR2(50),
 NOM_PAGE	VARCHAR2(100),
 ONGLET	VARCHAR2(100),
 NOM_DONNEE	VARCHAR2(151),
 LIBELLE_DONNEE	VARCHAR2(100),
 NOM_DICTIONNAIRE	VARCHAR2(24),
 TYPE_DONNEE	VARCHAR2(1),
 LONGUEUR_PARTIE_ENTIERE	VARCHAR2(10),
 LONGUEUR_PARTIE_DECIMALE	VARCHAR2(1),
 MODE_SAISIE	VARCHAR2(20),
 AFFICHE_CHOIX_VIDE_SELECT	VARCHAR2(1),
 VALEURS_OUI_NON	VARCHAR2(1000),
 REGLES_AFFICHAGE	VARCHAR2(50),
 PENTREE	VARCHAR2(4000),
 PENTREE_FORCABLE	VARCHAR2(1),
 PENTREE_CODE_MODIF	VARCHAR2(4000),
 NOMTABLE	VARCHAR2(1000));
 TYPE TAB_MODELE_DONNES
 IS
 TABLE OF MODELE_DONNEES INDEX BY binary_integer ;
 tabModeles TAB_MODELE_DONNES;
 requete CLOB;
 begin
 requete:= ' WITH liensDonneesGroupes(company_id, id_groupe, nom_donnee, id_groupe_donnees, suffixe_ou_libelle, onglet) AS (SELECT gd.company_id,gd.id_groupe,';
 requete:= requete||'   CASE      WHEN SUBSTR(gd.nom_donnee,1,1)=''#''      THEN gd.nom_donnee        ||''£''        ||gd.id_groupe      ELSE gd.nom_donnee    END AS nom_donnee,    gd.id_groupe,    gd.suffixe_ou_libelle,';
 requete:= requete||'  '''' ';
 requete:= requete||' FROM meta_groupe_donnees gd  UNION ALL  SELECT l.company_id,    l.id_groupe,    CASE      WHEN SUBSTR(gd.nom_donnee,1,1)=''#''      THEN gd.nom_donnee        ||''£''        ||gd.id_groupe      ELSE gd.nom_donnee    END AS nom_donnee,';
 requete:= requete||'gd.id_groupe,    gd.suffixe_ou_libelle,    DECODE(gd_info.EST_ONGLET,''O'', gd_info.LIBELLE_GROUPE, l.ONGLET)  FROM meta_groupe_donnees gd,    liensDonneesGroupes l  ,    META_GROUPE_DONNEES_INFO gd_info   where gd.company_id=l.company_id  AND gd.ID_GROUPE   =gd_info.ID_GROUPE  AND gd.id_groupe   =l.suffixe_ou_libelle  AND l.nom_donnee LIKE ''#GROUPE%''),   TGE_REF_MAPDO_PAR_DONNEE(NUMPAC, DONNEEGXP, ELEMENTS, FORCABLE) AS';
 requete:= requete||'(SELECT MAPDO.NUMPAC,    MAPDO.DONNEEGXP,    LISTAGG(MAPDO.ELEMENT, '','') WITHIN GROUP (  ORDER BY MAPDO.ELEMENT) ELEMENTS,    MAX(FORCABLE_ECRAN_GENERE) FORCABLE  FROM TGE_REF_MAPDO MAPDO  GROUP BY MAPDO.NUMPAC,    MAPDO.DONNEEGXP  )  select   ESPACE_ELT.LIBELLE ESPACE,  REGROUPEMENT_ELT.LIBELLE REGROUPEMENT,';
 requete:= requete||'THEME_ELT.LIBELLE THEME,  PAGE_ELT.LIBELLE LIBELLE_PAGE,  META_ECRAN.NOM_PAGE,  liensDonneesGroupes.ONGLET,  liensDonneesGroupes.NOM_DONNEE,  META_DONNEE_ECRAN.LIBELLE_DONNEE,  META_DONNEE_GENERALE.NOM_DICTIONNAIRE,  META_DONNEE_GENERALE.TYPE_DONNEE,  DECODE(META_DONNEE_GENERALE.TYPE_DONNEE, ''D'', '''', META_DONNEE_GENERALE.LONGUEUR_MASQUE_NB_ENTIERS) LONGUEUR_PARTIE_ENTIERE,  META_DONNEE_GENERALE.NB_DECIMAUX LONGUEUR_PARTIE_DECIMALE,  META_DONNEE_ECRAN.MODE_SAISIE,  META_DONNEE_ECRAN.AFFICHE_CHOIX_VIDE_SELECT,';
 requete:= requete||'CASE    WHEN META_DONNEE_ECRAN.MODE_SAISIE=''checkbox''    THEN META_DONNEE_GENERALE.CHECKBOX_VALEUR_OFF      || ''/ ''     || META_DONNEE_GENERALE.CHECKBOX_VALEUR_ON    WHEN META_DONNEE_ECRAN.MODE_SAISIE                     =''select''    AND instr(UPPER(SYS_REQUETES_JSP.NOMTABLE), ''''''OUI'''''')!=0    THEN SYS_REQUETES_JSP.NOMTABLE  END VALEURS_OUI_NON,  CASE    WHEN REGLES_AFF_RD.ID_REGLEGESTION IS NOT NULL    THEN REGLES_AFF_RD.ID_REGLEGESTION    WHEN REGLES_AFF_CLI.ID_REGLEGESTION IS NOT NULL    THEN REGLES_AFF_CLI.ID_REGLEGESTION  END REGLES_AFFICHAGE,';
 requete:= requete||'NVL(PAC_ENTREE.ELEMENTS, PAC_ETOILE.ELEMENTS) "PENTREE",  NVL(PAC_ENTREE.FORCABLE, PAC_ETOILE.FORCABLE) "PENTREE_FORCABLE",  NVL(  (SELECT codemodifs  FROM    (SELECT MAPDO.DONNEEGXP AS DONN,      LISTAGG(MAPDO.ELEMENT, '','') WITHIN GROUP (    ORDER BY MAPDO.ELEMENT) ELEMENTS,      LISTAGG(DICOZ.CODEMODIF, '','') WITHIN GROUP (    ORDER BY MAPDO.ELEMENT) CODEMODIFS    FROM TGE_REF_DICOZ DICOZ    LEFT OUTER JOIN TGE_REF_MAPDO MAPDO    ON dicoz.numpac    ='''|| numpac  ||'''    AND dicoz.element  = mapdo.element';
 requete:= requete||'  WHERE mapdo.numpac = '''|| numpac  ||'''    GROUP BY MAPDO.NUMPAC,      MAPDO.DONNEEGXP    )  WHERE DONN   = liensDonneesGroupes.NOM_DONNEE  AND ELEMENTS = NVL(PAC_ENTREE.ELEMENTS, PAC_ETOILE.ELEMENTS)  ), (  (SELECT codemodifs  FROM    (SELECT MAPDO.DONNEEGXP AS DONN,      LISTAGG(MAPDO.ELEMENT, '','') WITHIN GROUP (    ORDER BY MAPDO.ELEMENT) ELEMENTS,      LISTAGG(DICOZ.CODEMODIF, '','') WITHIN GROUP (    ORDER BY MAPDO.ELEMENT) CODEMODIFS    FROM TGE_REF_DICOZ DICOZ    LEFT OUTER JOIN TGE_REF_MAPDO MAPDO    ON dicoz.numpac    = '''|| numpac  ||'''    AND dicoz.element  = mapdo.element    WHERE mapdo.numpac = ''*''    GROUP BY MAPDO.NUMPAC,';
 requete:= requete||'    MAPDO.DONNEEGXP    )  WHERE DONN   = liensDonneesGroupes.NOM_DONNEE  AND ELEMENTS = NVL(PAC_ENTREE.ELEMENTS, PAC_ETOILE.ELEMENTS)  ))) "PENTREE_CODE_MODIF",    SYS_REQUETES_JSP.NOMTABLE   FROM META_ECRAN INNER JOIN liensDonneesGroupes ON META_ECRAN.ID_GROUPE_DONNEES   =liensDonneesGroupes.ID_GROUPE AND liensDonneesGroupes.COMPANY_ID=''*'' INNER JOIN META_DONNEE_GENERALE ON liensDonneesGroupes.NOM_DONNEE  =META_DONNEE_GENERALE.NOM_DONNEE AND META_DONNEE_GENERALE.COMPANY_ID=''*'' INNER JOIN META_DONNEE_ECRAN ON META_DONNEE_GENERALE.NOM_DONNEE  =META_DONNEE_ECRAN.NOM_DONNEE AND META_DONNEE_ECRAN.COMPANY_ID    =''*'' AND META_DONNEE_ECRAN.NOM_PAGE      =''*'' AND (META_DONNEE_ECRAN.MODE_SAISIE! =''hidden'' OR META_DONNEE_GENERALE.NOM_DONNEE IN (SELECT NOM_DONNEE FROM STD_STRUC_DONNEES_HOST';
 requete:= requete||')OR META_DONNEE_GENERALE.NOM_DICTIONNAIRE=META_ECRAN.NOM_DICTIONNAIRE ) LEFT OUTER JOIN META_REGLEGESTION_DESC REGLES_AFF_CLI ON REGLES_AFF_CLI.ID_REGLEGESTION        =META_DONNEE_ECRAN.ID_REGLEGESTION_AFF_CLI AND REGLES_AFF_CLI.COMPANY_ID            =''*'' AND REGLES_AFF_CLI.FLAG_SPECIF_TYPE_REGLE=''M'' LEFT OUTER JOIN META_REGLEGESTION_DESC REGLES_AFF_RD ON REGLES_AFF_RD.ID_REGLEGESTION        =META_DONNEE_ECRAN.ID_REGLEGESTION_AFF_RD AND REGLES_AFF_RD.COMPANY_ID            =''*'' AND REGLES_AFF_RD.FLAG_SPECIF_TYPE_REGLE=''M'' LEFT OUTER JOIN SYS_REQUETES_JSP ON META_DONNEE_ECRAN.APPELTABLE_NOMPAGE   =SYS_REQUETES_JSP.NOMPAGE AND META_DONNEE_ECRAN.APPELTABLE_IDREQUETE=SYS_REQUETES_JSP.IDREQUETE LEFT OUTER JOIN TGE_REF_MAPDO_PAR_DONNEE PAC_ETOILE ON (PAC_ETOILE.NUMPAC             =''*'') AND liensDonneesGroupes.NOM_DONNEE=PAC_ETOILE.DONNEEGXP LEFT OUTER JOIN TGE_REF_MAPDO_PAR_DONNEE PAC_ENTREE ON (PAC_ENTREE.NUMPAC             ='''|| numpac  ||''') AND liensDonneesGroupes.NOM_DONNEE=PAC_ENTREE.DONNEEGXP INNER JOIN SYS_SCH_ELEMENT PAGE_ELT';
 requete:= requete||' ON PAGE_ELT.NOM_PAGE= ''Modules/''  || CODE_DESTINATION  || ''/''  || MODULE_ECRAN  || ''/''  || ROLE_ECRAN  || ''/''  || META_ECRAN.NOM_PAGE  || ''.jsp'' OR PAGE_ELT.NOM_PAGE=REPLACE(''Modules/''  || CODE_DESTINATION  || ''/''  || MODULE_ECRAN  || ''/''  || ROLE_ECRAN  || ''/''  || META_ECRAN.NOM_PAGE  || ''.jsp'', ''_POP'', '''') OR PAGE_ELT.NOM_PAGE= REPLACE(''Modules/''  || CODE_DESTINATION  || ''/''  || MODULE_ECRAN  || ''/''  || ROLE_ECRAN  || ''/''  || META_ECRAN.NOM_PAGE  || ''.jsp'', ''_POP'', ''_TAB'') INNER JOIN SYS_SCHEMAS PAGE_LIEN ON PAGE_ELT.CODE_ELEMENT=PAGE_LIEN.CODE_ELT AND PAGE_ELT.NIVEAU     =PAGE_LIEN.NIVEAU INNER JOIN SYS_SCHEMAS THEME_LIEN ON PAGE_LIEN.CODE_ASSO_PERE=THEME_LIEN.CODE_ASSO INNER JOIN SYS_SCH_ELEMENT THEME_ELT ON THEME_LIEN.CODE_ELT=THEME_ELT.CODE_ELEMENT AND THEME_LIEN.NIVEAU =THEME_ELT.NIVEAU INNER JOIN SYS_SCHEMAS REGROUPEMENT_LIEN ON THEME_LIEN.CODE_ASSO_PERE=REGROUPEMENT_LIEN.CODE_ASSO INNER JOIN SYS_SCH_ELEMENT REGROUPEMENT_ELT ON REGROUPEMENT_LIEN.CODE_ELT=REGROUPEMENT_ELT.CODE_ELEMENT AND REGROUPEMENT_LIEN.NIVEAU =REGROUPEMENT_ELT.NIVEAU INNER JOIN SYS_SCHEMAS ESPACE_LIEN ON REGROUPEMENT_LIEN.CODE_ASSO_PERE=ESPACE_LIEN.CODE_ASSO INNER JOIN SYS_SCH_ELEMENT ESPACE_ELT ON ESPACE_LIEN.CODE_ELT    =ESPACE_ELT.CODE_ELEMENT AND ESPACE_LIEN.NIVEAU     =ESPACE_ELT.NIVEAU ';
 
 --DBMS_OUTPUT.PUT_LINe(requete);
 --FIXME utiliser la procédure trace_dbms_output()
 execute immediate requete bulk collect into tabModeles  ;
  IF (tabModeles.exists(1) ) THEN
 FOR j IN tabModeles.first .. tabModeles.last
 LOOP
 p_retour.extend ;
 p_retour(p_retour.count) := LIG_CLI_MODELE_DONNES(
 tabModeles(j).ESPACE	,
 tabModeles(j).REGROUPEMENT	,
 tabModeles(j).THEME	,
 tabModeles(j).LIBELLE_PAGE	,
 tabModeles(j).NOM_PAGE	,
 tabModeles(j).ONGLET	,
 tabModeles(j).NOM_DONNEE	,
 tabModeles(j).LIBELLE_DONNEE	,
 tabModeles(j).NOM_DICTIONNAIRE	,
 tabModeles(j).TYPE_DONNEE	,
 tabModeles(j).LONGUEUR_PARTIE_ENTIERE	,
 tabModeles(j).LONGUEUR_PARTIE_DECIMALE	,
 tabModeles(j).MODE_SAISIE	,
 tabModeles(j).AFFICHE_CHOIX_VIDE_SELECT	,
 tabModeles(j).VALEURS_OUI_NON	,
 tabModeles(j).REGLES_AFFICHAGE	,
 tabModeles(j).PENTREE	,
 tabModeles(j).PENTREE_FORCABLE	,
 tabModeles(j).PENTREE_CODE_MODIF	,
 tabModeles(j).NOMTABLE	 );
 END LOOP;
 END IF ;
 return p_retour;
 end GET_CLI_MODELE_DONNEES;
 