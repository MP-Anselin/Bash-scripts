##
TRG_DIC_IDX_CONTRAT_HISTO
=SQL=
create or replace TRIGGER TRG_DIC_IDX_CONTRAT_HISTO BEFORE INSERT OR DELETE ON DIC_IDX_CONTRAT_HISTO FOR EACH ROW
BEGIN
  IF INSERTING THEN
    IF :NEW.NOM_DONNEE IN ('+','*') THEN
      -- Insertion d'un contrat : on crée une ligne dans DIC_IDX_CONTRAT_HISTO_COMP
      MERGE INTO DIC_IDX_CONTRAT_HISTO_COMP USING (SELECT 1 FROM DUAL) ON (NUMPAC=:NEW.NUMPAC AND PACMAT=:NEW.PACMAT AND NUMCNT=:NEW.NUMCNT AND DATE_EFF=:NEW.DATE_EFF AND NOM_DONNEE=:NEW.NOM_DONNEE) WHEN NOT MATCHED THEN INSERT (NUMPAC, PACMAT, NUMCNT, DATE_EFF, NOM_DONNEE, DATE_DERNIERE_MODIF) VALUES (:NEW.NUMPAC, :NEW.PACMAT, :NEW.NUMCNT, :NEW.DATE_EFF, :NEW.NOM_DONNEE, SYSDATE);
    ELSE
      -- Insertion d'une rupture sur une donnée : on supprime la ligne correspondante de DIC_IDX_CONTRAT_HISTO_COMP
      DELETE FROM DIC_IDX_CONTRAT_HISTO_COMP WHERE NUMPAC=:NEW.NUMPAC AND PACMAT=:NEW.PACMAT AND NUMCNT=:NEW.NUMCNT AND DATE_EFF=:NEW.DATE_EFF AND NOM_DONNEE=:NEW.NOM_DONNEE;
    END IF;
  ELSIF DELETING AND NOT NVL(:OLD.RUPTURE_CONTRAT,'N')='O' THEN
    -- Suppression d'une rupture : on crée une ligne dans DIC_IDX_CONTRAT_HISTO_COMP
    MERGE INTO DIC_IDX_CONTRAT_HISTO_COMP USING (SELECT 1 FROM DUAL) ON (NUMPAC=:OLD.NUMPAC AND PACMAT=:OLD.PACMAT AND NUMCNT=:OLD.NUMCNT AND DATE_EFF=:OLD.DATE_EFF AND NOM_DONNEE=:OLD.NOM_DONNEE) WHEN NOT MATCHED THEN INSERT (NUMPAC, PACMAT, NUMCNT, DATE_EFF, NOM_DONNEE, DATE_DERNIERE_MODIF) VALUES (:OLD.NUMPAC, :OLD.PACMAT, :OLD.NUMCNT, :OLD.DATE_EFF, :OLD.NOM_DONNEE, SYSDATE);
  END IF;
END TRG_DIC_IDX_CONTRAT_HISTO;
