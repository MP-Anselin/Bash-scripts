##
CAD
=SQL=
CREATE OR REPLACE
PACKAGE CAD
AS
 FUNCTION CAD_RESOLUTION_POP_REGLES_MAJ(
 p_dteffet VARCHAR2)
 RETURN CAD_TYPE_POP_REGLES_MAJ;
 PROCEDURE CAD_CALCUL(
 matric  IN VARCHAR2 ,
 idrub   IN NUMBER ,
 DATEDEB IN VARCHAR2 ,
 DATEFIN IN VARCHAR2 );
 PROCEDURE CAD_CONTROLE_SOLDE(
 idrub  IN VARCHAR2,
 matric IN VARCHAR2 );
 PROCEDURE CAD_MAJ_VALEUR_LISTE_RUBJOUR(
 idMat         IN NUMBER,
 dtdeb         IN VARCHAR2,
 dtfin         IN VARCHAR2,
 forcage       IN VARCHAR2,
 ispreviousCAD IN VARCHAR2);
 PROCEDURE CAD_IMPORT(
 p_numseq        IN  NUMBER,
 nom_Fichier   IN VARCHAR2,
 avec_Rollback IN VARCHAR2);
 PROCEDURE CAD_ROLLBACK_IMPORT(
 numseq IN NUMBER);
 FUNCTION CAD_INTERRO_THEME(
 MATRIC       IN VARCHAR2 ,
 p_CODE_THEME IN VARCHAR2 ,
 p_DJOUR      IN VARCHAR2,
 collectif    IN VARCHAR2,
 finPeriode   IN NUMBER DEFAULT NULL)
 RETURN CAD_RESULTAT_THEME;
 FUNCTION CAD_INTERRO_THEME_COLL(
 idPop      IN NUMBER ,
 CODE_THEME IN VARCHAR2 ,
 DJOUR      IN VARCHAR2,
 collectif  IN VARCHAR2)
 RETURN CAD_RESULTAT_THEME;
 FUNCTION CAD_SOLDE(
 MATRIC   IN VARCHAR2 ,
 DATEJOUR IN VARCHAR2 ,
 RUB      IN VARCHAR2 )
 RETURN NUMBER;
 FUNCTION CAD_CALCUL_DATE_RELATIVE_AV(
 DATE_RELATIVE     IN VARCHAR2,
 DATE_COMPARAISON  IN VARCHAR2,
 DATE_VALIDITE_REL IN VARCHAR2 )
 RETURN VARCHAR2;
 FUNCTION CAD_CALCUL_DATE_REL_AV_FIN(
 DATE_ACQ_FIN   IN VARCHAR2,
 DATE_ACQ_DEBUT IN VARCHAR2,
 DATE_COMPARE   IN VARCHAR2,
 DATE_VAL_DEBUT IN VARCHAR2)
 RETURN VARCHAR2;
 FUNCTION cad_formate_date_relative(
 DATE_RELATIVE    IN VARCHAR2,
 DATE_COMPARAISON IN VARCHAR2 )
 RETURN VARCHAR2;
 FUNCTION CAD_CALCUL_DATE_RELATIVE_FIN(
 DATE_RELATIVE_FIN   IN VARCHAR2,
 DATE_RELATIVE_DEBUT IN VARCHAR2,
 DATE_COMPARE        IN VARCHAR2 )
 RETURN VARCHAR2;
 FUNCTION cad_calcul_date_relative(
 DATE_RELATIVE    IN VARCHAR2,
 DATE_COMPARAISON IN VARCHAR2 )
 RETURN VARCHAR2;
 PROCEDURE CAD_BASCULE_UNIQUE(
 IDMATRIC    IN NUMBER ,
 BASCULE     IN VARCHAR2 ,
 DATEBAS     IN VARCHAR2 ,
 SUPPRESSION IN VARCHAR2);
 FUNCTION CAD_UNITE_CPT(
    MATRIC   IN VARCHAR2,
    DATEJOUR IN VARCHAR2,
    CPT      IN VARCHAR2)
    RETURN VARCHAR;
END CAD;
##
CAD
=SQL=
create or replace PACKAGE BODY CAD AS
 err_msg  VARCHAR(200);
 err_code VARCHAR(200);
 valdebug VARCHAR2(1); 
 
 FUNCTION CAD_RESOLUTION_POP_REGLES_MAJ(
 p_dteffet VARCHAR2)
 RETURN CAD_TYPE_POP_REGLES_MAJ
 AS
 retour CAD_TYPE_POP_REGLES_MAJ:=CAD_TYPE_POP_REGLES_MAJ();
 CURSOR cur
 IS
 SELECT POPULATION,
 CODE_BASCULE,
 DATE_THEO_BASCULE,
 ORDRE_A_PROPAGER
 FROM CAD_PARAM_POP_REGLES_MAJ;
 lig cur%rowtype;
 numlig  NUMBER:=0;
 DIC     VARCHAR2(8);
 NBJC    NUMBER;
 NBC     NUMBER;
 nbjours NUMBER;
 dteffet VARCHAR2(8);
 BEGIN
 IF p_dteffet IS NULL THEN
 dteffet    :=TO_CHAR(sysdate,'yyyymmdd');
 ELSE
 dteffet:=p_dteffet;
 END IF;
 OPEN cur;
 LOOP
 FETCH cur INTO lig;
 EXIT
 WHEN cur%NOTFOUND ;
 IF instr(lig.DATE_THEO_BASCULE,'DIC')>0 THEN
 DIC                               :=SUBSTR(lig.DATE_THEO_BASCULE,5,8);
 lig.DATE_THEO_BASCULE             :=REPLACE(lig.DATE_THEO_BASCULE, 'DIC='||DIC||' ','');
 NBJC                              :=to_number(SUBSTR(lig.DATE_THEO_BASCULE,6,instr(lig.DATE_THEO_BASCULE,'NBC=')-6));
 lig.DATE_THEO_BASCULE             :=REPLACE(lig.DATE_THEO_BASCULE, 'NBJC='||NBJC||' ','');
 NBC                               :=to_number(SUBSTR(lig.DATE_THEO_BASCULE,5));
 nbjours                           :=ABS(to_date(dteffet,'yyyyMMdd')-to_date(DIC,'yyyyMMdd'));
 IF (DIC                           >=dteffet) THEN
 numlig                          :=numlig+1;
 retour.extend;
 retour(numlig)                  :=CAD_LIG_TYPE_POP_REGLES_MAJ(NULL,NULL,NULL,NULL);
 retour(numlig).POPULATION       :=lig.population;
 retour(numlig).CODE_BASCULE     :=lig.CODE_BASCULE;
 retour(numlig).DATE_THEO_BASCULE:=TO_CHAR(to_date(DIC,'yyyyMMdd'),'yyyymmdd');
 retour(numlig).ORDRE_A_PROPAGER :=lig.ORDRE_A_PROPAGER;
 END IF;
 FOR i IN 1..nbc
 LOOP
 numlig:=numlig+1;
 retour.extend;
 retour(numlig)                  :=CAD_LIG_TYPE_POP_REGLES_MAJ(NULL,NULL,NULL,NULL);
 retour(numlig).POPULATION       :=lig.population;
 retour(numlig).CODE_BASCULE     :=lig.CODE_BASCULE;
 retour(numlig).DATE_THEO_BASCULE:=TO_CHAR(to_date(DIC,'yyyyMMdd')+(TRUNC (nbjours/nbjc,0)+i)*nbjc,'yyyymmdd');
 retour(numlig).ORDRE_A_PROPAGER :=lig.ORDRE_A_PROPAGER;
 END LOOP;
 ELSE
 numlig:=numlig+1;
 retour.extend;
 retour(numlig)                  :=CAD_LIG_TYPE_POP_REGLES_MAJ(NULL,NULL,NULL,NULL);
 retour(numlig).POPULATION       :=lig.population;
 retour(numlig).CODE_BASCULE     :=lig.CODE_BASCULE;
 retour(numlig).DATE_THEO_BASCULE:=cad_formate_date_relative(lig.DATE_THEO_BASCULE, p_dteffet );
 retour(numlig).ORDRE_A_PROPAGER :=lig.ORDRE_A_PROPAGER;
 END IF;
 END LOOP;
 CLOSE cur;
 RETURN retour;
 END;
 PROCEDURE CAD_AVANCEMENT(
 id  IN NUMBER,
 txt IN VARCHAR2)
 AS
 PRAGMA AUTONOMOUS_TRANSACTION;
 line   VARCHAR(32672);
 status INT;
 BEGIN
 IF valdebug='O' THEN
 INSERT INTO CAD_AVANCEMENT_proc VALUES
 (id,sysdate,txt
 );
 COMMIT;
 END IF;
 END CAD_AVANCEMENT;
 PROCEDURE CAD_AVANCEMENT_INFO
 (
 id  IN NUMBER,
 txt IN VARCHAR2
 )
 AS
 PRAGMA AUTONOMOUS_TRANSACTION;
 line   VARCHAR(32672);
 status INT;
 BEGIN
 IF valdebug='O' OR valdebug='I' THEN
 INSERT INTO CAD_AVANCEMENT_proc VALUES
 (id,sysdate,txt
 );
 COMMIT;
 END IF;
 END CAD_AVANCEMENT_INFO;
 PROCEDURE   CAD_ERREUR(
 p_id      IN NUMBER,
 p_nomproc IN VARCHAR2,
 p_idDate  IN VARCHAR2,
 p_erreur  IN VARCHAR2)
 AS
 PRAGMA AUTONOMOUS_TRANSACTION;
 line      VARCHAR(32672);
 status    INT;
 BEGIN
 INSERT INTO CAD_CALCUL_ERR (ID, PROC, PARAM, MESSAGE, DATE_ERR)
 VALUES(p_id, p_nomproc, p_idDate, p_erreur, SYSDATE);
 COMMIT;
 END CAD_ERREUR;
 PROCEDURE CAD_DEBUG
 (
 IDPOP        IN NUMBER ,
 paramREQUETE IN CLOB
 )
 AS
 ordreR NUMBER;
 BEGIN
 IF valdebug='O' THEN
 SELECT NVL(MAX(ordre),0)+1 INTO ordreR FROM cad_trace_req WHERE id=idpop;
 INSERT
 INTO cad_trace_req
 (
 id,
 date_req,
 ordre,
 requete
 )
 VALUES
 (
 idpop,
 sysdate,
 ordreR ,
 paramREQUETE
 );
 END IF;
 END CAD_DEBUG;
 FUNCTION CAD_CALCUL_JOUR_SEMAINE
 (
 JourSemaine VARCHAR2,
 numSemaine  VARCHAR2,
 annee       VARCHAR2,
 mois        VARCHAR2
 )
 RETURN VARCHAR2
 AS
 jour VARCHAR2
 (
 2
 )
 ;
 BEGIN
 IF JourSemaine   ='L' THEN
 jour          :=TO_CHAR( next_day(to_date(annee||mois||'01','yyyymmdd' ), TO_CHAR(to_date('20121001','yyyymmdd'),'DAY')) + (to_number( numSemaine)-1 )*7 ,'dd') ;
 elsif JourSemaine='M' THEN
 jour          :=TO_CHAR(next_day(to_date(annee||mois||'01','yyyymmdd' ), TO_CHAR(to_date('20121002','yyyymmdd'),'DAY') ) + (to_number( numSemaine)-1 )*7 ,'dd') ;
 elsif JourSemaine='W' THEN
 jour          :=TO_CHAR(next_day(to_date(annee||mois||'01','yyyymmdd' ), TO_CHAR(to_date('20121003','yyyymmdd'),'DAY') )+ (to_number( numSemaine)-1 )*7 ,'dd') ;
 elsif JourSemaine='J' THEN
 jour          :=TO_CHAR(next_day(to_date(annee||mois||'01','yyyymmdd' ), TO_CHAR(to_date('20121004','yyyymmdd'),'DAY') ) + (to_number( numSemaine)-1 )*7 ,'dd') ;
 elsif JourSemaine='V' THEN
 jour          :=TO_CHAR( next_day(to_date(annee||mois||'01','yyyymmdd' ), TO_CHAR(to_date('20121005','yyyymmdd'),'DAY') )+ (to_number( numSemaine)-1 )*7 ,'dd') ;
 elsif JourSemaine='S' THEN
 jour          :=TO_CHAR(next_day(to_date(annee||mois||'01','yyyymmdd' ), TO_CHAR(to_date('20121006','yyyymmdd'),'DAY') ) + (to_number( numSemaine)-1 )*7 ,'dd') ;
 elsif JourSemaine='D' THEN
 jour          :=TO_CHAR(next_day(to_date(annee||mois||'01','yyyymmdd' ), TO_CHAR(to_date('20121001','yyyymmdd'),'DAY') ) + (to_number( numSemaine)-1 )*7 ,'dd') ;
 END IF;
 RETURN jour;
 END CAD_CALCUL_JOUR_SEMAINE;
 FUNCTION CAD_CONDITION_NON_AFF
 (
 DATEJOUR   IN VARCHAR2 ,
 typeCalcul IN VARCHAR2 ,
 condition  IN VARCHAR2 ,
 valeur     IN VARCHAR2
 )
 RETURN NUMBER
 AS
 retour NUMBER;
 BEGIN
 retour      :=0;
 IF condition ='NEG' THEN
 IF valeur IS NULL OR (typeCalcul IN ('R','VP','P','COL','C') AND to_number(valeur)<0) THEN
 retour  :=1;
 END IF;
 elsif condition='ZER' THEN
 IF valeur   IS NULL OR (typeCalcul IN ('R','VP','P','COL','C') AND to_number(valeur)=0) THEN
 retour    :=1;
 END IF;
 elsif condition='IEQ' THEN
 IF valeur   IS NULL OR (typeCalcul IN ('R','VP','P','COL','C') AND to_number(valeur)<=0) THEN
 retour    :=1;
 END IF;
 elsif condition='IEQD' THEN
 IF valeur   IS NULL OR valeur<=DATEJOUR THEN
 retour    :=1;
 END IF;
 elsif condition='SEQ' THEN
 IF valeur   IS NULL OR (typeCalcul IN ('R','VP','P','COL','C') AND to_number(valeur)>=0) THEN
 retour    :=1;
 END IF;
 elsif condition='SEQD' THEN
 IF valeur   IS NULL OR valeur>=DATEJOUR THEN
 retour    :=1;
 END IF;
 elsif condition='INF' THEN
 IF valeur   IS NULL OR valeur<DATEJOUR THEN
 retour    :=1;
 END IF;
 elsif condition='SUP' THEN
 IF valeur   IS NULL OR valeur>DATEJOUR THEN
 retour    :=1;
 END IF;
 END IF;
 RETURN retour;
 END CAD_CONDITION_NON_AFF;
 FUNCTION CAD_UNITE
 (
 MATRIC   IN VARCHAR2 ,
 DATEJOUR IN VARCHAR2 ,
 RUB      IN VARCHAR2
 )
 RETURN VARCHAR
 AS
 r_unite VARCHAR
 (
 1
 )
 ;
 BEGIN
 BEGIN
 SELECT unite_tenue
 INTO r_unite
 FROM
 (SELECT unite_tenue
 FROM cad_matric_datevalid a,
 CAD_PARAM_LIEN_RUB_CPT b
 WHERE a.matricule  =matric
 AND a.code_compteur=b.code_compteur
 AND a.DATE_EFFET   =
 (SELECT MAX(date_effet)
 FROM cad_matric_datevalid c
 WHERE c.date_effet<=datejour
 AND c.code_compteur=a.code_compteur
 AND a.matricule    =c.matricule
 )
 AND b.rub_val_jour=rub
 ORDER BY date_effet DESC
 )
 WHERE rownum=1 ;
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 BEGIN
 SELECT unite
 INTO r_unite
 FROM
 (SELECT a.unite
 FROM CAD_PARAM_STRUCT_CPT a,
 CAD_PARAM_LIEN_RUB_CPT b
 WHERE a.code_compteur=b.code_compteur
 AND b.rub_val_jour   =rub
 ORDER BY a.code_compteur DESC
 )
 WHERE rownum=1 ;
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 ROLLBACK;
 raise_application_error(-20000, 'CAD00056#'||matric||'#'||datejour||'#'||rub);
 END;
 END;
 IF r_unite IS NULL THEN
 ROLLBACK;
 raise_application_error(-20000, 'CAD00056#'||matric||'#'||datejour||'#'||rub);
 END IF;
 RETURN r_unite;
 END CAD_UNITE;
 FUNCTION CAD_UNITE_CPT(
 MATRIC   IN VARCHAR2 ,
 DATEJOUR IN VARCHAR2 ,
 CPT      IN VARCHAR2 )
 RETURN VARCHAR
 AS
 r_unite   VARCHAR(1);
 gestionHj VARCHAR(1);
 visuHouJ  VARCHAR(1);
 BEGIN
 SELECT GESTIONHJ
 INTO GESTIONHJ
 FROM CAD_PARAM_STRUCT_CPT
 WHERE code_compteur=CPT;
 IF GESTIONHJ       ='H' THEN
 r_unite         :='H';
 ELSE
 BEGIN
 SELECT
 CASE
 WHEN visuhouj='H'
 THEN 'H'
 ELSE unite_tenue
 END
 INTO r_unite
 FROM cad_matric_datevalid a
 WHERE a.matricule=matric
 AND a.DATE_EFFET =
 (SELECT MAX(date_effet)
 FROM cad_matric_datevalid b
 WHERE b.date_effet<=datejour
 AND a.code_compteur=b.code_compteur
 AND a.matricule    =b.matricule
 )
 AND a.code_compteur=cpt
 AND rownum         =1
 ORDER BY date_effet DESC ;
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 IF r_unite IS NULL THEN
 SELECT a.unite
 INTO r_unite
 FROM CAD_PARAM_STRUCT_CPT a
 WHERE a.code_compteur=cpt
 AND rownum           =1
 ORDER BY a.code_compteur DESC ;
 END IF;
 END;
 END IF;
 RETURN r_unite;
 END CAD_UNITE_CPT;
 PROCEDURE CAD_INIT_BASCULES(
 numSeq  IN NUMBER ,
 matric  IN VARCHAR2,
 DATEDEB IN VARCHAR2 ,
 DATEFIN IN VARCHAR2 )
 AS
 CURSOR cur_test
 IS
 SELECT a.matricule AS MATRICULE,
 a.COMPTEUR_DEST,
 a.DATE_THEO_BASCULE,
 a.TYPE_BASCULE,
 b.matricule AS matric_cpt,
 b.djour,
 b.code_compteur,
 b.typemj,
 b.rowid_cpt,
 b.NorM
 FROM
 (SELECT DISTINCT mat.matricule AS MATRICULE,
 maj.COMPTEUR_DEST,
 bas.DATE_THEO_BASCULE,
 bas.TYPE_BASCULE
 FROM CAD_CALCUL_EN_COURS_MATRIC mat,
 CAD_REGLES_PREVUES_REALISEES bas,
 cad_param_regles_maj maj
 WHERE mat.id         = numSeq
 AND mat.matricule    =NVL(matric,mat.matricule)
 AND bas.matricule    =mat.matricule
 AND maj.code_bascule = bas.code_bascule
 AND DATE_THEO_BASCULE BETWEEN DATEDEB AND NVL(DATEfin,'20991231')
 ) a
 FULL OUTER JOIN
 (SELECT cpt.matricule,
 cpt.djour,
 cpt.code_compteur,
 cpt.rowid AS rowid_cpt,
 cpt.typemj,
 (SELECT COUNT(*)
 FROM CAD_COMPTEUR cpt2
 WHERE cpt.matricule  =cpt2.matricule
 AND cpt.code_compteur=cpt2.code_compteur
 AND cpt.djour        =cpt2.djour
 AND cpt2.typemj     IN ('M','N')
 ) AS NorM
 FROM CAD_COMPTEUR cpt,CAD_CALCUL_EN_COURS_MATRIC
 WHERE cpt.TYPEMJ  IN ('B','S')
 AND cpt.matricule= CAD_CALCUL_EN_COURS_MATRIC.matricule and CAD_CALCUL_EN_COURS_MATRIC.id = numSeq
 AND cpt.matricule=NVL(matric,cpt.matricule)
 AND djour BETWEEN DATEDEB AND NVL(DATEfin,'20991231')
 ) b
 ON a.matricule          =b.matricule
 AND a.date_theo_bascule =b.djour
 AND b.code_compteur     =a.compteur_dest
 AND a.type_bascule      =b.typemj
 WHERE djour            IS NULL
 OR djour BETWEEN DATEDEB AND NVL(DATEfin,'20991231');
 lig_test cur_test%rowtype;
 TYPE Tab_Rowid
 IS
 TABLE OF VARCHAR(100);
 --tableau pour update
 T_up Tab_Rowid;
 --tableau pour insert
 -- tableau pour delete
 T_del Tab_Rowid;
 T_replace Tab_Rowid;
 TYPE Type_bascules
 IS
 RECORD
 (
 matricule cad_compteur.matricule%type,
 code_compteur cad_compteur.code_compteur%type,
 djour cad_compteur.djour%type,
 typemj cad_compteur.typemj%type,
 date_maj cad_compteur.date_maj%type );
 type tab_bascules
 IS
 TABLE OF type_bascules;
 t_ins tab_bascules;
 tmpIns type_bascules;
 BEGIN
 OPEN cur_test;
 LOOP
 FETCH cur_test INTO lig_test;
 EXIT
 WHEN cur_test%NOTFOUND ;
 -- si on a la bascule dans prévue/réalisée, on met la ligne à 0 sinon on delete
 IF lig_test.matricule IS NOT NULL AND lig_test.rowid_cpt IS NULL THEN
 -- insertion
 IF t_ins              IS NULL THEN
 tmpIns.matricule    :=lig_test.matricule;
 tmpIns.code_compteur:=lig_test.compteur_dest;
 tmpIns.djour        :=lig_test.DATE_THEO_BASCULE;
 tmpIns.typemj       :=lig_test.type_bascule;
 tmpIns.date_maj     :=sysdate;
 t_ins               :=tab_bascules(tmpIns);
 ELSE
 t_ins.extend();
 t_ins(t_ins.last).matricule    :=lig_test.matricule;
 t_ins(t_ins.last).code_compteur:=lig_test.compteur_dest;
 t_ins(t_ins.last).djour        :=lig_test.DATE_THEO_BASCULE;
 t_ins(t_ins.last).typemj       :=lig_test.type_bascule;
 t_ins(t_ins.last).date_maj     :=sysdate;
 END IF;
 elsif lig_test.matricule IS NULL AND lig_test.rowid_cpt IS NOT NULL THEN
 IF lig_test.NorM        >0 THEN
 IF t_del             IS NULL THEN
 t_del              :=Tab_Rowid(lig_test.rowid_cpt);
 ELSE
 t_del.extend();
 t_del(t_del.last):=lig_test.rowid_cpt;
 END IF;
 ELSE
 IF T_replace IS NULL THEN
 T_replace  :=Tab_Rowid(lig_test.rowid_cpt);
 ELSE
 T_replace.extend();
 T_replace(T_replace.last):=lig_test.rowid_cpt;
 END IF;
 END IF;
 -- delete
 -- delete from cad_compteur where rowid=lig_test.rowid_cpt;
 ELSE
 IF t_up IS NULL THEN
 t_up  :=Tab_Rowid(lig_test.rowid_cpt);
 ELSE
 t_up.extend();
 t_up(t_up.last):=lig_test.rowid_cpt;
 END IF;
 --update
 /* update cad_compteur set POT1_VALEURJ=null,POT1_VALEURH=null,
 POT2_VALEURJ=null,POT2_VALEURH=null,
 POT3_VALEURJ=null,POT3_VALEURH=null,
 POT4_VALEURJ=null,POT4_VALEURH=null,
 POT5_VALEURJ=null,POT5_VALEURH=null,
 POT6_VALEURJ=null,POT6_VALEURH=null,
 POT7_VALEURJ=null,POT7_VALEURH=null,
 POT8_VALEURJ=null,POT8_VALEURH=null,
 POT9_VALEURJ=null,POT9_VALEURH=null,
 POT10_VALEURJ=null,POT10_VALEURH=null,
 POT11_VALEURJ=null,POT11_VALEURH=null,
 POT12_VALEURJ=null,POT12_VALEURH=null
 where rowid=lig_test.rowid_cpt;*/
 END IF;
 END LOOP;
 CLOSE cur_test;
 IF t_up IS NOT NULL THEN
 FORALL i IN T_up.first..T_up.last
 UPDATE cad_compteur
 SET DATE_MAJ    =sysdate,
 POT1_VALEURJ  =NULL,
 POT1_VALEURH  =NULL,
 POT2_VALEURJ  =NULL,
 POT2_VALEURH  =NULL,
 POT3_VALEURJ  =NULL,
 POT3_VALEURH  =NULL,
 POT4_VALEURJ  =NULL,
 POT4_VALEURH  =NULL,
 POT5_VALEURJ  =NULL,
 POT5_VALEURH  =NULL,
 POT6_VALEURJ  =NULL,
 POT6_VALEURH  =NULL,
 POT7_VALEURJ  =NULL,
 POT7_VALEURH  =NULL,
 POT8_VALEURJ  =NULL,
 POT8_VALEURH  =NULL,
 POT9_VALEURJ  =NULL,
 POT9_VALEURH  =NULL,
 POT10_VALEURJ =NULL,
 POT10_VALEURH =NULL,
 POT11_VALEURJ =NULL,
 POT11_VALEURH =NULL,
 POT12_VALEURJ =NULL,
 POT12_VALEURH =NULL
 WHERE rowid     =t_up(i);
 END IF;
 IF T_replace IS NOT NULL THEN
 FORALL i IN T_replace.first..T_replace.last
 UPDATE cad_compteur a
 SET DATE_MAJ    =sysdate,
 typemj        ='N',
 POT1_VALEURJ  =NULL,
 POT1_VALEURH  =NULL,
 POT2_VALEURJ  =NULL,
 POT2_VALEURH  =NULL,
 POT3_VALEURJ  =NULL,
 POT3_VALEURH  =NULL,
 POT4_VALEURJ  =NULL,
 POT4_VALEURH  =NULL,
 POT5_VALEURJ  =NULL,
 POT5_VALEURH  =NULL,
 POT6_VALEURJ  =NULL,
 POT6_VALEURH  =NULL,
 POT7_VALEURJ  =NULL,
 POT7_VALEURH  =NULL,
 POT8_VALEURJ  =NULL,
 POT8_VALEURH  =NULL,
 POT9_VALEURJ  =NULL,
 POT9_VALEURH  =NULL,
 POT10_VALEURJ =NULL,
 POT10_VALEURH =NULL,
 POT11_VALEURJ =NULL,
 POT11_VALEURH =NULL,
 POT12_VALEURJ =NULL,
 POT12_VALEURH =NULL
 WHERE rowid     =T_replace(i);
 END IF;
 IF T_del IS NOT NULL THEN
 FORALL i IN T_del.first..T_del.last
 UPDATE cad_compteur a
 SET DATE_MAJ                               =sysdate
 WHERE (a.matricule,a.code_compteur,a.djour)=
 (SELECT b.matricule,
 b.code_compteur,
 b.djour
 FROM cad_compteur b
 WHERE rowid =T_del(i)
 )
 AND typemj IN ('N','M') ;
 FORALL i   IN T_del.first..T_del.last
 DELETE FROM cad_compteur WHERE rowid =T_del(i);
 END IF;
 IF t_ins IS NOT NULL THEN
 FORALL i IN t_ins.first..t_ins.last
 INSERT
 INTO CAD_COMPTEUR
 (
 matricule,
 code_compteur,
 djour,
 typemj,
 date_maj
 )
 VALUES
 (
 t_ins(i).matricule,
 t_ins(i).code_compteur,
 t_ins(i).djour,
 t_ins(i).typemj,
 t_ins(i).date_maj
 );
 END IF;
 END CAD_INIT_BASCULES;
 PROCEDURE CAD_UNIT_PROPAGATION
 (
 IDMATRIC    IN NUMBER ,
 p_matric    IN VARCHAR2,
 DATEDEB     IN VARCHAR2 ,
 DATEFIN     IN VARCHAR2 ,
 CODECPT     IN VARCHAR2 ,
 AvecBascule IN VARCHAR2
 )
 AS
 CURSOR cur_cpt
 IS
 SELECT cpt.*,
 cpt.rowid
 FROM CAD_COMPTEUR cpt,
 CAD_CALCUL_EN_COURS_MATRIC mat
 WHERE cpt.matricule   =mat.matricule
 AND mat.id            =idmatric
 AND mat.matricule     =NVL(p_matric,mat.matricule)
 AND cpt.code_compteur =codecpt
 AND cpt.djour        >=nvl(datedeb,'19000101')
 AND (cpt.djour       <=NVL(datefin,'20991231')
 OR (avecbascule       ='BASCULE'
 AND cpt.djour        <=NVL(
 (SELECT MIN(a.djour)
 FROM cad_compteur a
 WHERE a.matricule  =cpt.matricule
 AND a.code_compteur=cpt.code_compteur
 AND a.typemj NOT  IN ('B','S')
 AND a.djour        >datefin
 ),'20991231')))
 ORDER BY cpt.matricule,
 cpt.code_compteur,
 cpt.djour,
 cpt.typemj FOR UPDATE OF POT1_VALEURJ,
 POT1_VALEURH,
 POT2_VALEURJ,
 POT2_VALEURH,
 POT3_VALEURJ,
 POT3_VALEURH,
 POT4_VALEURJ,
 POT4_VALEURH,
 POT5_VALEURJ,
 POT5_VALEURH,
 POT6_VALEURJ,
 POT6_VALEURH,
 POT7_VALEURJ,
 POT7_VALEURH,
 POT8_VALEURJ,
 POT8_VALEURH,
 POT9_VALEURJ,
 POT9_VALEURH,
 POT10_VALEURJ,
 POT10_VALEURH,
 POT11_VALEURJ,
 POT11_VALEURH,
 POT12_VALEURJ,
 POT12_VALEURH ;
 lig_cpt cur_cpt%ROWTYPE;
 lig_cpt_prec cur_cpt%ROWTYPE;
 lig_cptori cur_cpt%ROWTYPE;
 TYPE TYP_tabPot is table of varchar2(3000) index by BINARY_INTEGER ;
 TYPE typ_Tab_ligcpt
 IS
 TABLE OF cur_cpt%ROWTYPE;
 Tab_ligcpt typ_Tab_ligcpt:=Typ_Tab_ligcpt();
 TYPE Tab_Rowid
 IS
 TABLE OF VARCHAR(100);
 T_Id Tab_Rowid;
 reqpropagation CLOB;
 ssreq CLOB;
 nbssreq                 NUMBER;
 listPotANePasPropage    VARCHAR(100):='';
 listPotANePasPropageCPT VARCHAR(100):='';
 premier                 BOOLEAN;
 dtprec                  VARCHAR(8):=DATEDEB;
 typprec                 VARCHAR(1):='B';
 listPotAPropage         VARCHAR(100);
 req                     VARCHAR2(1000);
 pos                     NUMBER:=0;
 subs                    VARCHAR2(1000);
 un_index                INT;
 requpdate               VARCHAR2(1000);
 calcul                  VARCHAR2(100);
 lig_param CAD_PARAM_CALCUL%rowtype;
 tabreqcpt TYP_tabPot;
 
 TYPE TYP_tabStruct is table of CAD_PARAM_CALCUL%rowtype index by varchar2(32) ;
 tabstructcpt  TYP_tabStruct;
 TYPE TYP_PotANePasPropageCPT is table of varchar2(1000) index by varchar2(32) ;
 tablistPotANePasPropageCPT TYP_PotANePasPropageCPT;
 TYPE TYP_PotAPropage is table of varchar2(1000) index by varchar2(32) ;
 tablistPotAPropage TYP_PotAPropage;
 
 BEGIN
 
 if not tabstructcpt.exists(codecpt) then
 SELECT *
 INTO tabstructcpt(codecpt)
 FROM CAD_PARAM_CALCUL
 WHERE code_compteur      =codecpt;
 end if;
 lig_param:=tabstructcpt(codecpt);
 
 req                     :=lig_param.REQUETES;
 
 
 listPotANePasPropageCPT :=' ' ;
 if not tablistPotANePasPropageCPT.exists(codecpt) then
 FOR x IN
 (SELECT NUM_POT
 FROM CAD_PARAM_STRUCT_POT
 WHERE code_compteur=codecpt
 AND MAJ_BATCH      ='O'
 )
 LOOP
 if  tablistPotANePasPropageCPT.exists(codecpt) then
 tablistPotANePasPropageCPT(codecpt):=tablistPotANePasPropageCPT(codecpt)||' '||x.NUM_POT||' ';
 else
 tablistPotANePasPropageCPT(codecpt):=' '||x.NUM_POT||' ';
 end if;
 END LOOP;
 end if;
 if  tablistPotANePasPropageCPT.exists(codecpt) then
 listPotANePasPropageCPT:=tablistPotANePasPropageCPT(codecpt);
 end if;
 listPotAPropage:=' ' ;
 if not tablistPotAPropage.exists(codecpt) then
 FOR x IN
 (SELECT NUM_POT
 FROM CAD_PARAM_STRUCT_POT
 WHERE code_compteur     =codecpt
 AND TYPE_VARIATION NOT IN ('S','V')
 )
 LOOP
 if tablistPotAPropage.exists(codecpt) then
 tablistPotAPropage(codecpt):=tablistPotAPropage(codecpt)||' '||x.NUM_POT||' ';
 else
 tablistPotAPropage(codecpt):=' '||x.NUM_POT||' ';
 end if;
 END LOOP;
 end if;
 if tablistPotAPropage.exists(codecpt) then
 listPotAPropage:=tablistPotAPropage(codecpt);
 end if;
 
 
 
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO lig_cpt ;
 EXIT
 WHEN cur_cpt%NOTFOUND ;
 
 
 
 
 lig_cptori:=lig_cpt;
 
 
 --  IF (lig_cpt_prec.matricule IS  NULL) or  lig_cpt_prec.code_compteur<>lig_cpt.code_compteur THEN
 
 
 -- end if;
 
 IF (lig_cpt_prec.matricule IS NOT NULL) AND lig_cpt_prec.matricule=lig_cpt.matricule and lig_cpt_prec.code_compteur=lig_cpt.code_compteur THEN
 -- si bascule, on ne fait pas de propagation
 IF lig_cpt.typemj NOT IN ('B','S') THEN
 IF lig_cpt.typemj      ='M' THEN
 listPotANePasPropage:=listPotANePasPropageCPT;
 ELSE
 listPotANePasPropage:=' ';
 END IF;
 -- Propagation des pots sans variations
 IF listPotAPropage <>' ' THEN
 nbssreq          :=0;
 FOR i IN 1..12
 LOOP
 IF instr(listPotAPropage,' '||i||' ')>0 AND instr(listPotANePasPropage,' '||i||' ')=0 THEN
 IF i                               =1 THEN
 lig_cpt.POT1_VALEURJ            :=NVL(lig_cpt_prec.POT1_FJ,NVL(lig_cpt_prec.POT1_VALEURJ,0));
 lig_cpt.POT1_VALEURH            :=NVL(lig_cpt_prec.POT1_FH,NVL(lig_cpt_prec.POT1_VALEURH,0));
 elsif i                            =2 THEN
 lig_cpt.POT2_VALEURJ            :=NVL(lig_cpt_prec.POT2_FJ,NVL(lig_cpt_prec.POT2_VALEURJ,0));
 lig_cpt.POT2_VALEURH            :=NVL(lig_cpt_prec.POT2_FH,NVL(lig_cpt_prec.POT2_VALEURH,0));
 elsif i                            =3 THEN
 lig_cpt.POT3_VALEURJ            :=NVL(lig_cpt_prec.POT3_FJ,NVL(lig_cpt_prec.POT3_VALEURJ,0));
 lig_cpt.POT3_VALEURH            :=NVL(lig_cpt_prec.POT3_FH,NVL(lig_cpt_prec.POT3_VALEURH,0));
 elsif i                            =4 THEN
 lig_cpt.POT4_VALEURJ            :=NVL(lig_cpt_prec.POT4_FJ,NVL(lig_cpt_prec.POT4_VALEURJ,0));
 lig_cpt.POT4_VALEURH            :=NVL(lig_cpt_prec.POT4_FH,NVL(lig_cpt_prec.POT4_VALEURH,0));
 elsif i                            =5 THEN
 lig_cpt.POT5_VALEURJ            :=NVL(lig_cpt_prec.POT5_FJ,NVL(lig_cpt_prec.POT5_VALEURJ,0));
 lig_cpt.POT5_VALEURH            :=NVL(lig_cpt_prec.POT5_FH,NVL(lig_cpt_prec.POT5_VALEURH,0));
 elsif i                            =6 THEN
 lig_cpt.POT6_VALEURJ            :=NVL(lig_cpt_prec.POT6_FJ,NVL(lig_cpt_prec.POT6_VALEURJ,0));
 lig_cpt.POT6_VALEURH            :=NVL(lig_cpt_prec.POT6_FH,NVL(lig_cpt_prec.POT6_VALEURH,0));
 elsif i                            =7 THEN
 lig_cpt.POT7_VALEURJ            :=NVL(lig_cpt_prec.POT7_FJ,NVL(lig_cpt_prec.POT7_VALEURJ,0));
 lig_cpt.POT7_VALEURH            :=NVL(lig_cpt_prec.POT7_FH,NVL(lig_cpt_prec.POT7_VALEURH,0));
 elsif i                            =8 THEN
 lig_cpt.POT8_VALEURJ            :=NVL(lig_cpt_prec.POT8_FJ,NVL(lig_cpt_prec.POT8_VALEURJ,0));
 lig_cpt.POT8_VALEURH            :=NVL(lig_cpt_prec.POT8_FH,NVL(lig_cpt_prec.POT8_VALEURH,0));
 elsif i                            =9 THEN
 lig_cpt.POT9_VALEURJ            :=NVL(lig_cpt_prec.POT9_FJ,NVL(lig_cpt_prec.POT9_VALEURJ,0));
 lig_cpt.POT9_VALEURH            :=NVL(lig_cpt_prec.POT9_FH,NVL(lig_cpt_prec.POT9_VALEURH,0));
 elsif i                            =10 THEN
 lig_cpt.POT10_VALEURJ           :=NVL(lig_cpt_prec.POT10_FJ,NVL(lig_cpt_prec.POT10_VALEURJ,0));
 lig_cpt.POT10_VALEURH           :=NVL(lig_cpt_prec.POT10_FH,NVL(lig_cpt_prec.POT10_VALEURH,0));
 elsif i                            =11 THEN
 lig_cpt.POT11_VALEURJ           :=NVL(lig_cpt_prec.POT11_FJ,NVL(lig_cpt_prec.POT11_VALEURJ,0));
 lig_cpt.POT11_VALEURH           :=NVL(lig_cpt_prec.POT11_FH,NVL(lig_cpt_prec.POT11_VALEURH,0));
 elsif i                            =12 THEN
 lig_cpt.POT12_VALEURJ           :=NVL(lig_cpt_prec.POT12_FJ,NVL(lig_cpt_prec.POT12_VALEURJ,0));
 lig_cpt.POT12_VALEURH           :=NVL(lig_cpt_prec.POT12_FH,NVL(lig_cpt_prec.POT12_VALEURH,0));
 END IF;
 END IF;
 END LOOP;
 END IF;
 -- Propagation des variations
 nbssreq                  :=0;
 IF lig_param.POTV1       IS NOT NULL AND instr(listPotANePasPropage,' '||lig_param.POTV1||' ')=0 THEN
 IF lig_param.POTV1      =1 THEN
 lig_cpt.POT1_VALEURJ :=NVL(lig_cpt_prec.POT1_FJ,NVL(lig_cpt_prec.POT1_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT1_VALEURH :=NVL(lig_cpt_prec.POT1_FH,NVL(lig_cpt_prec.POT1_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =2 THEN
 lig_cpt.POT2_VALEURJ :=NVL(lig_cpt_prec.POT2_FJ,NVL(lig_cpt_prec.POT2_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT2_VALEURH :=NVL(lig_cpt_prec.POT2_FH,NVL(lig_cpt_prec.POT2_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =3 THEN
 lig_cpt.POT3_VALEURJ :=NVL(lig_cpt_prec.POT3_FJ,NVL(lig_cpt_prec.POT3_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT3_VALEURH :=NVL(lig_cpt_prec.POT3_FH,NVL(lig_cpt_prec.POT3_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =4 THEN
 lig_cpt.POT4_VALEURJ :=NVL(lig_cpt_prec.POT4_FJ,NVL(lig_cpt_prec.POT4_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT4_VALEURH :=NVL(lig_cpt_prec.POT4_FH,NVL(lig_cpt_prec.POT4_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =5 THEN
 lig_cpt.POT5_VALEURJ :=NVL(lig_cpt_prec.POT5_FJ,NVL(lig_cpt_prec.POT5_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT5_VALEURH :=NVL(lig_cpt_prec.POT5_FH,NVL(lig_cpt_prec.POT5_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =6 THEN
 lig_cpt.POT6_VALEURJ :=NVL(lig_cpt_prec.POT6_FJ,NVL(lig_cpt_prec.POT6_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT6_VALEURH :=NVL(lig_cpt_prec.POT6_FH,NVL(lig_cpt_prec.POT6_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =7 THEN
 lig_cpt.POT7_VALEURJ :=NVL(lig_cpt_prec.POT7_FJ,NVL(lig_cpt_prec.POT7_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT7_VALEURH :=NVL(lig_cpt_prec.POT7_FH,NVL(lig_cpt_prec.POT7_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =8 THEN
 lig_cpt.POT8_VALEURJ :=NVL(lig_cpt_prec.POT8_FJ,NVL(lig_cpt_prec.POT8_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT8_VALEURH :=NVL(lig_cpt_prec.POT8_FH,NVL(lig_cpt_prec.POT8_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =9 THEN
 lig_cpt.POT9_VALEURJ :=NVL(lig_cpt_prec.POT9_FJ,NVL(lig_cpt_prec.POT9_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT9_VALEURH :=NVL(lig_cpt_prec.POT9_FH,NVL(lig_cpt_prec.POT9_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =10 THEN
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt_prec.POT10_FJ,NVL(lig_cpt_prec.POT10_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt_prec.POT10_FH,NVL(lig_cpt_prec.POT10_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =11 THEN
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt_prec.POT11_FJ,NVL(lig_cpt_prec.POT11_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt_prec.POT11_FH,NVL(lig_cpt_prec.POT11_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 elsif lig_param.POTV1   =12 THEN
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt_prec.POT12_FJ,NVL(lig_cpt_prec.POT12_VALEURJ,0))+NVL(lig_cpt.POTV1_VALEURJ,0);
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt_prec.POT12_FH,NVL(lig_cpt_prec.POT12_VALEURH,0))+NVL(lig_cpt.POTV1_VALEURH,0);
 END IF;
 END IF;
 IF lig_param.POTV2       IS NOT NULL AND instr(listPotANePasPropage,' '||lig_param.POTV2||' ')=0 THEN
 IF lig_param.POTV2      =1 THEN
 lig_cpt.POT1_VALEURJ :=NVL(lig_cpt_prec.POT1_FJ,NVL(lig_cpt_prec.POT1_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT1_VALEURH :=NVL(lig_cpt_prec.POT1_FH,NVL(lig_cpt_prec.POT1_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =2 THEN
 lig_cpt.POT2_VALEURJ :=NVL(lig_cpt_prec.POT2_FJ,NVL(lig_cpt_prec.POT2_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT2_VALEURH :=NVL(lig_cpt_prec.POT2_FH,NVL(lig_cpt_prec.POT2_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =3 THEN
 lig_cpt.POT3_VALEURJ :=NVL(lig_cpt_prec.POT3_FJ,NVL(lig_cpt_prec.POT3_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT3_VALEURH :=NVL(lig_cpt_prec.POT3_FH,NVL(lig_cpt_prec.POT3_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =4 THEN
 lig_cpt.POT4_VALEURJ :=NVL(lig_cpt_prec.POT4_FJ,NVL(lig_cpt_prec.POT4_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT4_VALEURH :=NVL(lig_cpt_prec.POT4_FH,NVL(lig_cpt_prec.POT4_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =5 THEN
 lig_cpt.POT5_VALEURJ :=NVL(lig_cpt_prec.POT5_FJ,NVL(lig_cpt_prec.POT5_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT5_VALEURH :=NVL(lig_cpt_prec.POT5_FH,NVL(lig_cpt_prec.POT5_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =6 THEN
 lig_cpt.POT6_VALEURJ :=NVL(lig_cpt_prec.POT6_FJ,NVL(lig_cpt_prec.POT6_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT6_VALEURH :=NVL(lig_cpt_prec.POT6_FH,NVL(lig_cpt_prec.POT6_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =7 THEN
 lig_cpt.POT7_VALEURJ :=NVL(lig_cpt_prec.POT7_FJ,NVL(lig_cpt_prec.POT7_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT7_VALEURH :=NVL(lig_cpt_prec.POT7_FH,NVL(lig_cpt_prec.POT7_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =8 THEN
 lig_cpt.POT8_VALEURJ :=NVL(lig_cpt_prec.POT8_FJ,NVL(lig_cpt_prec.POT8_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT8_VALEURH :=NVL(lig_cpt_prec.POT8_FH,NVL(lig_cpt_prec.POT8_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =9 THEN
 lig_cpt.POT9_VALEURJ :=NVL(lig_cpt_prec.POT9_FJ,NVL(lig_cpt_prec.POT9_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT9_VALEURH :=NVL(lig_cpt_prec.POT9_FH,NVL(lig_cpt_prec.POT9_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =10 THEN
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt_prec.POT10_FJ,NVL(lig_cpt_prec.POT10_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt_prec.POT10_FH,NVL(lig_cpt_prec.POT10_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =11 THEN
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt_prec.POT11_FJ,NVL(lig_cpt_prec.POT11_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt_prec.POT11_FH,NVL(lig_cpt_prec.POT11_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 elsif lig_param.POTV2   =12 THEN
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt_prec.POT12_FJ,NVL(lig_cpt_prec.POT12_VALEURJ,0))+NVL(lig_cpt.POTV2_VALEURJ,0);
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt_prec.POT12_FH,NVL(lig_cpt_prec.POT12_VALEURH,0))+NVL(lig_cpt.POTV2_VALEURH,0);
 END IF;
 END IF;
 IF lig_param.POTV3       IS NOT NULL AND instr(listPotANePasPropage,' '||lig_param.POTV3||' ')=0 THEN
 IF lig_param.POTV3      =1 THEN
 lig_cpt.POT1_VALEURJ :=NVL(lig_cpt_prec.POT1_FJ,NVL(lig_cpt_prec.POT1_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT1_VALEURH :=NVL(lig_cpt_prec.POT1_FH,NVL(lig_cpt_prec.POT1_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =2 THEN
 lig_cpt.POT2_VALEURJ :=NVL(lig_cpt_prec.POT2_FJ,NVL(lig_cpt_prec.POT2_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT2_VALEURH :=NVL(lig_cpt_prec.POT2_FH,NVL(lig_cpt_prec.POT2_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =3 THEN
 lig_cpt.POT3_VALEURJ :=NVL(lig_cpt_prec.POT3_FJ,NVL(lig_cpt_prec.POT3_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT3_VALEURH :=NVL(lig_cpt_prec.POT3_FH,NVL(lig_cpt_prec.POT3_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =4 THEN
 lig_cpt.POT4_VALEURJ :=NVL(lig_cpt_prec.POT4_FJ,NVL(lig_cpt_prec.POT4_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT4_VALEURH :=NVL(lig_cpt_prec.POT4_FH,NVL(lig_cpt_prec.POT4_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =5 THEN
 lig_cpt.POT5_VALEURJ :=NVL(lig_cpt_prec.POT5_FJ,NVL(lig_cpt_prec.POT5_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT5_VALEURH :=NVL(lig_cpt_prec.POT5_FH,NVL(lig_cpt_prec.POT5_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =6 THEN
 lig_cpt.POT6_VALEURJ :=NVL(lig_cpt_prec.POT6_FJ,NVL(lig_cpt_prec.POT6_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT6_VALEURH :=NVL(lig_cpt_prec.POT6_FH,NVL(lig_cpt_prec.POT6_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =7 THEN
 lig_cpt.POT7_VALEURJ :=NVL(lig_cpt_prec.POT7_FJ,NVL(lig_cpt_prec.POT7_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT7_VALEURH :=NVL(lig_cpt_prec.POT7_FH,NVL(lig_cpt_prec.POT7_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =8 THEN
 lig_cpt.POT8_VALEURJ :=NVL(lig_cpt_prec.POT8_FJ,NVL(lig_cpt_prec.POT8_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT8_VALEURH :=NVL(lig_cpt_prec.POT8_FH,NVL(lig_cpt_prec.POT8_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =9 THEN
 lig_cpt.POT9_VALEURJ :=NVL(lig_cpt_prec.POT9_FJ,NVL(lig_cpt_prec.POT9_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT9_VALEURH :=NVL(lig_cpt_prec.POT9_FH,NVL(lig_cpt_prec.POT9_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =10 THEN
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt_prec.POT10_FJ,NVL(lig_cpt_prec.POT10_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt_prec.POT10_FH,NVL(lig_cpt_prec.POT10_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =11 THEN
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt_prec.POT11_FJ,NVL(lig_cpt_prec.POT11_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt_prec.POT11_FH,NVL(lig_cpt_prec.POT11_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 elsif lig_param.POTV3   =12 THEN
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt_prec.POT12_FJ,NVL(lig_cpt_prec.POT12_VALEURJ,0))+NVL(lig_cpt.POTV3_VALEURJ,0);
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt_prec.POT12_FH,NVL(lig_cpt_prec.POT12_VALEURH,0))+NVL(lig_cpt.POTV3_VALEURH,0);
 END IF;
 END IF;
 IF lig_param.POTV4       IS NOT NULL AND instr(listPotANePasPropage,' '||lig_param.POTV4||' ')=0 THEN
 IF lig_param.POTV4      =1 THEN
 lig_cpt.POT1_VALEURJ :=NVL(lig_cpt_prec.POT1_FJ,NVL(lig_cpt_prec.POT1_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT1_VALEURH :=NVL(lig_cpt_prec.POT1_FH,NVL(lig_cpt_prec.POT1_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =2 THEN
 lig_cpt.POT2_VALEURJ :=NVL(lig_cpt_prec.POT2_FJ,NVL(lig_cpt_prec.POT2_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT2_VALEURH :=NVL(lig_cpt_prec.POT2_FH,NVL(lig_cpt_prec.POT2_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =3 THEN
 lig_cpt.POT3_VALEURJ :=NVL(lig_cpt_prec.POT3_FJ,NVL(lig_cpt_prec.POT3_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT3_VALEURH :=NVL(lig_cpt_prec.POT3_FH,NVL(lig_cpt_prec.POT3_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =4 THEN
 lig_cpt.POT4_VALEURJ :=NVL(lig_cpt_prec.POT4_FJ,NVL(lig_cpt_prec.POT4_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT4_VALEURH :=NVL(lig_cpt_prec.POT4_FH,NVL(lig_cpt_prec.POT4_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =5 THEN
 lig_cpt.POT5_VALEURJ :=NVL(lig_cpt_prec.POT5_FJ,NVL(lig_cpt_prec.POT5_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT5_VALEURH :=NVL(lig_cpt_prec.POT5_FH,NVL(lig_cpt_prec.POT5_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =6 THEN
 lig_cpt.POT6_VALEURJ :=NVL(lig_cpt_prec.POT6_FJ,NVL(lig_cpt_prec.POT6_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT6_VALEURH :=NVL(lig_cpt_prec.POT6_FH,NVL(lig_cpt_prec.POT6_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =7 THEN
 lig_cpt.POT7_VALEURJ :=NVL(lig_cpt_prec.POT7_FJ,NVL(lig_cpt_prec.POT7_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT7_VALEURH :=NVL(lig_cpt_prec.POT7_FH,NVL(lig_cpt_prec.POT7_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =8 THEN
 lig_cpt.POT8_VALEURJ :=NVL(lig_cpt_prec.POT8_FJ,NVL(lig_cpt_prec.POT8_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT8_VALEURH :=NVL(lig_cpt_prec.POT8_FH,NVL(lig_cpt_prec.POT8_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =9 THEN
 lig_cpt.POT9_VALEURJ :=NVL(lig_cpt_prec.POT9_FJ,NVL(lig_cpt_prec.POT9_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT9_VALEURH :=NVL(lig_cpt_prec.POT9_FH,NVL(lig_cpt_prec.POT9_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =10 THEN
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt_prec.POT10_FJ,NVL(lig_cpt_prec.POT10_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt_prec.POT10_FH,NVL(lig_cpt_prec.POT10_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =11 THEN
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt_prec.POT11_FJ,NVL(lig_cpt_prec.POT11_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt_prec.POT11_FH,NVL(lig_cpt_prec.POT11_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 elsif lig_param.POTV4   =12 THEN
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt_prec.POT12_FJ,NVL(lig_cpt_prec.POT12_VALEURJ,0))+NVL(lig_cpt.POTV4_VALEURJ,0);
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt_prec.POT12_FH,NVL(lig_cpt_prec.POT12_VALEURH,0))+NVL(lig_cpt.POTV4_VALEURH,0);
 END IF;
 END IF;
 IF lig_param.POTV5       IS NOT NULL AND instr(listPotANePasPropage,' '||lig_param.POTV5||' ')=0 THEN
 IF lig_param.POTV5      =1 THEN
 lig_cpt.POT1_VALEURJ :=NVL(lig_cpt_prec.POT1_FJ,NVL(lig_cpt_prec.POT1_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT1_VALEURH :=NVL(lig_cpt_prec.POT1_FH,NVL(lig_cpt_prec.POT1_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =2 THEN
 lig_cpt.POT2_VALEURJ :=NVL(lig_cpt_prec.POT2_FJ,NVL(lig_cpt_prec.POT2_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT2_VALEURH :=NVL(lig_cpt_prec.POT2_FH,NVL(lig_cpt_prec.POT2_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =3 THEN
 lig_cpt.POT3_VALEURJ :=NVL(lig_cpt_prec.POT3_FJ,NVL(lig_cpt_prec.POT3_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT3_VALEURH :=NVL(lig_cpt_prec.POT3_FH,NVL(lig_cpt_prec.POT3_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =4 THEN
 lig_cpt.POT4_VALEURJ :=NVL(lig_cpt_prec.POT4_FJ,NVL(lig_cpt_prec.POT4_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT4_VALEURH :=NVL(lig_cpt_prec.POT4_FH,NVL(lig_cpt_prec.POT4_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =5 THEN
 lig_cpt.POT5_VALEURJ :=NVL(lig_cpt_prec.POT5_FJ,NVL(lig_cpt_prec.POT5_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT5_VALEURH :=NVL(lig_cpt_prec.POT5_FH,NVL(lig_cpt_prec.POT5_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =6 THEN
 lig_cpt.POT6_VALEURJ :=NVL(lig_cpt_prec.POT6_FJ,NVL(lig_cpt_prec.POT6_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT6_VALEURH :=NVL(lig_cpt_prec.POT6_FH,NVL(lig_cpt_prec.POT6_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =7 THEN
 lig_cpt.POT7_VALEURJ :=NVL(lig_cpt_prec.POT7_FJ,NVL(lig_cpt_prec.POT7_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT7_VALEURH :=NVL(lig_cpt_prec.POT7_FH,NVL(lig_cpt_prec.POT7_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =8 THEN
 lig_cpt.POT8_VALEURJ :=NVL(lig_cpt_prec.POT8_FJ,NVL(lig_cpt_prec.POT8_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT8_VALEURH :=NVL(lig_cpt_prec.POT8_FH,NVL(lig_cpt_prec.POT8_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =9 THEN
 lig_cpt.POT9_VALEURJ :=NVL(lig_cpt_prec.POT9_FJ,NVL(lig_cpt_prec.POT9_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT9_VALEURH :=NVL(lig_cpt_prec.POT9_FH,NVL(lig_cpt_prec.POT9_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =10 THEN
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt_prec.POT10_FJ,NVL(lig_cpt_prec.POT10_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt_prec.POT10_FH,NVL(lig_cpt_prec.POT10_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =11 THEN
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt_prec.POT11_FJ,NVL(lig_cpt_prec.POT11_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt_prec.POT11_FH,NVL(lig_cpt_prec.POT11_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 elsif lig_param.POTV5   =12 THEN
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt_prec.POT12_FJ,NVL(lig_cpt_prec.POT12_VALEURJ,0))+NVL(lig_cpt.POTV5_VALEURJ,0);
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt_prec.POT12_FH,NVL(lig_cpt_prec.POT12_VALEURH,0))+NVL(lig_cpt.POTV5_VALEURH,0);
 END IF;
 END IF;
 IF lig_param.POTV6       IS NOT NULL AND instr(listPotANePasPropage,' '||lig_param.POTV6||' ')=0 THEN
 IF lig_param.POTV6      =1 THEN
 lig_cpt.POT1_VALEURJ :=NVL(lig_cpt_prec.POT1_FJ,NVL(lig_cpt_prec.POT1_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT1_VALEURH :=NVL(lig_cpt_prec.POT1_FH,NVL(lig_cpt_prec.POT1_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =2 THEN
 lig_cpt.POT2_VALEURJ :=NVL(lig_cpt_prec.POT2_FJ,NVL(lig_cpt_prec.POT2_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT2_VALEURH :=NVL(lig_cpt_prec.POT2_FH,NVL(lig_cpt_prec.POT2_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =3 THEN
 lig_cpt.POT3_VALEURJ :=NVL(lig_cpt_prec.POT3_FJ,NVL(lig_cpt_prec.POT3_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT3_VALEURH :=NVL(lig_cpt_prec.POT3_FH,NVL(lig_cpt_prec.POT3_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =4 THEN
 lig_cpt.POT4_VALEURJ :=NVL(lig_cpt_prec.POT4_FJ,NVL(lig_cpt_prec.POT4_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT4_VALEURH :=NVL(lig_cpt_prec.POT4_FH,NVL(lig_cpt_prec.POT4_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =5 THEN
 lig_cpt.POT5_VALEURJ :=NVL(lig_cpt_prec.POT5_FJ,NVL(lig_cpt_prec.POT5_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT5_VALEURH :=NVL(lig_cpt_prec.POT5_FH,NVL(lig_cpt_prec.POT5_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =6 THEN
 lig_cpt.POT6_VALEURJ :=NVL(lig_cpt_prec.POT6_FJ,NVL(lig_cpt_prec.POT6_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT6_VALEURH :=NVL(lig_cpt_prec.POT6_FH,NVL(lig_cpt_prec.POT6_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =7 THEN
 lig_cpt.POT7_VALEURJ :=NVL(lig_cpt_prec.POT7_FJ,NVL(lig_cpt_prec.POT7_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT7_VALEURH :=NVL(lig_cpt_prec.POT7_FH,NVL(lig_cpt_prec.POT7_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =8 THEN
 lig_cpt.POT8_VALEURJ :=NVL(lig_cpt_prec.POT8_FJ,NVL(lig_cpt_prec.POT8_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT8_VALEURH :=NVL(lig_cpt_prec.POT8_FH,NVL(lig_cpt_prec.POT8_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =9 THEN
 lig_cpt.POT9_VALEURJ :=NVL(lig_cpt_prec.POT9_FJ,NVL(lig_cpt_prec.POT9_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT9_VALEURH :=NVL(lig_cpt_prec.POT9_FH,NVL(lig_cpt_prec.POT9_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =10 THEN
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt_prec.POT10_FJ,NVL(lig_cpt_prec.POT10_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt_prec.POT10_FH,NVL(lig_cpt_prec.POT10_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =11 THEN
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt_prec.POT11_FJ,NVL(lig_cpt_prec.POT11_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt_prec.POT11_FH,NVL(lig_cpt_prec.POT11_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 elsif lig_param.POTV6   =12 THEN
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt_prec.POT12_FJ,NVL(lig_cpt_prec.POT12_VALEURJ,0))+NVL(lig_cpt.POTV6_VALEURJ,0);
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt_prec.POT12_FH,NVL(lig_cpt_prec.POT12_VALEURH,0))+NVL(lig_cpt.POTV6_VALEURH,0);
 END IF;
 END IF;
 END IF;
 END IF;
 
 IF lig_cpt.djour   <=NVL(datefin,'20991231') THEN
 
 for i in 1..12 loop
 
 --pot 1 
 if i=1 then
 -- si qu'une seule commande
 if instr(lig_param.POT1,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT1 is not null and instr(lig_param.POT1,'=')>0 then
 lig_param.POT1:=replace(lig_param.POT1,'=0','=');
 if lig_param.POT1='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT1 is not null then
 lig_param.POT1:=replace(lig_param.POT1,'+0','+');
 lig_param.POT1:=replace(lig_param.POT1,'-0','-');
 if lig_param.POT1='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif lig_param.POT1='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT1,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT1,0,instr(lig_param.POT1,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT1,instr(lig_param.POT1,';') + 1, length(lig_param.POT1));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT1_FJ,NVL(lig_cpt.POT1_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT1_FH,NVL(lig_cpt.POT1_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 
 --pot 2 
 if i=2 then
 -- si qu'une seule commande
 if instr(lig_param.POT2,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT2 is not null and instr(lig_param.POT2,'=')>0 then
 lig_param.POT2:=replace(lig_param.POT2,'=0','=');
 if lig_param.POT2='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT2 is not null then
 lig_param.POT2:=replace(lig_param.POT2,'+0','+');
 lig_param.POT2:=replace(lig_param.POT2,'-0','-');
 if lig_param.POT2='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif lig_param.POT2='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT2,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT2,0,instr(lig_param.POT2,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT2,instr(lig_param.POT2,';') + 1, length(lig_param.POT2));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT2_FJ,NVL(lig_cpt.POT2_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT2_FH,NVL(lig_cpt.POT2_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 3 
 if i=3 then
 -- si qu'une seule commande
 if instr(lig_param.POT3,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT3 is not null and instr(lig_param.POT3,'=')>0 then
 lig_param.POT3:=replace(lig_param.POT3,'=0','=');
 if lig_param.POT3='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT3 is not null then
 lig_param.POT3:=replace(lig_param.POT3,'+0','+');
 lig_param.POT3:=replace(lig_param.POT3,'-0','-');
 if lig_param.POT3='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif lig_param.POT3='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT3,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT3,0,instr(lig_param.POT3,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT3,instr(lig_param.POT3,';') + 1, length(lig_param.POT3));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT3_FJ,NVL(lig_cpt.POT3_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT3_FH,NVL(lig_cpt.POT3_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 4 
 if i=4 then
 -- si qu'une seule commande
 if instr(lig_param.POT4,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT4 is not null and instr(lig_param.POT4,'=')>0 then
 lig_param.POT4:=replace(lig_param.POT4,'=0','=');
 if lig_param.POT4='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT4 is not null then
 lig_param.POT4:=replace(lig_param.POT4,'+0','+');
 lig_param.POT4:=replace(lig_param.POT4,'-0','-');
 if lig_param.POT4='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif lig_param.POT4='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT4,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT4,0,instr(lig_param.POT4,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT4,instr(lig_param.POT4,';') + 1, length(lig_param.POT4));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT4_FJ,NVL(lig_cpt.POT4_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT4_FH,NVL(lig_cpt.POT4_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 5 
 if i=5 then
 -- si qu'une seule commande
 if instr(lig_param.POT5,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT5 is not null and instr(lig_param.POT5,'=')>0 then
 lig_param.POT5:=replace(lig_param.POT5,'=0','=');
 if lig_param.POT5='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT5 is not null then
 lig_param.POT5:=replace(lig_param.POT5,'+0','+');
 lig_param.POT5:=replace(lig_param.POT5,'-0','-');
 if lig_param.POT5='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif lig_param.POT5='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT5,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT5,0,instr(lig_param.POT5,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT5,instr(lig_param.POT5,';') + 1, length(lig_param.POT5));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT5_FJ,NVL(lig_cpt.POT5_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT5_FH,NVL(lig_cpt.POT5_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 6 
 if i=6 then
 -- si qu'une seule commande
 if instr(lig_param.POT6,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT6 is not null and instr(lig_param.POT6,'=')>0 then
 lig_param.POT6:=replace(lig_param.POT6,'=0','=');
 if lig_param.POT6='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT6 is not null then
 lig_param.POT6:=replace(lig_param.POT6,'+0','+');
 lig_param.POT6:=replace(lig_param.POT6,'-0','-');
 if lig_param.POT6='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif lig_param.POT6='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT6,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT6,0,instr(lig_param.POT6,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT6,instr(lig_param.POT6,';') + 1, length(lig_param.POT6));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT6_FJ,NVL(lig_cpt.POT6_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT6_FH,NVL(lig_cpt.POT6_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 7 
 if i=7 then
 -- si qu'une seule commande
 if instr(lig_param.POT7,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT7 is not null and instr(lig_param.POT7,'=')>0 then
 lig_param.POT7:=replace(lig_param.POT7,'=0','=');
 if lig_param.POT7='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT7 is not null then
 lig_param.POT7:=replace(lig_param.POT7,'+0','+');
 lig_param.POT7:=replace(lig_param.POT7,'-0','-');
 if lig_param.POT7='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT7='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT7,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT7,0,instr(lig_param.POT7,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT7,instr(lig_param.POT7,';') + 1, length(lig_param.POT7));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT7_FJ,NVL(lig_cpt.POT7_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 8 
 if i=8 then
 -- si qu'une seule commande
 if instr(lig_param.POT8,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT8 is not null and instr(lig_param.POT8,'=')>0 then
 lig_param.POT8:=replace(lig_param.POT8,'=0','=');
 if lig_param.POT8='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif lig_param.POT8='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT8 is not null then
 lig_param.POT8:=replace(lig_param.POT8,'+0','+');
 lig_param.POT8:=replace(lig_param.POT8,'-0','-');
 if lig_param.POT8='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT8='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT8,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT8,0,instr(lig_param.POT8,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT8,instr(lig_param.POT8,';') + 1, length(lig_param.POT8));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT8_FH,NVL(lig_cpt.POT8_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT8_FJ,NVL(lig_cpt.POT8_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 9 
 if i=9 then
 -- si qu'une seule commande
 if instr(lig_param.POT9,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT9 is not null and instr(lig_param.POT9,'=')>0 then
 lig_param.POT9:=replace(lig_param.POT9,'=0','=');
 if lig_param.POT9='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif lig_param.POT9='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT9 is not null then
 lig_param.POT9:=replace(lig_param.POT9,'+0','+');
 lig_param.POT9:=replace(lig_param.POT9,'-0','-');
 if lig_param.POT9='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT9='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT9,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT9,0,instr(lig_param.POT9,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT9,instr(lig_param.POT9,';') + 1, length(lig_param.POT9));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT9_FH,NVL(lig_cpt.POT9_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT9_FJ,NVL(lig_cpt.POT9_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 10 
 if i=10 then
 -- si qu'une seule commande
 if instr(lig_param.POT10,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT10 is not null and instr(lig_param.POT10,'=')>0 then
 lig_param.POT10:=replace(lig_param.POT10,'=0','=');
 if lig_param.POT10='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif lig_param.POT10='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT10 is not null then
 lig_param.POT10:=replace(lig_param.POT10,'+0','+');
 lig_param.POT10:=replace(lig_param.POT10,'-0','-');
 if lig_param.POT10='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT10='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT10,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT10,0,instr(lig_param.POT10,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT10,instr(lig_param.POT10,';') + 1, length(lig_param.POT10));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT10_FH,NVL(lig_cpt.POT10_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT10_FJ,NVL(lig_cpt.POT10_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
 
 --pot 11 
 if i=11 then
 -- si qu'une seule commande
 if instr(lig_param.POT11,';')<=0 then
 -- si qu'une commande =
 if lig_param.POT11 is not null and instr(lig_param.POT11,'=')>0 then
 lig_param.POT11:=replace(lig_param.POT11,'=0','=');
 if lig_param.POT11='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif lig_param.POT11='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 end if;
 
 
 -- si qu'une commande avec + ou -
 elsif lig_param.POT11 is not null then
 lig_param.POT11:=replace(lig_param.POT11,'+0','+');
 lig_param.POT11:=replace(lig_param.POT11,'-0','-');
 if lig_param.POT11='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif lig_param.POT11='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 -- si deux commandes
 elsif instr(lig_param.POT11,';')>0 then
 -- on fait le même calcul mais deux fois de suite pour traiter les deux commandes
 for j in 1..2 loop
 calcul := '';
 
 if j = 1 then
 calcul:=substr(lig_param.POT11,0,instr(lig_param.POT11,';') -1);
 elsif j = 2 then
 calcul:=substr(lig_param.POT11,instr(lig_param.POT11,';') + 1, length(lig_param.POT11));
 end if;
 -- d'abord si instruction =
 if calcul is not null and instr(calcul,'=')>0 then
 calcul:=replace(calcul,'=0','=');
 if calcul='=1' then
 lig_cpt.POT1_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=2' then
 lig_cpt.POT2_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=3' then
 lig_cpt.POT3_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=4' then
 lig_cpt.POT4_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=5' then
 lig_cpt.POT5_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=6' then
 lig_cpt.POT6_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=7' then
 lig_cpt.POT7_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=8' then
 lig_cpt.POT8_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=9' then
 lig_cpt.POT9_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=10' then
 lig_cpt.POT10_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=11' then
 lig_cpt.POT11_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 elsif calcul='=12' then
 lig_cpt.POT12_VALEURJ:=NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=NVL(lig_cpt.POT11_FH,NVL(lig_cpt.POT11_VALEURH,0));
 end if;
 
 
 -- ensuite si commande + ou -
 elsif calcul is not null then
 calcul:=replace(calcul,'+0','+');
 calcul:=replace(calcul,'-0','-');
 if calcul='+1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='+12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) + NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) + NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-1' then
 lig_cpt.POT1_VALEURJ:=nvl(lig_cpt.POT1_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT1_VALEURH:=nvl(lig_cpt.POT1_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-2' then
 lig_cpt.POT2_VALEURJ:=nvl(lig_cpt.POT2_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT2_VALEURH:=nvl(lig_cpt.POT2_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-3' then
 lig_cpt.POT3_VALEURJ:=nvl(lig_cpt.POT3_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT3_VALEURH:=nvl(lig_cpt.POT3_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-4' then
 lig_cpt.POT4_VALEURJ:=nvl(lig_cpt.POT4_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT4_VALEURH:=nvl(lig_cpt.POT4_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-5' then
 lig_cpt.POT5_VALEURJ:=nvl(lig_cpt.POT5_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT5_VALEURH:=nvl(lig_cpt.POT5_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-6' then
 lig_cpt.POT6_VALEURJ:=nvl(lig_cpt.POT6_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT6_VALEURH:=nvl(lig_cpt.POT6_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-7' then
 lig_cpt.POT7_VALEURJ:=nvl(lig_cpt.POT7_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT7_VALEURH:=nvl(lig_cpt.POT7_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-8' then
 lig_cpt.POT8_VALEURJ:=nvl(lig_cpt.POT8_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT8_VALEURH:=nvl(lig_cpt.POT8_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-9' then
 lig_cpt.POT9_VALEURJ:=nvl(lig_cpt.POT9_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT9_VALEURH:=nvl(lig_cpt.POT9_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-10' then
 lig_cpt.POT10_VALEURJ:=nvl(lig_cpt.POT10_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT10_VALEURH:=nvl(lig_cpt.POT10_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-11' then
 lig_cpt.POT11_VALEURJ:=nvl(lig_cpt.POT11_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT11_VALEURH:=nvl(lig_cpt.POT11_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 elsif calcul='-12' then
 lig_cpt.POT12_VALEURJ:=nvl(lig_cpt.POT12_VALEURJ,0) - NVL(lig_cpt.POT11_FJ,NVL(lig_cpt.POT11_VALEURJ,0));
 lig_cpt.POT12_VALEURH:=nvl(lig_cpt.POT12_VALEURH,0) - NVL(lig_cpt.POT7_FH,NVL(lig_cpt.POT7_VALEURH,0));
 end if;
 end if;
 
 
 end loop;
 end if;
 end if;
  
 
 END LOOP;
 END IF;
 
 
 if (nvl(lig_cptori.POT1_VALEURJ,0)<>nvl(lig_cpt.POT1_VALEURJ,0)
 OR nvl(lig_cptori.POT1_VALEURH,0)   <>nvl(lig_cpt.POT1_VALEURH,0)
 OR nvl(lig_cptori.POT2_VALEURJ,0)   <>nvl(lig_cpt.POT2_VALEURJ,0)
 OR nvl(lig_cptori.POT2_VALEURH,0)   <>nvl(lig_cpt.POT2_VALEURH,0)
 OR nvl(lig_cptori.POT3_VALEURJ,0)   <>nvl(lig_cpt.POT3_VALEURJ,0)
 OR nvl(lig_cptori.POT3_VALEURH,0)   <>nvl(lig_cpt.POT3_VALEURH,0)
 OR nvl(lig_cptori.POT4_VALEURJ,0)   <>nvl(lig_cpt.POT4_VALEURJ,0)
 OR nvl(lig_cptori.POT4_VALEURH ,0)  <>nvl(lig_cpt.POT4_VALEURH,0)
 OR nvl(lig_cptori.POT5_VALEURJ ,0)  <>nvl(lig_cpt.POT5_VALEURJ,0)
 OR nvl(lig_cptori.POT5_VALEURH ,0)  <>nvl(lig_cpt.POT5_VALEURH,0)
 OR nvl(lig_cptori.POT6_VALEURJ ,0)  <>nvl(lig_cpt.POT6_VALEURJ,0)
 OR nvl(lig_cptori.POT6_VALEURH ,0)  <>nvl(lig_cpt.POT6_VALEURH,0)
 OR nvl(lig_cptori.POT7_VALEURJ ,0)  <>nvl(lig_cpt.POT7_VALEURJ,0)
 OR nvl(lig_cptori.POT7_VALEURH ,0)  <>nvl(lig_cpt.POT7_VALEURH,0)
 OR nvl(lig_cptori.POT8_VALEURJ ,0)  <>nvl(lig_cpt.POT8_VALEURJ,0)
 OR nvl(lig_cptori.POT8_VALEURH ,0)  <>nvl(lig_cpt.POT8_VALEURH,0)
 OR nvl(lig_cptori.POT9_VALEURJ ,0)  <>nvl(lig_cpt.POT9_VALEURJ,0)
 OR nvl(lig_cptori.POT9_VALEURH ,0)  <>nvl(lig_cpt.POT9_VALEURH,0)
 OR nvl(lig_cptori.POT10_VALEURJ ,0) <>nvl(lig_cpt.POT10_VALEURJ,0)
 OR nvl(lig_cptori.POT10_VALEURH ,0) <>nvl(lig_cpt.POT10_VALEURH,0)
 OR nvl(lig_cptori.POT11_VALEURJ ,0) <>nvl(lig_cpt.POT11_VALEURJ,0)
 OR nvl(lig_cptori.POT11_VALEURH ,0) <>nvl(lig_cpt.POT11_VALEURH,0)
 OR nvl(lig_cptori.POT12_VALEURJ ,0) <>nvl(lig_cpt.POT12_VALEURJ,0)
 OR nvl(lig_cptori.POT12_VALEURH,0)  <>nvl(lig_cpt.POT12_VALEURH,0)) then
 
 UPDATE cad_compteur
 SET DATE_MAJ=(
 CASE
 WHEN (POT1_VALEURJ<>lig_cpt.POT1_VALEURJ
 OR POT1_VALEURH   <>lig_cpt.POT1_VALEURH
 OR POT2_VALEURJ   <>lig_cpt.POT2_VALEURJ
 OR POT2_VALEURH   <>lig_cpt.POT2_VALEURH
 OR POT3_VALEURJ   <>lig_cpt.POT3_VALEURJ
 OR POT3_VALEURH   <>lig_cpt.POT3_VALEURH
 OR POT4_VALEURJ   <>lig_cpt.POT4_VALEURJ
 OR POT4_VALEURH   <>lig_cpt.POT4_VALEURH
 OR POT5_VALEURJ   <>lig_cpt.POT5_VALEURJ
 OR POT5_VALEURH   <>lig_cpt.POT5_VALEURH
 OR POT6_VALEURJ   <>lig_cpt.POT6_VALEURJ
 OR POT6_VALEURH   <>lig_cpt.POT6_VALEURH
 OR POT7_VALEURJ   <>lig_cpt.POT7_VALEURJ
 OR POT7_VALEURH   <>lig_cpt.POT7_VALEURH
 OR POT8_VALEURJ   <>lig_cpt.POT8_VALEURJ
 OR POT8_VALEURH   <>lig_cpt.POT8_VALEURH
 OR POT9_VALEURJ   <>lig_cpt.POT9_VALEURJ
 OR POT9_VALEURH   <>lig_cpt.POT9_VALEURH
 OR POT10_VALEURJ  <>lig_cpt.POT10_VALEURJ
 OR POT10_VALEURH  <>lig_cpt.POT10_VALEURH
 OR POT11_VALEURJ  <>lig_cpt.POT11_VALEURJ
 OR POT11_VALEURH  <>lig_cpt.POT11_VALEURH
 OR POT12_VALEURJ  <>lig_cpt.POT12_VALEURJ
 OR POT12_VALEURH  <>lig_cpt.POT12_VALEURH)
 THEN sysdate
 ELSE DATE_MAJ
 END),
 POT1_VALEURJ  =lig_cpt.POT1_VALEURJ,
 POT1_VALEURH  =lig_cpt.POT1_VALEURH,
 POT2_VALEURJ  =lig_cpt.POT2_VALEURJ,
 POT2_VALEURH  =lig_cpt.POT2_VALEURH,
 POT3_VALEURJ  =lig_cpt.POT3_VALEURJ,
 POT3_VALEURH  =lig_cpt.POT3_VALEURH,
 POT4_VALEURJ  =lig_cpt.POT4_VALEURJ,
 POT4_VALEURH  =lig_cpt.POT4_VALEURH,
 POT5_VALEURJ  =lig_cpt.POT5_VALEURJ,
 POT5_VALEURH  =lig_cpt.POT5_VALEURH,
 POT6_VALEURJ  =lig_cpt.POT6_VALEURJ,
 POT6_VALEURH  =lig_cpt.POT6_VALEURH,
 POT7_VALEURJ  =lig_cpt.POT7_VALEURJ,
 POT7_VALEURH  =lig_cpt.POT7_VALEURH,
 POT8_VALEURJ  =lig_cpt.POT8_VALEURJ,
 POT8_VALEURH  =lig_cpt.POT8_VALEURH,
 POT9_VALEURJ  =lig_cpt.POT9_VALEURJ,
 POT9_VALEURH  =lig_cpt.POT9_VALEURH,
 POT10_VALEURJ =lig_cpt.POT10_VALEURJ,
 POT10_VALEURH =lig_cpt.POT10_VALEURH,
 POT11_VALEURJ =lig_cpt.POT11_VALEURJ,
 POT11_VALEURH =lig_cpt.POT11_VALEURH,
 POT12_VALEURJ =lig_cpt.POT12_VALEURJ,
 POT12_VALEURH =lig_cpt.POT12_VALEURH
 WHERE CURRENT OF cur_cpt ;
 end if;
 dtprec      :=lig_cpt.DJour;
 typprec     :=lig_cpt.typemj;
 lig_cpt_prec:=lig_cpt;
 /*  IF Tab_ligcpt     IS NULL THEN
 Tab_ligcpt      :=Typ_Tab_ligcpt(lig_cpt);
 ELSE
 Tab_ligcpt.extend();
 Tab_ligcpt(Tab_ligcpt.last):=lig_cpt;
 END IF;*/
 END LOOP;
 CLOSE cur_cpt;
 
 /* forall i in Tab_ligcpt.first..Tab_ligcpt.last
 UPDATE cad_compteur
 SET DATE_MAJ=(
 CASE
 WHEN (POT1_VALEURJ<>lig_cpt.POT1_VALEURJ
 OR POT1_VALEURH   <>Tab_ligcpt(i).POT1_VALEURH
 OR POT2_VALEURJ   <>Tab_ligcpt(i).POT2_VALEURJ
 OR POT2_VALEURH   <>Tab_ligcpt(i).POT2_VALEURH
 OR POT3_VALEURJ   <>Tab_ligcpt(i).POT3_VALEURJ
 OR POT3_VALEURH   <>Tab_ligcpt(i).POT3_VALEURH
 OR POT4_VALEURJ   <>Tab_ligcpt(i).POT4_VALEURJ
 OR POT4_VALEURH   <>Tab_ligcpt(i).POT4_VALEURH
 OR POT5_VALEURJ   <>Tab_ligcpt(i).POT5_VALEURJ
 OR POT5_VALEURH   <>Tab_ligcpt(i).POT5_VALEURH
 OR POT6_VALEURJ   <>Tab_ligcpt(i).POT6_VALEURJ
 OR POT6_VALEURH   <>Tab_ligcpt(i).POT6_VALEURH
 OR POT7_VALEURJ   <>Tab_ligcpt(i).POT7_VALEURJ
 OR POT7_VALEURH   <>Tab_ligcpt(i).POT7_VALEURH
 OR POT8_VALEURJ   <>Tab_ligcpt(i).POT8_VALEURJ
 OR POT8_VALEURH   <>Tab_ligcpt(i).POT8_VALEURH
 OR POT9_VALEURJ   <>Tab_ligcpt(i).POT9_VALEURJ
 OR POT9_VALEURH   <>Tab_ligcpt(i).POT9_VALEURH
 OR POT10_VALEURJ  <>Tab_ligcpt(i).POT10_VALEURJ
 OR POT10_VALEURH  <>Tab_ligcpt(i).POT10_VALEURH
 OR POT11_VALEURJ  <>Tab_ligcpt(i).POT11_VALEURJ
 OR POT11_VALEURH  <>Tab_ligcpt(i).POT11_VALEURH
 OR POT12_VALEURJ  <>Tab_ligcpt(i).POT12_VALEURJ
 OR POT12_VALEURH  <>Tab_ligcpt(i).POT12_VALEURH)
 THEN sysdate
 ELSE DATE_MAJ
 END),
 POT1_VALEURJ  =Tab_ligcpt(i).POT1_VALEURJ,
 POT1_VALEURH  =Tab_ligcpt(i).POT1_VALEURH,
 POT2_VALEURJ  =Tab_ligcpt(i).POT2_VALEURJ,
 POT2_VALEURH  =Tab_ligcpt(i).POT2_VALEURH,
 POT3_VALEURJ  =Tab_ligcpt(i).POT3_VALEURJ,
 POT3_VALEURH  =Tab_ligcpt(i).POT3_VALEURH,
 POT4_VALEURJ  =Tab_ligcpt(i).POT4_VALEURJ,
 POT4_VALEURH  =Tab_ligcpt(i).POT4_VALEURH,
 POT5_VALEURJ  =Tab_ligcpt(i).POT5_VALEURJ,
 POT5_VALEURH  =Tab_ligcpt(i).POT5_VALEURH,
 POT6_VALEURJ  =Tab_ligcpt(i).POT6_VALEURJ,
 POT6_VALEURH  =Tab_ligcpt(i).POT6_VALEURH,
 POT7_VALEURJ  =Tab_ligcpt(i).POT7_VALEURJ,
 POT7_VALEURH  =Tab_ligcpt(i).POT7_VALEURH,
 POT8_VALEURJ  =Tab_ligcpt(i).POT8_VALEURJ,
 POT8_VALEURH  =Tab_ligcpt(i).POT8_VALEURH,
 POT9_VALEURJ  =Tab_ligcpt(i).POT9_VALEURJ,
 POT9_VALEURH  =Tab_ligcpt(i).POT9_VALEURH,
 POT10_VALEURJ =Tab_ligcpt(i).POT10_VALEURJ,
 POT10_VALEURH =Tab_ligcpt(i).POT10_VALEURH,
 POT11_VALEURJ =Tab_ligcpt(i).POT11_VALEURJ,
 POT11_VALEURH =Tab_ligcpt(i).POT11_VALEURH,
 POT12_VALEURJ =Tab_ligcpt(i).POT12_VALEURJ,
 POT12_VALEURH =Tab_ligcpt(i).POT12_VALEURH where rowid=Tab_ligcpt(i).rowid;*/
 
 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg  := SQLERRM;
 CAD_ERREUR(IDMATRIC ,'CAD_UNIT_PROPAGATION', IDMATRIC ||','|| p_matric ||','|| DATEDEB ||','||DATEFIN ||','|| CODECPT ||','|| AvecBascule ,err_code||'-'||err_msg);
 raise;
 END CAD_UNIT_PROPAGATION;
 PROCEDURE CAD_UNIT_MAJ_VALEUR_RUBJOUR(
 idMat               IN NUMBER,
 matric              IN VARCHAR2 ,
 DATEJOUR            IN VARCHAR2 ,
 rub                 IN VARCHAR2,
 unite               IN VARCHAR2,
 nbh                 IN NUMBER,
 j_cal               IN NUMBER,
 j_ouvrable          IN NUMBER,
 j_oeuvr             IN NUMBER,
 j_ouvre             IN NUMBER,
 nbjour              IN OUT NUMBER,
 nbheures            IN OUT NUMBER,
 forcage             IN VARCHAR2,
 limitazero          IN BOOLEAN,
 forcageDuResteEnFin IN VARCHAR2)
 AS
 CURSOR cur_cpt
 IS
 SELECT *
 FROM
 (SELECT a.code_compteur,
 a.pot_solde,
 a.pot_variation,
 a.min_soldej,
 a.min_soldeh,
 a.ordre
 FROM CAD_PARAM_LIEN_RUB_CPT a,
 CAD_MATRIC_DATEVALID b
 WHERE a.RUB_VAL_JOUR =rub
 AND a.code_compteur  =b.code_compteur
 AND b.matricule      =matric
 AND b.date_deb_per  <=datejour
 AND b.date_fin_per  >=datejour
 AND b.DATE_EFFET     =
 (SELECT MAX(date_effet)
 FROM cad_matric_datevalid c
 WHERE c.date_effet<=datejour
 AND c.code_compteur=b.code_compteur
 AND b.matricule    =c.matricule
 AND b.date_deb_per =c.date_deb_per
 AND b.date_fin_per =c.date_fin_per
 )
 )
 ORDER BY
 CASE
 WHEN forcageDuResteEnFin='true'
 THEN ordre
 END DESC,
 CASE
 WHEN forcageDuResteEnFin='false'
 THEN ordre
 END
 --  ordre
 ;
 ligne_cpt cur_cpt%ROWTYPE;
 numpotSolde    NUMBER;
 numpotPris     NUMBER;
 pot_Var        NUMBER;
 valSoldeJ      NUMBER:=0;
 valSoldeH      NUMBER:=0;
 valVarJ        NUMBER:=0;
 valVarH        NUMBER:=0;
 valPrisJ       NUMBER:=0;
 valPrisH       NUMBER:=0;
 req            VARCHAR(2000);
 djourcpt       VARCHAR(8);
 typemjcp       VARCHAR(1);
 gestionHJ      VARCHAR(1);
 soldeJ         NUMBER :=0;
 variationJ     NUMBER :=0;
 soldeH         NUMBER :=0;
 variationH     NUMBER :=0;
 reqpropagation VARCHAR(4000);
 reqinsert      VARCHAR(4000);
 pasdeCpt       BOOLEAN;
 cptValide      BOOLEAN:=false;
 l_rowid        VARCHAR2(100);
 BEGIN
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO ligne_cpt;
 EXIT
 WHEN cur_cpt%NOTFOUND ;
 cptValide    :=true;
 IF gestionHJ IS NULL THEN
 SELECT cpt.gestionHJ
 INTO gestionHJ
 FROM CAD_PARAM_STRUCT_CPT cpt
 WHERE cpt.CODE_COMPTEUR=ligne_cpt.code_compteur;
 IF nbjour              =0 AND nbheures=0 THEN
 IF gestionHJ         ='H' THEN
 nbjour            :=0;
 nbheures          :=nbh;
 ELSE
 IF gestionHJ='A' THEN
 nbheures :=nbh;
 ELSE
 nbheures:=0;
 END IF;
 IF unite   ='C' THEN
 nbjour  :=j_cal;
 elsif unite='U' THEN
 nbjour  :=j_ouvre;
 elsif unite='S' THEN
 nbjour  :=j_ouvrable;
 elsif unite='O' THEN
 nbjour  :=j_oeuvr;
 END IF;
 END IF;
 END IF;
 END IF;
 -- Récupération du pot de variation
 SELECT
 CASE
 WHEN POTV1=ligne_cpt.pot_variation
 THEN 1
 WHEN POTV2=ligne_cpt.pot_variation
 THEN 2
 WHEN POTV3=ligne_cpt.pot_variation
 THEN 3
 WHEN POTV4=ligne_cpt.pot_variation
 THEN 4
 WHEN POTV5=ligne_cpt.pot_variation
 THEN 5
 WHEN POTV6=ligne_cpt.pot_variation
 THEN 6
 END
 INTO pot_Var
 FROM CAD_PARAM_CALCUL
 WHERE code_compteur=ligne_cpt.code_compteur;
 IF pot_Var        IS NOT NULL THEN
 -- Récupération du solde, du pris et de la variation
 req:= 'select djour,typemj,nvl(POT'||ligne_cpt.pot_solde||'_VALEURJ,0), nvl(POT'||ligne_cpt.pot_solde||'_VALEURH,0),nvl(POTV'||pot_Var||'_VALEURJ,0), nvl(POTV'||pot_Var||'_VALEURH,0),nvl(POT'||ligne_cpt.pot_variation||'_VALEURJ,0), nvl(POT'||ligne_cpt.pot_variation||'_VALEURH,0),rowid from CAD_COMPTEUR c where c.matricule      = :matric
 and code_COMPTEUR= :codecpt
 AND djour||typemj          =
 (SELECT MAX(c2.djour||c2.typemj)
 FROM CAD_COMPTEUR c2
 WHERE c.code_compteur=c2.code_compteur
 AND c.matricule      =c2.matricule
 AND ( c2.djour        <:datejour
 or
 (
 c2.djour=:datejour and c2.typemj<''S''
 ))) ' ;
 BEGIN
 IF ligne_cpt.pot_solde<>0 THEN
 EXECUTE immediate req INTO djourcpt,
 typemjcp,
 valSoldeJ,
 valSoldeH,
 valVarJ,
 valVarH,
 valprisJ,
 valprisH,
 l_rowid USING matric,
 ligne_cpt.code_compteur,
 datejour,
 datejour;
 END IF;
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 pasdeCpt:=true;
 CONTINUE;
 END;
 pasdeCpt:=false;
 -- Solde suffisant
 IF djourcpt <>datejour THEN
 valVarJ   :=0;
 valVarH   :=0;
 END IF;
 -- Si le solde est est déjà au min  et pas de forçage on ne fait rien
 IF ligne_cpt.pot_solde<>0 AND (NOT (forcage='true' AND forcageduresteenfin='true' ) AND ((gestionHJ='A' AND ( (limitazero AND (valSoldeJ<=greatest(ligne_cpt.MIN_SOLDEJ,0)) OR (NOT limitazero AND (valSoldeJ<=ligne_cpt.MIN_SOLDEJ) ))) AND ( (limitazero AND (valSoldeH<=greatest(ligne_cpt.MIN_SOLDEH,0)) OR (NOT limitazero AND (valSoldeH<=ligne_cpt.MIN_SOLDEH) )))) OR (gestionHJ='J' AND (limitazero AND (valSoldeJ<=greatest(ligne_cpt.MIN_SOLDEJ,0)) OR (NOT limitazero AND (valSoldeJ<=ligne_cpt.MIN_SOLDEJ) ) )) OR (gestionHJ='H' AND (limitazero AND (valSoldeH<=greatest(ligne_cpt.MIN_SOLDEH,0)) OR (NOT limitazero AND (valSoldeH<=ligne_cpt.MIN_SOLDEH) ) )))) THEN
 CONTINUE;
 -- si solde suffisant
 elsIF ligne_cpt.pot_solde=0 OR ((forcage='true' AND forcageduresteenfin='true' ) OR (gestionHJ='A' AND ( (limitazero AND valSoldeJ-(nbjour+valVarJ)>=greatest(ligne_cpt.MIN_SOLDEJ,0)) OR (NOT limitazero AND valSoldeJ-(nbjour+valVarJ)>=ligne_cpt.MIN_SOLDEJ)) AND ( (limitazero AND valSoldeH-(nbheures+valVarH)>=greatest(ligne_cpt.MIN_SOLDEH,0) ) OR (NOT limitazero AND valSoldeH-(nbheures+valVarH)>=ligne_cpt.MIN_SOLDEH) ) ) OR (gestionHJ='H' AND ( (limitazero AND valSoldeH-(nbheures+valVarH)>=greatest(ligne_cpt.MIN_SOLDEH,0) ) OR (NOT limitazero AND valSoldeH-(nbheures+valVarH)>=ligne_cpt.MIN_SOLDEH) )) OR (gestionHJ='J' AND ( (limitazero AND valSoldeJ-(nbjour+valVarJ)>=greatest(ligne_cpt.MIN_SOLDEJ,0)) OR (NOT limitazero AND valSoldeJ-(nbjour+valVarJ)>=ligne_cpt.MIN_SOLDEJ))) ) THEN
 -- mise à jour de la variation et sortie
 IF (djourcpt  =datejour AND (typemjcp='N' OR typemjcp='M' )) THEN
 variationJ := valVarJ+ nbjour;
 variationH := valVarH+ nbheures;
 req        :='UPDATE CAD_COMPTEUR set date_maj=sysdate,POTV'||pot_Var||'_VALEURJ=:1,POT'||ligne_cpt.pot_variation||'_VALEURJ=nvl(POT'||ligne_cpt.pot_variation||'_VALEURJ,0)+:2
 ,POTV'||pot_Var||'_VALEURh=:3,POT'||ligne_cpt.pot_variation||'_VALEURh=nvl(POT'||ligne_cpt.pot_variation||'_VALEURh,0)+:4
 where
 rowid=:5';
 EXECUTE immediate req USING variationJ,
 nbjour,
 variationH,
 nbheures,
 l_rowid;
 ELSE
 IF gestionHJ  ='A' OR gestionHJ='J' THEN
 variationJ := NVL(nbjour,0);
 END IF;
 IF gestionHJ  ='A' OR gestionHJ='H' THEN
 variationH := NVL(nbheures,0);
 END IF;
 IF variationJ>0 OR variationH>0 THEN
 reqinsert := 'INSERT into CAD_COMPTEUR (MATRICULE,CODE_COMPTEUR,DJOUR,TYPEMJ,date_maj,POT'||ligne_cpt.pot_variation||'_VALEURJ,POTV'||pot_Var||'_VALEURJ,POT'||ligne_cpt.pot_variation||'_VALEURH,POTV'||pot_Var||'_VALEURH)
 values ('''||matric||''','''||ligne_cpt.code_compteur||''','''||datejour||''',''N'',sysdate,:1,:2,:3,:4)';
 EXECUTE immediate reqinsert USING NVL(valPrisJ,0)+ NVL(nbjour,0),
 NVL(variationJ,0),
 NVL(valPrisH,0)+ NVL(nbheures,0),
 NVL(variationH,0) ;
 END IF;
 END IF;
 nbheures:=0;
 nbjour  :=0;
 EXIT;
 ELSE -- on n'a pas assez on prend la partie possible et on calcule le reste
 IF gestionHJ='A' OR gestionHJ='J' THEN
 IF limitazero THEN
 nbjour := nbjour - greatest(0,valSoldeJ);
 ELSE
 nbjour := nbjour - greatest(0,(valSoldeJ-ligne_cpt.MIN_SOLDEJ));
 END IF;
 END IF;
 IF limitazero THEN
 nbheures := nbheures - greatest(0,valSoldeH);
 ELSE
 nbheures := nbheures - greatest(0,(valSoldeH-ligne_cpt.MIN_SOLDEH));
 END IF;
 IF (djourcpt =datejour AND (typemjcp='N' OR typemjcp='M' )) THEN
 IF limitazero THEN
 req:= 'UPDATE CAD_COMPTEUR set date_maj=sysdate,POTV'||pot_Var||'_VALEURJ=POT'||ligne_cpt.pot_solde||'_VALEURJ-('||greatest(0,ligne_cpt.MIN_SOLDEJ)||'),POT'||ligne_cpt.pot_variation||'_VALEURJ=nvl(POT'||ligne_cpt.pot_variation||'_VALEURJ,0)+ nvl(POT'||ligne_cpt.pot_solde||'_VALEURJ,0)-'||greatest(0,ligne_cpt.MIN_SOLDEJ)||'
 ,POTV'||pot_Var||'_VALEURH=POT'||ligne_cpt.pot_solde||'_VALEURH-('||greatest(0,ligne_cpt.MIN_SOLDEH)||'),POT'||ligne_cpt.pot_variation||'_VALEURH=nvl(POT'||ligne_cpt.pot_variation||'_VALEURH,0)+ nvl(POT'||ligne_cpt.pot_solde||'_VALEURH,0)-('||greatest(0,ligne_cpt.MIN_SOLDEH)||')
 where rowid=:1';
 ELSE
 req:='UPDATE CAD_COMPTEUR set date_maj=sysdate,POTV'||pot_Var||'_VALEURJ=POT'||ligne_cpt.pot_solde||'_VALEURJ-('||ligne_cpt.MIN_SOLDEJ||'),POT'||ligne_cpt.pot_variation||'_VALEURJ=nvl(POT'||ligne_cpt.pot_variation||'_VALEURJ,0)+ nvl(POT'||ligne_cpt.pot_solde||'_VALEURJ,0)-('||ligne_cpt.MIN_SOLDEJ||')
 ,POTV'||pot_Var||'_VALEURH=POT'||ligne_cpt.pot_solde||'_VALEURH-('||ligne_cpt.MIN_SOLDEH||'),POT'||ligne_cpt.pot_variation||'_VALEURH=nvl(POT'||ligne_cpt.pot_variation||'_VALEURH,0)+ nvl(POT'||ligne_cpt.pot_solde||'_VALEURH,0)-('||ligne_cpt.MIN_SOLDEH||')
 where rowid=:1';
 END IF;
 EXECUTE immediate req USING l_rowid;
 ELSE
 IF gestionHJ ='A' OR gestionHJ='J' THEN
 IF limitazero THEN
 soldeJ     := greatest(0,ligne_cpt.MIN_SOLDEJ);
 variationJ :=valSoldeJ-greatest(0,ligne_cpt.MIN_SOLDEJ) ;
 ELSE
 soldeJ     := ligne_cpt.MIN_SOLDEJ;
 variationJ :=valSoldeJ-ligne_cpt.MIN_SOLDEJ ;
 END IF;
 END IF;
 IF gestionHJ ='A' OR gestionHJ='H' THEN
 IF limitazero THEN
 soldeH     :=greatest(0,ligne_cpt.MIN_SOLDEH);
 variationH :=valSoldeH-greatest(0,ligne_cpt.MIN_SOLDEH) ;
 ELSE
 soldeH     := ligne_cpt.MIN_SOLDEH;
 variationH :=valSoldeH-ligne_cpt.MIN_SOLDEH ;
 END IF;
 END IF;
 IF variationJ>0 OR variationH>0 THEN
 req       := 'INSERT into CAD_COMPTEUR (MATRICULE,CODE_COMPTEUR,DJOUR,TYPEMJ,date_maj,POT'||ligne_cpt.pot_variation||'_VALEURJ,POTV'||pot_Var||'_VALEURJ,POT'||ligne_cpt.pot_variation||'_VALEURH,POTV'||pot_Var||'_VALEURH)
 values ('''||matric||''','''||ligne_cpt.code_compteur||''','''||datejour||''',''N'',sysdate,:1,:2,:3, :4)';
 EXECUTE immediate req USING valprisJ+soldeJ+variationJ,
 variationJ,
 valprish+soldeH+variationH,
 variationH;
 END IF;
 END IF;
 END IF;
 END IF;
 END LOOP;
 CLOSE cur_cpt;
 -- si mode interactif (pas recalcul) on renvoie une erreur si le solde est insuffisant
 --    - mode recalcul : on passe en solde négatif ( que faire d'autre :1)
 --    - mode interactif : on renvoie une erreur pas assez de solde : erreur de type CAD-00001
 IF NOT limitazero AND forcage<>'true' THEN
 IF pasdecpt THEN
 ROLLBACK;
 raise_application_error(-20000, 'CAD00117#'||matric||'#'||datejour||'#'||rub);
 END IF;
 IF ( nbheures>0 OR nbjour>0) THEN
 ROLLBACK;
 raise_application_error(-20000, 'CAD00055#'||datejour||'#'||rub);
 END IF;
 END IF;
 IF NOT cptValide AND forcage<>'true' THEN
 ROLLBACK;
 raise_application_error(-20000, 'CAD00117#'||matric||'#'||datejour||'#'||rub);
 END IF;
 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg  := SQLERRM;
 CAD_ERREUR(idMat ,'CAD_UNIT_MAJ_VALEUR', idMat ||','|| matric ||','|| DATEJOUR ||','|| rub ||','|| unite ||','|| nbh ||','|| j_cal ||','|| j_ouvrable ||','|| j_oeuvr ||','|| j_ouvre ||','|| nbjour ||','|| nbheures ||','|| forcage ,err_code||'-'||err_msg);
 raise;
 END CAD_UNIT_MAJ_VALEUR_RUBJOUR;
 PROCEDURE         CAD_MAJ_VALEUR_RUBJOUR(
 idmat           IN NUMBER,
 pmatric         IN VARCHAR2,
 dateprec        IN VARCHAR2,
 datejour        IN VARCHAR2,
 nbh             IN NUMBER,
 j_cal           IN NUMBER,
 j_ouvrable      IN NUMBER,
 j_oeuvr         IN NUMBER,
 j_ouvre         IN NUMBER,
 rub             IN VARCHAR2,
 forcage         IN VARCHAR2)
 AS
 nbjour          NUMBER:=0;
 nbheures        NUMBER:=0;
 unite           VARCHAR(1);
 dtrecalc        VARCHAR(8);
 dtdebrecalc     VARCHAR(8);
 CURSOR cur_cpt
 IS
 SELECT code_compteur, MAX(djour) AS djour
 FROM cad_compteur cpt
 WHERE djour < datejour
 AND  matricule = pmatric
 AND code_compteur IN (SELECT DISTINCT code_compteur FROM cad_param_lien_rub_cpt lien /*WHERE rub_val_jour = rub*/)
 GROUP BY code_compteur;
 lig_cpt cur_cpt%rowtype;
 BEGIN
 nbjour := 0;
 nbheures := 0;
 unite := cad_unite(pmatric, datejour, rub);
 
 /*
 SELECT MAX(djour) INTO dtrecalc
 FROM (SELECT code_compteur, MIN(djour) AS djour
 FROM cad_compteur cpt
 WHERE djour > datejour
 AND matricule = matric
 AND code_compteur IN (SELECT code_compteur FROM cad_param_lien_rub_cpt WHERE rub_val_jour = rub)
 GROUP BY code_compteur
 );
 */
 
 BEGIN
 SELECT djour INTO dtrecalc
 FROM (SELECT TO_CHAR(ip.date_effet, 'yyyymmdd') AS djour
 FROM tge_incidents_paie     ip,
 dic_adm_contrat        dac,
 -- MONOP DIT 50818
 DIC_ADM_CONTRAT_SITU   s
 WHERE dac.matric = pmatric
 AND dac.NUMPAC=s.NUMPAC
 AND dac.PACMAT=s.PACMAT
 AND dac.NUMCNT=s.NUMCNT
 AND ip.date_effet > TO_DATE(datejour, 'yyyymmdd')
 AND ip.idpacmat = dac.idpacmat
 AND ip.paiezad = s.paiezad
 AND ip.date_effet BETWEEN dac.dsdcn AND NVL(dac.dsfcn, TO_DATE('20991231', 'yyyymmdd'))
 AND ip.code_ip IN (SELECT DISTINCT (rub_val_jour) FROM cad_param_lien_rub_cpt)
 ORDER BY ip.date_effet
 )
 WHERE ROWNUM = 1;
 EXCEPTION
 WHEN OTHERS THEN
 CAD_ERREUR(idmat ,'CAD_MAJ_VALEUR_RUBJOUR', idmat ||','|| pmatric || ',' || dateprec || ',' || datejour || ',' || nbh || ',' || j_cal || ',' || j_ouvrable || ',' || j_oeuvr || ',' || j_ouvre || ',' || rub || ',' || forcage, err_code || '-' || err_msg );
 dtrecalc := datejour;
 END;
 dtdebrecalc := datejour;
 
 /*
 IF dateprec IS NOT NULL THEN
 dtDebrecalc := DATEJOUR;
 ELSE
 SELECT MIN(djour) INTO dtDebrecalc
 FROM (SELECT code_compteur, max(DJOUR) as djour
 FROM cad_compteur cpt
 WHERE djour < datejour
 AND matricule = matric
 AND code_compteur IN (SELECT code_compteur FROM cad_param_lien_rub_cpt WHERE rub_val_jour = rub)
 GROUP BY CODE_COMPTEUR);
 END IF;
 */
 
 cad_avancement(idmat, '    Début rub : ' || datejour || ',' || rub);
 cad_unit_maj_valeur_rubjour(idmat, pmatric , datejour, rub ,unite , nbh , j_cal , j_ouvrable , j_oeuvr , j_ouvre ,nbjour,nbheures , forcage, TRUE, 'false');
 cad_avancement(idmat, '    Fin rub : ' || datejour);
 cad_avancement(idmat, '    Début calcul : ' || datejour);
 cad_avancement(idmat, '    Début propag : ' || datejour);
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO lig_cpt;
 EXIT
 WHEN cur_cpt%notfound;
 cad_unit_propagation(idmat, pmatric, lig_cpt.djour, datejour, lig_cpt.code_compteur, 'BASCULE');
 END LOOP;
 CLOSE cur_cpt;
 --cad_unit_propagation(idmat, matric, null, DATEJOUR, null, 'BASCULE');
 --cad_avancement(idmat, '    Fin propag : ' || datejour);
 --cad_calcul(matric, idmat, dtDebrecalc, dtrecalc);
 --cad_avancement(idmat, '    Fin calcul : ' || datejour);
 IF nbjour > 0 OR nbheures > 0 THEN
 cad_unit_maj_valeur_rubjour(idmat, pmatric , datejour,rub ,unite , nbh , j_cal , j_ouvrable , j_oeuvr , j_ouvre ,nbjour,nbheures , forcage, FALSE,'false');
 cad_avancement(idmat, '    Début propag : ' || datejour);
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO lig_cpt ;
 EXIT
 WHEN cur_cpt%notfound;
 cad_unit_propagation(idmat, pmatric, lig_cpt.djour, datejour, lig_cpt.code_compteur, 'BASCULE');
 END LOOP;
 CLOSE cur_cpt;
 --cad_unit_propagation(idmat, matric, null, DATEJOUR, null, 'BASCULE');
 cad_avancement(idmat,'    Fin propag : '|| datejour);
 --cad_calcul(matric,idmat, dtDebrecalc, dtrecalc);
 END IF;
 IF (nbjour > 0 OR nbheures > 0) AND forcage = 'true' THEN
 cad_unit_maj_valeur_rubjour(idmat, pmatric , datejour,rub ,unite , nbh , j_cal , j_ouvrable , j_oeuvr , j_ouvre ,nbjour,nbheures , forcage, FALSE, 'true');
 cad_avancement(idmat, '    Début propag : ' || datejour);
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO lig_cpt ;
 EXIT
 WHEN cur_cpt%notfound ;
 cad_unit_propagation(idmat, pmatric, lig_cpt.djour, datejour, lig_cpt.code_compteur, 'BASCULE');
 END LOOP;
 CLOSE cur_cpt;
 --cad_unit_propagation(idmat, matric, null, DATEJOUR, null, 'BASCULE');
 cad_avancement(idmat, '    Fin propag : ' || datejour);
 --cad_calcul(matric, idmat, dtDebrecalc, dtrecalc);
 END IF;
 cad_calcul(pmatric, idmat, dtdebrecalc, dtrecalc);
 END CAD_MAJ_VALEUR_RUBJOUR;
 PROCEDURE CAD_MISE_A_0_VAR(
 idMat IN NUMBER,
 dtdeb IN VARCHAR2 )
 AS
 CURSOR cur_cpt
 IS
 SELECT cpt.code_compteur,
 MAX(DJOUR) AS djour,
 cpt.matricule
 FROM CAD_COMPTEUR cpt,cad_calcul_en_cours_matric d,(SELECT DISTINCT code_compteur FROM CAD_PARAM_LIEN_RUB_CPT
 ) lien
 WHERE DJOUr    <dtdeb
 and d.id=idMat
 AND cpt.MATRICULE =d.matricule
 AND cpt.CODE_COMPTEUR = lien.code_compteur
 GROUP BY cpt.CODE_COMPTEUR,
 cpt.matricule;
 lig_cpt cur_cpt%ROWTYPE;
 dtrecalc VARCHAR(8);
 BEGIN
 CAD_AVANCEMENT(idMat,'Début Mise à 0');
 -- remise à 0 des pots de variation
 CAD_AVANCEMENT(idMat,'  Début Mise à 0 des pots');
 UPDATE CAD_COMPTEUR a
 SET potv1_valeurJ=0 ,
 potv1_valeurH  =0,
 date_maj       =sysdate
 WHERE typemj    <>'I'
 AND DJOUr       >=dtdeb
 AND MATRICULE   IN
 (SELECT d.matricule FROM cad_calcul_en_cours_matric d WHERE d.id=idMat
 )
 AND code_compteur IN
 (SELECT DISTINCT b.CODE_COMPTEUR
 FROM cad_param_lien_rub_cpt b,
 cad_PARAM_calcul c
 WHERE B.code_compteur =c.code_compteur
 AND a.code_compteur   =b.code_compteur
 AND b.pot_variation   =c.potv1
 );
 UPDATE CAD_COMPTEUR a
 SET potv2_valeurJ=0 ,
 potv2_valeurH  =0,
 date_maj       =sysdate
 WHERE typemj    <>'I'
 AND DJOUr       >=dtdeb
 AND MATRICULE   IN
 (SELECT d.matricule FROM cad_calcul_en_cours_matric d WHERE d.id=idMat
 )
 AND code_compteur IN
 (SELECT DISTINCT b.CODE_COMPTEUR
 FROM cad_param_lien_rub_cpt b,
 cad_PARAM_calcul c
 WHERE B.code_compteur =c.code_compteur
 AND a.code_compteur   =b.code_compteur
 AND b.pot_variation   =c.potv2
 );
 UPDATE CAD_COMPTEUR a
 SET potv3_valeurJ=0 ,
 potv3_valeurH  =0,
 date_maj       =sysdate
 WHERE typemj    <>'I'
 AND DJOUr       >=dtdeb
 AND MATRICULE   IN
 (SELECT d.matricule FROM cad_calcul_en_cours_matric d WHERE d.id=idMat
 )
 AND code_compteur IN
 (SELECT DISTINCT b.CODE_COMPTEUR
 FROM cad_param_lien_rub_cpt b,
 cad_PARAM_calcul c
 WHERE B.code_compteur =c.code_compteur
 AND a.code_compteur   =b.code_compteur
 AND b.pot_variation   =c.potv3
 );
 UPDATE CAD_COMPTEUR a
 SET potv4_valeurJ=0 ,
 potv4_valeurH  =0,
 date_maj       =sysdate
 WHERE typemj    <>'I'
 AND DJOUr       >=dtdeb
 AND MATRICULE   IN
 (SELECT d.matricule FROM cad_calcul_en_cours_matric d WHERE d.id=idMat
 )
 AND code_compteur IN
 (SELECT DISTINCT b.CODE_COMPTEUR
 FROM cad_param_lien_rub_cpt b,
 cad_PARAM_calcul c
 WHERE B.code_compteur =c.code_compteur
 AND a.code_compteur   =b.code_compteur
 AND b.pot_variation   =c.potv4
 );
 UPDATE CAD_COMPTEUR a
 SET potv5_valeurJ=0 ,
 potv5_valeurH  =0,
 date_maj       =sysdate
 WHERE typemj    <>'I'
 AND DJOUr       >=dtdeb
 AND MATRICULE   IN
 (SELECT d.matricule FROM cad_calcul_en_cours_matric d WHERE d.id=idMat
 )
 AND code_compteur IN
 (SELECT DISTINCT b.CODE_COMPTEUR
 FROM cad_param_lien_rub_cpt b,
 cad_PARAM_calcul c
 WHERE B.code_compteur =c.code_compteur
 AND a.code_compteur   =b.code_compteur
 AND b.pot_variation   =c.potv5
 );
 UPDATE CAD_COMPTEUR a
 SET potv6_valeurJ=0 ,
 potv6_valeurH  =0,
 date_maj       =sysdate
 WHERE typemj    <>'I'
 AND DJOUr       >=dtdeb
 AND MATRICULE   IN
 (SELECT d.matricule FROM cad_calcul_en_cours_matric d WHERE d.id=idMat
 )
 AND code_compteur IN
 (SELECT DISTINCT b.CODE_COMPTEUR
 FROM cad_param_lien_rub_cpt b,
 cad_PARAM_calcul c
 WHERE B.code_compteur =c.code_compteur
 AND a.code_compteur   =b.code_compteur
 AND b.pot_variation   =c.potv6
 );
 CAD_AVANCEMENT(idMat,'  Fin Mise à 0 des pots');
 /*for i in 1..6
 loop*/
 -- But : Mettre à 0 seulement les pots de variations utilisées par les rubriques
 /* execute immediate 'merge into ( select * from CAD_COMPTEUR cpt where typemj<>''I'' and DJOUr >='||dtdeb||' AND MATRICULE in (select matricule from cad_calcul_en_cours_matric d where d.id='||idMat||' )) a using (select b.CODE_COMPTEUR from cad_param_lien_rub_cpt b, cad_PARAM_calcul c where  B.code_compteur=c.code_compteur
 and b.pot_variation=c.potv'||i||'  group by  b.CODE_COMPTEUR ) e on ( a.code_COMPTeur=e.code_compteur  )
 when matched then
 update set a.potv'||i||'_valeurJ=0 , a.potv'||i||'_valeurH=0,date_maj=sysdate' ;
 end loop;*/
 CAD_AVANCEMENT(idMat,'  Début propag');
 -- reprise des valeurs précédentes puis calcul
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO lig_cpt ;
 EXIT
 WHEN cur_cpt%NOTFOUND ;
 cad_unit_propagation(idmat,lig_cpt.matricule,lig_cpt.djour,dtdeb,lig_cpt.code_compteur,'BASCULE');
 END LOOP;
 CLOSE cur_cpt;
 CAD_AVANCEMENT(idMat,'  Fin propag');
 -- calcul jusqu'à première rubrique sinon fin ??
 /*  BEGIN
 SELECT djour
 INTO dtrecalc
 FROM
 (SELECT TO_CHAR(je.jour,'yyyymmdd') AS djour
 FROM gta_jou_contrat cnt,
 gta_jou_jouremploi je,
 gta_jou_valjour val
 WHERE je.employe_id IN
 (SELECT matricule FROM cad_calcul_en_cours_matric WHERE id=idmat
 )
 AND je.jour        >to_date(dtdeb,'yyyymmdd')
 AND je.id          =val.jour_emploi_id
 AND cnt.employe_id =je.employe_id
 AND je.code_contrat=cnt.code_contrat
 AND je.jour BETWEEN cnt.date_deb_valid AND NVL(cnt.date_fin_valid,to_date('20991231','yyyymmdd') )
 AND val.rub_val_jour IN
 (SELECT DISTINCT (RUB_VAL_JOUR) FROM CAD_PARAM_LIEN_RUB_CPT
 )
 ORDER BY je.jour
 )
 WHERE rownum=1;
 EXCEPTION
 WHEN OTHERS THEN
 dtrecalc:=NULL;
 END;*/
 CAD_AVANCEMENT(idMat,'  Début calcul suite mise à 0 ');
 CAD_CALCUL(NULL,idMat,dtdeb,NULL);
 CAD_AVANCEMENT(idMat,'  Fin calcul suite mise à 0 ');
 CAD_AVANCEMENT(idMat,'Fin Mise à 0');
 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg  := SQLERRM;
 CAD_ERREUR(idMat ,'CAD_MISE_A_0_VAR', idMat ||','|| dtdeb ,err_code||'-'||err_msg );
 raise;
 END CAD_MISE_A_0_VAR;
 PROCEDURE CAD_UNIT_BASCULE(
 IDMATRIC   IN NUMBER ,
 p_matric   IN VARCHAR2,
 BASCULE    IN VARCHAR2 ,
 DATEBAS    IN VARCHAR2 ,
 p_ordre    IN NUMBER,
 p_typebasc IN VARCHAR2)
 AS
 CURSOR cur_Bascule
 IS
 SELECT a.*,
 b.compteur_dest,
 b.compteur_ori,
 requetes,
 a.rowid,
 (select max(d.djour||'#'||d.typemj)  from CAD_COMPTEUR d where d.MATRICULE=a.MATRICULE and d.CODE_COMPTEUR= b.compteur_ori AND d.DJOUR||d.typemj<DATE_THEO_BASCULE||p_typebasc ) as djourFirst,
 -- (select max(typemj) from CAD_COMPTEUR d where d.code_compteur = b.compteur_ori and d.djour <(select max(e.djour)  from CAD_COMPTEUR e where e.MATRICULE=d.MATRICULE and e.CODE_COMPTEUR= d.code_compteur AND e.DJOUR||e.typemj<=DATEBAS||p_typebasc ) and d.matricule = a.matricule) as typemjFirst,
 (select max(d.djour)  from CAD_COMPTEUR d where d.MATRICULE=a.MATRICULE and d.CODE_COMPTEUR= b.compteur_ori AND d.DJOUR||d.typemj<=DATE_THEO_BASCULE||p_typebasc ) as djourAutre,
 p_typebasc as typemjautre
 
 FROM CAD_REGLES_PREVUES_REALISEES a,
 cad_param_regles_maj b,CAD_CALCUL_EN_COURS_MATRIC mat
 WHERE a.code_bascule =b.code_bascule
 AND a.code_bascule   =bascule
 AND DATE_THEO_BASCULE=DATEBAS
 AND a.type_bascule   =p_typebasc
 -- and requetes is not null
 AND (ordre           =p_ordre
 OR (ordre           IS NULL
 AND p_ordre         IS NULL))
 AND a.matricule= mat.matricule
 and mat.id     =idmatric
 AND mat.matricule=NVL(p_matric,mat.matricule);
 ligneBascule cur_Bascule%ROWTYPE;
 pos  NUMBER:=0;
 subs VARCHAR2(4000);
 req CLOB;
 requpdate clob;
 djourReq  VARCHAR2(1000);
 TYPE T_REC IS RECORD (
 idRow varchar2(100),
 dte  CAD_COMPTEUR.djour%TYPE,
 typemj  CAD_COMPTEUR.typemj%TYPE );
 
 TYPE Tab_Rowid
 IS
 TABLE OF T_REC index by pls_integer;
 T_Id Tab_Rowid;
 T_IdBasc Tab_Rowid;
 code_basc_prec VARCHAR(20);
 code_dest_prec VARCHAR(20);
 code_ori_prec  VARCHAR(20);
 mat_prec       VARCHAR(20);
 type_mj_req varchar(1);
 sizeTab number;
 withdjour boolean;
 reqwithoutDate clob;
 nbdjour number;
 TYPE TYP_compteur_dest is table of varchar2(1) index by varchar2(32) ;
 tab_compteur_dest TYP_compteur_dest;
 BEGIN
 OPEN cur_Bascule;
 LOOP
 FETCH cur_Bascule INTO ligneBascule;
 
 --req              :=ligneBascule.REQUETES;
 IF code_basc_prec                                                     IS NOT NULL AND (lignebascule.code_bascule <>code_basc_prec OR cur_Bascule%NOTFOUND) THEN
 reqwithoutDate:='';
 requpdate:='';
 nbdjour:=0;
 BEGIN
 WHILE LENGTH(req) >0
 LOOP
 IF instr(req,';')>0 THEN
 subs          :=SUBSTR(req,0,instr(req,';'));
 ELSE
 subs:=req;
 END IF;
 req      :=REPLACE(req,subs,'');
 req      :=REPLACE(req,subs,'');
 IF instr(subs,'_DJOUR_')>0 THEN
 nbdjour:=nbdjour+1;
 withdjour:=true;
 subs     :=REPLACE(subs,'_DJOUR_',':date'||trunc(dbms_random.value(1,100))||' and typemj=:type'||trunc(dbms_random.value(1,100)));
 subs     :=REPLACE(subs,';','');
 -- requpdate:='update CAD_COMPTEUR ca set '||subs||' where rowid=:1' ;
 if requpdate is not null then
 requpdate:=requpdate||',';
 end if;
 requpdate:=requpdate||subs;
 else
 withdjour:=false;
 subs     :=REPLACE(subs,';','');
 if reqwithoutDate is not null then
 reqwithoutDate:=reqwithoutDate||',';
 end if;
 reqwithoutDate:=reqwithoutDate||subs;
 end if;
 
 
 -- CAD_DEBUG(idmatric,requpdate);
 /* if withdjour then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 end if;*/
 END LOOP;
 if reqwithoutDate is not null then
 reqwithoutDate:='update CAD_COMPTEUR ca set '||reqwithoutDate||' where rowid=:1' ;
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate reqwithoutDate USING t_id(i).idrow;
 end if;
 
 if requpdate is not null then
 requpdate:='update CAD_COMPTEUR ca set '||requpdate||' where rowid=:1' ;
 if nbdjour=1 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=2 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=3 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=4 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=5 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=6 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=7 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=8 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=9 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=10 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=11 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 elsif nbdjour=12 then
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).dte,t_id(i).typemj,t_id(i).idrow;
 end if;
 end if;
 
 
 FORALL i IN T_IdBasc.first..T_IdBasc.last
 UPDATE CAD_REGLES_PREVUES_REALISEES a
 SET statut        ='OK',
 DERNIERE_BASCULE=SYSTIMESTAMP
 WHERE rowid       =T_IdBasc(i).idrow;
 EXCEPTION
 WHEN OTHERS THEN
 IF T_IdBasc IS NOT NULL THEN
 FORALL i IN T_IdBasc.first..T_IdBasc.last
 UPDATE CAD_REGLES_PREVUES_REALISEES a
 SET statut        ='KO',
 DERNIERE_BASCULE=SYSTIMESTAMP
 WHERE rowid       =T_IdBasc(i).idrow;
 END IF;
 raise;
 END;
 END IF;
 EXIT
 WHEN cur_Bascule%NOTFOUND ;
 code_dest_prec := lignebascule.compteur_dest;
 code_ori_prec  := lignebascule.compteur_ori;
 mat_prec       := lignebascule.matricule ;
 IF p_typebasc                                                        ='B' THEN
 IF not tab_compteur_dest.exists(mat_prec||'#'||code_ori_prec) THEN
 -- djourReq                                                        :=' (select max(d.djour)  from CAD_COMPTEUR d where d.MATRICULE=ca.MATRICULE and d.CODE_COMPTEUR=ori.code_compteur AND d.DJOUR<'''||datebas||'''  )  and typemj=(select max(typemj) from CAD_COMPTEUR d where d.code_compteur = ori.code_compteur and d.djour = ori.djour and d.matricule = ori.matricule) ';
 djourReq :=substr(lignebascule.djourFirst,1,8);
 type_mj_req:=substr(lignebascule.djourFirst,10,1);
 --listecompteur_dest                                              :=listecompteur_dest||';'||mat_prec||'#'||code_dest_prec||';';
 tab_compteur_dest(mat_prec||'#'||code_dest_prec):='Y';
 ELSE
 --DBMS_OUTPUT.PUT_LINE (listecompteur_dest);
 --FIXME utiliser la procédure trace_dbms_output()
 djourReq :=lignebascule.djourAUTRE;
 type_mj_req:=lignebascule.typemjAUTRE ;
 -- djourReq :=' (select max(d.djour)  from CAD_COMPTEUR d where d.MATRICULE=ca.MATRICULE and d.CODE_COMPTEUR=ori.code_compteur AND d.DJOUR||d.typemj<='''||datebas||'B''  ) and typemj=''B'' ';
 END IF;
 ELSE
 IF not tab_compteur_dest.exists(mat_prec||'#'||code_ori_prec) THEN
 -- djourReq                                                        :=' (select max(d.djour)  from CAD_COMPTEUR d where d.MATRICULE=ca.MATRICULE and d.CODE_COMPTEUR=ori.code_compteur AND d.DJOUR||d.typemj<'''||datebas||'S''  )  and typemj=(select max(typemj) from CAD_COMPTEUR d where d.code_compteur = ori.code_compteur and d.djour = ori.djour and d.matricule = ori.matricule and (d.DJOUR<'''||datebas||''' or ( d.DJOUR='''||datebas||''' and typemj<>''S''))) ';
 djourReq :=substr(lignebascule.djourFirst,1,8);
 type_mj_req:=substr(lignebascule.djourFirst,10,1);
 -- listecompteur_dest                                              :=listecompteur_dest||';'||mat_prec||'#'||code_dest_prec||';';
 tab_compteur_dest(mat_prec||'#'||code_dest_prec):='Y';
 ELSE
 --djourReq :=' (select max(d.djour)  from CAD_COMPTEUR d where d.MATRICULE=ca.MATRICULE and d.CODE_COMPTEUR=ori.code_compteur AND d.DJOUR||d.typemj<='''||datebas||'S''  )  and typemj=''S'' ';
 djourReq :=lignebascule.djourAUTRE;
 type_mj_req:=lignebascule.typemjAUTRE ;
 END IF;
 END IF;
 
 
 DECLARE
 CURSOR cur_cpt
 IS
 SELECT cad_compteur.*,
 rowid
 FROM cad_compteur
 WHERE TYPEMJ     =p_typebasc
 AND CODE_COMPTEUR=ligneBascule.compteur_dest
 AND DJOUR        =DATEBAS
 AND MATRICULE    =ligneBascule.matricule;
 lig_cpt cur_cpt%rowtype;
 BEGIN
 IF code_basc_prec IS NULL OR lignebascule.code_bascule <>code_basc_prec THEN
 t_id.delete;
 T_IdBasc.delete;
 req             :=ligneBascule.REQUETES;
 if req is null then
 req:='POT1_VALEURJ=0,POT1_VALEURH=0 ;POT2_VALEURJ=0,POT2_VALEURH=0 ;POT3_VALEURJ=0,POT3_VALEURH=0 ;POT4_VALEURJ=0,POT4_VALEURH=0 ;POT5_VALEURJ=0,POT5_VALEURH=0 ;POT6_VALEURJ=0,POT6_VALEURH=0 ;POT7_VALEURJ=0,POT7_VALEURH=0 ;POT8_VALEURJ=0,POT8_VALEURH=0 ;POT9_VALEURJ=0,POT9_VALEURH=0 ;POT10_VALEURJ=0,POT10_VALEURH=0 ;POT11_VALEURJ=0,POT11_VALEURH=0 ;POT12_VALEURJ=0,POT12_VALEURH=0 ;';
 end if;
 END IF;
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO lig_cpt;
 EXIT
 WHEN cur_cpt%NOTFOUND ;
 -- select max(d.djour)  into djourReq from CAD_COMPTEUR d where d.MATRICULE=lig_cpt.MATRICULE and d.CODE_COMPTEUR=lignebascule.COMPTEUR_ORI AND DJOUR<DATEBAS;
 sizeTab:=t_id.count+1;
 t_id(sizeTab).idrow:=lig_cpt.rowid;
 t_id(sizeTab).dte:=djourReq;
 t_id(sizeTab).typemj:=type_mj_req;
 sizeTab:=T_IdBasc.count+1;
 T_IdBasc(sizeTab).idrow:=lignebascule.rowid;
 
 END LOOP;
 CLOSE cur_cpt;
 code_basc_prec := lignebascule.code_bascule;
 
 END;
 END LOOP;
 CLOSE cur_Bascule;
 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg  :=SQLERRM;
 CAD_ERREUR(IDMATRIC ,'CAD_UNIT_BASCULE', IDMATRIC||','|| p_matric||','|| BASCULE ||','|| DATEBAS ||','|| p_ordre ||','|| p_typebasc ,err_code||'-'||err_msg);
 raise;
 END CAD_UNIT_BASCULE;
 PROCEDURE CAD_UNIT_CALCUL(
 IDMATRIC   IN NUMBER ,
 p_MATRIC   IN VARCHAR2 ,
 DATEDEB    IN VARCHAR2 ,
 DATEFIN    IN VARCHAR2,
 AvecBacule IN VARCHAR2)
 AS
 CURSOR tabRequetes
 IS
 SELECT cptcal.CODE_COMPTEUR
 FROM CAD_CALCUL_EN_COURS_CPT cptcal
 WHERE cptcal.id =IDMATRIC
 /* AND cptcal.code_compteur IN
 (SELECT code_compteur
 FROM cad_compteur cpt,
 CAD_CALCUL_EN_COURS_MATRIC mat
 WHERE cpt.matricule=mat.matricule
 AND mat.id         =cptcal.id
 AND mat.matricule  =NVL(p_matric,mat.matricule)
 AND djour BETWEEN datedeb AND NVL(datefin,'20991231')
 ) */
 ;
 lignesRequetes tabRequetes%ROWTYPE;
 pos              NUMBER:=0;
 subs             VARCHAR2(1000);
 req              VARCHAR2(1000);
 requpdate        VARCHAR2(1000);
 cptPrec          VARCHAR2(20);
 reqpropagation   VARCHAR(4000);
 numpot           VARCHAR(2);
 listPotVariation VARCHAR(100):='';
 listPotAPropage  VARCHAR(100);
 un_index         INT;
 nbcounter        NUMBER;
 nbcounterFin     NUMBER;
 tdeb             TIMESTAMP;
 tfin             TIMESTAMP;
 debcalc          NUMBER;
 fincalc          NUMBER;
 totalcalc        NUMBER:=0;
 BEGIN
 OPEN tabRequetes;
 LOOP
 FETCH tabRequetes INTO lignesRequetes;
 EXIT
 WHEN tabRequetes%NOTFOUND ;
 --propagation
 IF cptprec IS NULL OR cptprec <>lignesRequetes.CODE_COMPTEUR THEN
 CAD_AVANCEMENT(idmatric,'Propag var du cpt '||lignesRequetes.CODE_COMPTEUR||' du '||datedeb||' au '|| datefin);
 CAD_UNIT_PROPAGATION(idmatric,p_matric,datedeb,datefin,lignesRequetes.CODE_COMPTEUR,AvecBacule);
 cptprec:=lignesRequetes.CODE_COMPTEUR;
 END IF;
 END LOOP;
 CLOSE tabRequetes;
 END CAD_UNIT_CALCUL;
 PROCEDURE CAD_CALCUL_MATRIC(
 numSeq  IN NUMBER ,
 matric  IN VARCHAR2,
 DATEDEB IN VARCHAR2 ,
 DATEFIN IN VARCHAR2 )
 AS
 idCpt        NUMBER:=numSeq ;
 dateprec     VARCHAR2(8);
 typeBascPrec VARCHAR2(1);
 typeBasc     VARCHAR2(1);
 DATEBASC     VARCHAR2(8);
 CURSOR tabBasculesDeLaPop
 IS
 SELECT DISTINCT bpr.code_bascule,
 '' AS MATRICULE,
 bpr.DATE_THEO_BASCULE,
 ''   AS STATUT,
 NULL AS derniere_bascule,
 bpr.ordre,
 NULL AS MAJ_CONTRAT,
 bpr.type_bascule
 FROM CAD_REGLES_PREVUES_REALISEES bpr ,
 CAD_CALCUL_EN_COURS_MATRIC mat
 WHERE bpr.matricule=mat.matricule
 AND mat.id         =numseq
 AND bpr.date_theo_bascule BETWEEN DATEDEB AND NVL(datefin,'20991231')
 AND bpr.matricule=NVL(matric,bpr.matricule)
 ORDER BY bpr.DATE_THEO_BASCULE,
 bpr.type_bascule,
 bpr.ORDRE;
 ligneBasculesDeLaPop CAD_REGLES_PREVUES_REALISEES%ROWTYPE;
 listebascules CLOB:='';
 deb       NUMBER;
 fin       NUMBER;
 total     NUMBER:=0;
 debcalc   NUMBER;
 fincalc   NUMBER;
 totalcalc NUMBER:=0;
 listecompteur_dest CLOB:=';';
 TYPE TYP_compteur_dest is table of varchar2(1) index by varchar2(32) ;
 tab_compteur_dest TYP_compteur_dest;
 BEGIN
 CAD_AVANCEMENT(numseq,'Depart calcul');
 --CAD_DEBUG(numSeq,'');
 -- insert into CAD_CALCUL_EN_COURS_CPT (ID,CODE_COMPTEUR) select distinct idCpt as ID,COMPTEUR_DEST as CODE_COMPTEUR  from CAD_REGLES_PREVUES_REALISEES bpr , CAD_PARAM_REGLES_MAJ bdef , CAD_CALCUL_EN_COURS_MATRIC mat where bpr.matricule=mat.matricule and bpr.CODE_BASCULE=bdef.code_bascule;
 /*if numseq is null then
 DELETE
 FROM CAD_CALCUL_EN_COURS_CPT
 WHERE id=numseq;
 end if;*/
 OPEN tabBasculesDeLaPop;
 dateprec    :=datedeb;
 typebascprec:='B';
 LOOP
 FETCH tabBasculesDeLaPop INTO ligneBasculesDeLaPop;
 IF tabBasculesDeLaPop%NOTFOUND THEN
 DATEBASC:=NULL;
 typebasc:=NULL;
 ELSE
 DATEBASC:=ligneBasculesDeLaPop.DATE_THEO_BASCULE;
 typebasc:=ligneBasculesDeLaPop.type_bascule;
 END IF;
 --DBMS_OUTPUT.PUT_LINE('-BASCULE-'||' - '||NVL(DATEBASC,'*')||TO_CHAR(sysdate,'HH24:MI:SS'));
 --FIXME utiliser la procédure trace_dbms_output()
 -- si la date précédente est la même que la date de la bascule : pas de recalcul
 IF (dateprec        <>ligneBasculesDeLaPop.DATE_THEO_BASCULE OR DATEBASC IS NULL) OR (typebasc<> typebascprec OR typebasc IS NULL) THEN
 listecompteur_dest:=';';
 tab_compteur_dest.delete;
 IF listebascules  IS NOT NULL AND DATEBASC IS NOT NULL THEN
 --  CAD_UNIT_Faussebascule(idCpt,dateprec,listebascules);
 listebascules:='';
 -- On a au moins une bascule donc on calcule jusqu'au jour précédant la bascule
 -- et propagation jusqu'à la situation suivante après la bascule
 CAD_UNIT_CALCUL(idCpt,matric,DATEPREC, DATEBASC,'BASCULE');
 --  CAD_UNIT_PROPAGATION (idCpt,matric,DATEPREC, DATEBASC,null,'BASCULE');
 
 ELSE
 IF DATEBASC IS NOT NULL THEN
 -- première bascule : calcul jusqu'au jour précédant la bascule
 -- et propagation jusqu'à la situation suivante après la bascule
 CAD_UNIT_CALCUL(idCpt,matric,DATEPREC,DATEBASC,'BASCULE');
 -- CAD_UNIT_PROPAGATION (idCpt,matric,DATEPREC, DATEBASC,null,'BASCULE');
 ELSE
 -- pas de bascule, on calcule jusqu'à la fin
 CAD_UNIT_CALCUL(idCpt,matric,DATEPREC, datefin,'');
 --  CAD_UNIT_PROPAGATION (idCpt,matric,DATEPREC, DATEBASC,null,'BASCULE');
 END IF;
 END IF;
 END IF;
 EXIT
 WHEN tabBasculesDeLaPop%NOTFOUND ;
 --DBMS_OUTPUT.PUT_LINE('-CAD_CALCUL_MATRIC-CAD_UNIT_4-'||TO_CHAR(sysdate,'HH24:MI:SS'));
 --FIXME utiliser la procédure trace_dbms_output()
 CAD_AVANCEMENT(numseq,'Bascule '||ligneBasculesDeLaPop.CODE_BASCULE||' du '||DATEBASC);
 CAD_UNIT_BASCULE(numSeq,matric,ligneBasculesDeLaPop.CODE_BASCULE, DATEBASC,ligneBasculesDeLaPop.ordre,typebasc);
 IF dateprec         =DATEBASC THEN
 IF listebascules IS NULL OR listebascules='' THEN
 listebascules  :=''''||ligneBasculesDeLaPop.CODE_BASCULE||'''';
 ELSE
 IF (instr(listebascules,ligneBasculesDeLaPop.CODE_BASCULE)=0) THEN
 listebascules                                          := listebascules||','''||ligneBasculesDeLaPop.CODE_BASCULE||'''';
 END IF;
 END IF;
 ELSE
 IF listebascules IS NULL OR listebascules='' THEN
 listebascules  :=''''||ligneBasculesDeLaPop.CODE_BASCULE||'''';
 END IF;
 END IF;
 dateprec    := DATEBASC;
 typebascprec:=typebasc;
 END LOOP;
 CLOSE tabBasculesDeLaPop;
 END CAD_CALCUL_MATRIC;
 PROCEDURE CAD_CALCUL(
 matric  IN VARCHAR2 ,
 idrub   IN NUMBER ,
 DATEDEB IN VARCHAR2 ,
 DATEFIN IN VARCHAR2 )
 AS
 id_calc NUMBER;
 deb     NUMBER;
 fin     NUMBER;
 total   NUMBER:=0;
 BEGIN
 deb:= DBMS_UTILITY.get_time;
 BEGIN
 SELECT is_debug INTO valdebug FROM CAD_IS_DEBUG;
 EXCEPTION
 WHEN OTHERS THEN
 valdebug:='N';
 END;
 -- TODO les delete sera fait plus tard par purge
 IF valdebug='O' THEN
 DELETE FROM CAD_TRACE_REQ WHERE id=idrub;
 END IF;
 --delete from CAD_CALCUL_EN_COURS_MATRIC  where id=idrub;
 IF matric IS NOT NULL AND idrub IS NULL THEN
 SELECT CAD_SEQ_CALCUL.nextVAL INTO id_calc FROM dual;
 --ne fonctionne qu'avec un matricule
 INSERT
 INTO CAD_CALCUL_EN_COURS_MATRIC
 (
 id,
 matricule
 )
 VALUES
 (
 id_calc,
 matric
 );
 --CAD_DEBUG(id_calc,'');
 CAD_AVANCEMENT(id_calc,'Bascules '||datedeb);
 CAD_INIT_BASCULES( id_calc , matric , DATEDEB, DATEFIN) ;
 CAD_AVANCEMENT(id_calc,'Fin Bascules '||datedeb);
 CAD_AVANCEMENT(id_calc,'Début insert calcul cpt '||datedeb);
 INSERT
 INTO CAD_CALCUL_EN_COURS_CPT
 (
 ID,
 CODE_COMPTEUR
 )
 (SELECT DISTINCT id_calc AS ID,
 CODE_COMPTEUR        AS CODE_COMPTEUR
 FROM CAD_COMPTEUR cpt,
 CAD_CALCUL_EN_COURS_MATRIC mat
 WHERE cpt.matricule=mat.matricule
 AND mat.id         =id_calc
 ) ;
 CAD_AVANCEMENT(id_calc,'Fin insert calcul cpt '||datedeb);
 END IF;
 IF idrub IS NOT NULL THEN
 id_calc:=idrub;
 --     insert into CAD_CALCUL_EN_COURS_MATRIC(id,matricule) select distinct id,matricule from CAD_CALCUL_EN_COURS_RUB  where id=idrub and matricule not in (select distinct matricule from CAD_CALCUL_EN_COURS_MATRIC where id=idrub);
 END IF;
 fin  := DBMS_UTILITY.get_time;
 total:=total+(fin-deb);
 --DBMS_OUTPUT.put_line('Avant CAD_CALCUL_MATRIC : '||total);
 --FIXME utiliser la procédure trace_dbms_output()
 CAD_CALCUL_MATRIC(id_calc,matric,DATEDEB,DATEFIN);
 EXCEPTION
 WHEN OTHERS THEN
 raise_application_error(-20000, 'Problème(s) durant le recalcul des compteurs');
 END CAD_CALCUL;
 PROCEDURE CAD_CONTROLE_SOLDE
 (
 idrub  IN VARCHAR2,
 matric IN VARCHAR2
 )
 AS
 dtdeb VARCHAR2
 (
 8
 )
 ;
 dtfin     VARCHAR2(8);
 solde     NUMBER;
 unite     NUMBER;
 nbBas     NUMBER;
 variation NUMBER;
 TYPE TYP_RUB
 IS
 TABLE OF cad_calcul_en_cours_rub.rub_val_jour%type ;
 Tabrub TYP_RUB;
 BEGIN
 -- cas sans bascule
 SELECT MIN(date_jour)
 INTO dtdeb
 FROM CAD_CALCUL_EN_COURS_RUB
 WHERE id     =idrub
 AND matricule=matric;
 SELECT MAX(date_jour)
 INTO dtfin
 FROM CAD_CALCUL_EN_COURS_RUB
 WHERE id     =idrub
 AND matricule=matric;
 SELECT COUNT(*)
 INTO nbBas
 FROM CAD_MATRIC_DATEVALID
 WHERE DATE_FIN_PER BETWEEN dtdeb AND dtfin
 AND matricule=matric;
 IF nbBas     =0 THEN
 SELECT rub_val_jour BULK COLLECT
 INTO Tabrub
 FROM CAD_CALCUL_EN_COURS_RUB
 WHERE id     = idrub
 AND matricule=matric
 AND date_jour=dtdeb
 ORDER BY rub_val_jour;
 FOR i IN Tabrub.first..Tabrub.last
 LOOP
 solde   :=CAD_SOLDE(MATRIC,DTDEB,Tabrub(i));
 unite   := cad_unite(matric,DTDEB,Tabrub(i));
 IF unite = 'H' THEN
 SELECT SUM(heure)
 INTO variation
 FROM CAD_CALCUL_EN_COURS_RUB
 WHERE id        =idrub
 AND matric      =matricule
 AND rub_val_jour=tabrub(i);
 elsif unite       = 'C' THEN
 SELECT SUM(calend)
 INTO variation
 FROM CAD_CALCUL_EN_COURS_RUB
 WHERE id        =idrub
 AND matric      =matricule
 AND rub_val_jour=tabrub(i);
 elsif unite       = 'U' THEN
 SELECT SUM(ouvre)
 INTO variation
 FROM CAD_CALCUL_EN_COURS_RUB
 WHERE id        =idrub
 AND matric      =matricule
 AND rub_val_jour=tabrub(i);
 elsif unite       = 'O' THEN
 SELECT SUM(oeuvre)
 INTO variation
 FROM CAD_CALCUL_EN_COURS_RUB
 WHERE id        =idrub
 AND matric      =matricule
 AND rub_val_jour=tabrub(i);
 elsif unite       = 'S' THEN
 SELECT SUM(ouvrable)
 INTO variation
 FROM CAD_CALCUL_EN_COURS_RUB
 WHERE id        =idrub
 AND matric      =matricule
 AND rub_val_jour=tabrub(i);
 END IF;
 solde  :=solde - variation;
 IF solde<0 THEN
 raise_application_error(-20000, 'CAD_0001');
 END IF ;
 END LOOP ;
 ELSE
 CAD_MAJ_VALEUR_LISTE_RUBJOUR(idrub,dtdeb,NULL,'false','true');
 ROLLBACK;
 END IF;
 END CAD_CONTROLE_SOLDE;
 PROCEDURE CAD_IMPORT(
 p_numseq      IN NUMBER,
 nom_Fichier   IN VARCHAR2,
 avec_Rollback IN VARCHAR2)
 AS
 CURSOR tab
 IS
 SELECT * FROM CAD_TABLE_IMPORT ORDER BY donnees;
 ligne CAD_TABLE_IMPORT%ROWTYPE;
 cpt CAD_COMPTEUR%ROWTYPE;
 TYPE tableau
 IS
 TABLE OF VARCHAR(50);
 tabDonnees tableau :=tableau();
 pos          NUMBER;
 indice       NUMBER;
 subs         VARCHAR(100);
 datemin      VARCHAR(10);
 requete      VARCHAR(4000);
 updatePots   VARCHAR(1000);
 insertCol    VARCHAR(1000);
 insertValue  VARCHAR(1000);
 ligneEnCours VARCHAR(1000);
 numligne     NUMBER;
 numseq       NUMBER;
 newnumseq    number;
 TYPE liste_pot_type
 IS
 TABLE OF NUMBER INDEX BY binary_integer ;
 TYPE strut_pot_type
 IS
 TABLE OF liste_pot_type INDEX BY VARCHAR2(5);
 map_strut_pot strut_pot_type;
 BEGIN
 IF p_numseq IS NULL THEN
 SELECT CAD_SEQ_CALCUL.nextval INTO numseq FROM dual;
 ELSE
 numseq:=p_numseq;
 END IF;
 numligne:=0;
 OPEN tab;
 LOOP
 FETCH tab
 INTO ligne;
 EXIT
 WHEN tab%NOTFOUND ;
 numligne    :=numligne+1;
 ligneEnCours:=ligne.donnees;
 -- Création du tableau de donnees
 indice :=0;
 -- Suppression des espaces
 ligne.donnees:=REPLACE(ligne.donnees,' ','');
 BEGIN
 WHILE LENGTH(ligne.donnees) >0
 LOOP
 indice               :=indice+1;
 pos                  :=instr(ligne.donnees,';');
 IF (pos               >0) THEN
 subs               :=SUBSTR(ligne.donnees,0,pos);
 ligne.donnees      :=SUBSTR(ligne.donnees,LENGTH(subs)+1);
 subs               :=REPLACE(subs,';','');
 IF tabDonnees.last IS NULL OR tabDonnees.last<=indice THEN
 tabDonnees.extend;
 END IF;
 tabDonnees(indice):=subs;
 ELSE
 IF tabDonnees.last IS NULL OR tabDonnees.last<=indice THEN
 tabDonnees.extend;
 END IF;
 tabDonnees(indice):=ligne.donnees;
 ligne.donnees     :='';
 END IF;
 END LOOP;
 IF tabdonnees(1)='1' THEN
 IF datemin   IS NULL OR datemin>tabDonnees(4) THEN
 datemin    :=tabDonnees(4);
 END IF;
 -- si rollback on copie les compteur dans la table temporaire
 IF avec_rollback='true' THEN
 merge INTO CAD_COMPTEUR_FOR_ROLL a USING
 (SELECT *
 FROM CAD_COMPTEUR
 WHERE MATRICULE =tabDonnees(2)
 AND DJOUR      >=tabDonnees(4)
 ) b ON (a.id    =numseq AND a.matricule=b.matricule AND a.code_compteur=b.code_compteur AND a.djour=b.djour AND (a.typemj=b.typemj OR (a.typeMj='M' AND b.typeMj='N') OR (b.typeMj='M' AND a.typeMj='N') ))
 WHEN NOT matched THEN
 INSERT
 (
 a.ID,
 a.MATRICULE,
 a.CODE_COMPTEUR,
 a.DJOUR,
 a.TYPEMJ,
 a.DATE_MAJ,
 a.POT1_VALEURJ,
 a.POT1_VALEURH,
 a.POT1_FJ,
 a.POT1_FH,
 a.POT2_VALEURJ,
 a.POT2_VALEURH,
 a.POT2_FJ,
 a.POT2_FH,
 a.POT3_VALEURJ,
 a.POT3_VALEURH ,
 a.POT3_FJ,
 a.POT3_FH,
 a.POT4_VALEURJ,
 a.POT4_VALEURH,
 a.POT4_FJ,
 a.POT4_FH,
 a.POT5_VALEURJ,
 a.POT5_VALEURH,
 a.POT5_FJ,
 a.POT5_FH,
 a.POT6_VALEURJ,
 a.POT6_VALEURH,
 a.POT6_FJ,
 a.POT6_FH,
 a.POT7_VALEURJ,
 a.POT7_VALEURH,
 a.POT7_FJ ,
 a.POT7_FH,
 a.POT8_VALEURJ,
 a.POT8_VALEURH,
 a.POT8_FJ,
 a.POT8_FH,
 a.POT9_VALEURJ,
 a.POT9_VALEURH,
 a.POT9_FJ,
 a.POT9_FH,
 a.POT10_VALEURJ,
 a.POT10_VALEURH,
 a.POT10_FJ,
 a.POT10_FH,
 a.POT11_VALEURJ,
 a.POT11_VALEURH,
 a.POT11_FJ ,
 a.POT11_FH,
 a.POT12_VALEURJ,
 a.POT12_VALEURH,
 a.POT12_FJ,
 a.POT12_FH,
 a.POTV1_VALEURJ,
 a.POTV1_VALEURH,
 a.POTV2_VALEURJ,
 a.POTV2_VALEURH,
 a.POTV3_VALEURJ,
 a.POTV3_VALEURH,
 a.POTV4_VALEURJ,
 a.POTV4_VALEURH,
 a.POTV5_VALEURJ ,
 a.POTV5_VALEURH,
 a.POTV6_VALEURJ,
 a.POTV6_VALEURH
 )
 VALUES
 (
 numseq,
 b.MATRICULE,
 b.CODE_COMPTEUR,
 b.DJOUR,
 b.TYPEMJ,
 b.DATE_MAJ,
 b.POT1_VALEURJ,
 b.POT1_VALEURH,
 b.POT1_FJ,
 b.POT1_FH,
 b.POT2_VALEURJ,
 b.POT2_VALEURH,
 b.POT2_FJ,
 b.POT2_FH,
 b.POT3_VALEURJ,
 b.POT3_VALEURH ,
 b.POT3_FJ,
 b.POT3_FH,
 b.POT4_VALEURJ,
 b.POT4_VALEURH,
 b.POT4_FJ,
 b.POT4_FH,
 b.POT5_VALEURJ,
 b.POT5_VALEURH,
 b.POT5_FJ,
 b.POT5_FH,
 b.POT6_VALEURJ,
 b.POT6_VALEURH,
 b.POT6_FJ,
 b.POT6_FH,
 b.POT7_VALEURJ,
 b.POT7_VALEURH,
 b.POT7_FJ ,
 b.POT7_FH,
 b.POT8_VALEURJ,
 b.POT8_VALEURH,
 b.POT8_FJ,
 b.POT8_FH,
 b.POT9_VALEURJ,
 b.POT9_VALEURH,
 b.POT9_FJ,
 b.POT9_FH,
 b.POT10_VALEURJ,
 b.POT10_VALEURH,
 b.POT10_FJ,
 b.POT10_FH,
 b.POT11_VALEURJ,
 b.POT11_VALEURH,
 b.POT11_FJ ,
 b.POT11_FH,
 b.POT12_VALEURJ,
 b.POT12_VALEURH,
 b.POT12_FJ,
 b.POT12_FH,
 b.POTV1_VALEURJ,
 b.POTV1_VALEURH,
 b.POTV2_VALEURJ,
 b.POTV2_VALEURH,
 b.POTV3_VALEURJ,
 b.POTV3_VALEURH,
 b.POTV4_VALEURJ,
 b.POTV4_VALEURH,
 b.POTV5_VALEURJ ,
 b.POTV5_VALEURH,
 b.POTV6_VALEURJ,
 b.POTV6_VALEURH
 );
 END IF;
 merge INTO CAD_COMPTEUR_MIN_FOR_ROLL a USING
 (SELECT numseq    AS id,
 tabDonnees(2) AS matricule,
 tabDonnees(4) AS dte
 FROM dual
 )
 b ON (a.id=b.id AND a.matricule=b.matricule)
 WHEN matched THEN
 UPDATE SET a.date_min=b.dte WHERE b.dte<a.date_min WHEN NOT matched THEN
 INSERT
 (a.id,a.matricule,a.date_min
 ) VALUES
 (b.id,b.matricule,b.dte
 );
 
 -- passage de tous les M en N
 UPDATE CAD_COMPTEUR
 SET typemj       ='N'
 WHERE typemj     ='M'
 AND code_compteur=tabDonnees(3)
 AND MATRICULE    =tabDonnees(2)
 AND DJOUR       >=tabDonnees(4);
 -- mise du matricule dans les matricules à retraiter
 merge INTO CAD_CALCUL_EN_COURS_MATRIC a USING
 (SELECT tabDonnees(2) AS matricule, numseq AS id FROM dual
 ) b ON (a.id=b.id AND a.matricule=b.matricule )
 WHEN NOT MATCHED THEN
 INSERT
 ( a.ID, a.MATRICULE
 ) VALUES
 ( numseq, b.matricule
 );
 ELSIF tabdonnees(1)='2' THEN
 IF(NOT map_strut_pot.EXISTS(tabdonnees(3)) ) THEN
 DECLARE
 CURSOR tabpot
 IS
 SELECT *
 FROM CAD_PARAM_STRUCT_POT
 WHERE maj_batch  ='O'
 AND code_compteur=tabdonnees(3)
 ORDER BY num_pot;
 ligne_struct CAD_PARAM_STRUCT_POT%ROWTYPE;
 BEGIN
 OPEN tabpot;
 LOOP
 FETCH tabpot INTO ligne_struct;
 EXIT
 WHEN tabpot%NOTFOUND ;
 map_strut_pot(tabdonnees(3))(ligne_struct.num_pot):=ligne_struct.num_pot;
 END LOOP;
 CLOSE tabpot;
 END;
 END IF;
 updatePots :='';
 insertcol  :='';
 insertvalue:='';
 FOR i IN 1.. map_strut_pot(tabdonnees(3)).last
 LOOP
 updatePots :=updatePots|| ' , a.POT'||i||'_VALEURJ='|| tabdonnees(7+(i-1)*4) ||' , a.POT'||i||'_VALEURH='|| tabdonnees(9+(i-1)*4);
 insertcol  :=insertcol||' , a.POT'||i||'_VALEURJ,a.POT'||i||'_VALEURH';
 insertvalue:=insertvalue||' ,'||tabdonnees(7+(i-1)*4)||' , '||tabdonnees(9+(i-1)*4);
 END LOOP;
 requete:='merge into (select * from cad_compteur where typeMJ in (''M'',''N'') and matricule='''||tabdonnees(2)||''' and code_compteur='''||tabdonnees(3)||''' and djour= '''||tabdonnees(4)||''' ) a using (select '''||tabdonnees(2)||''' as matricule, '''||tabdonnees(3)||''' as code_compteur, '''||tabdonnees(4)||''' as DJOUR from dual ) b on ( a.code_compteur=b.code_compteur and a.matricule =b.matricule and a.djour=b.djour  )';
 requete:=requete||' when matched then update set a.typeMJ=''M'' , a.date_maj=sysdate ';
 requete:=requete||updatePots;
 requete:=requete||' when not matched then insert (a.matricule,a.code_compteur,a.djour,a.typemj,a.date_maj '||insertcol||') ' ;
 requete:=requete||' values (b.matricule,b.code_compteur,b.djour,''M'',sysdate '||insertvalue||')';
 EXECUTE_IMMEDIATE_STRING (requete,0);
 END IF;
 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg  := SQLERRM;
 CAD_ERREUR(numseq ,'IMP'||numligne,numseq||','|| nom_Fichier||','||avec_Rollback||','||tabdonnees(1)||','||tabdonnees(2)||','||tabdonnees(3)||','||tabdonnees(4) ,err_code||'-'||err_msg);
 INSERT
 INTO cad_table_import_err VALUES
 (
 nom_Fichier,
 'Erreur import de la ligne : '
 ||ligneEnCours
 );
 END;
 IF numligne mod 1000 =0 THEN
 COMMIT;
 END IF;
 END LOOP;
 CLOSE tab;
 -- lance calcul
 -- CAD_CALCUL(NULL,numseq, datemin,NULL);
 
 INSERT
 INTO CAD_CALCUL_EN_COURS_IMPORT
 (SELECT * FROM cad_calcul_en_cours_matric WHERE id=numseq
 );
 COMMIT;
 for dte in (select distinct substr(date_min,1,6) as mois from CAD_COMPTEUR_MIN_FOR_ROLL where id=numseq )
 loop
 
 select cad_seq_calcul.nextval into newnumseq from dual;
 INSERT
 INTO CAD_CALCUL_EN_COURS_MATRIC
 (SELECT newnumseq,matricule FROM CAD_COMPTEUR_MIN_FOR_ROLL WHERE id=numseq and substr(date_min,1,6)=dte.mois
 );
 CAD_MAJ_VALEUR_LISTE_RUBJOUR (newnumseq, dte.mois||'01', NULL,'true', 'true');
 COMMIT;
 end loop;
 
 -- CAD_MAJ_VALEUR_LISTE_RUBJOUR (numseq, datemin, NULL,'true', 'true');
 
 /* INSERT
 INTO CAD_CALCUL_EN_COURS_MATRIC
 (SELECT * FROM cad_calcul_en_cours_IMPORT WHERE id=numseq
 );*/
 --  COMMIT;
 DELETE FROM CAD_TABLE_IMPORT;
 DELETE FROM cad_calcul_en_cours_IMPORT WHERE id=numseq;
 COMMIT;
 -- lance calcul
 --  raise_application_error(-20000, 'Problème(s) durant l''import');
 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg  := SQLERRM;
 CAD_ERREUR(numseq ,'CAD_IMPORT'||': FIN',numseq||','|| nom_Fichier||','||avec_Rollback ,err_code||'-'||err_msg);
 raise;
 END CAD_IMPORT;
 FUNCTION              CAD_MAJ_RUB(
 dtdeb               IN VARCHAR2,
 dtfin               IN VARCHAR2,
 ispreviouscad       IN VARCHAR2,
 forcage             IN VARCHAR2,
 id_tab_mat          IN NUMBER)
 RETURN NUMBER
 IS
 nbmat               NUMBER:=0;
 dfin                VARCHAR2(8);
 dateprec            VARCHAR2(8);
 divide              NUMBER:=300;
 nbrub               NUMBER:=0;
 rubrique            BOOLEAN;
 new_id              NUMBER;
 
 BEGIN
 cad_avancement_info(id_tab_mat, id_tab_mat || ' commencé');
 SELECT COUNT (*) INTO nbmat FROM cad_calcul_en_cours_matric WHERE id = id_tab_mat;
 INSERT INTO cad_calcul_en_cours_cpt(id, code_compteur)
 (SELECT DISTINCT id_tab_mat        AS id,
 code_compteur    AS code_compteur
 FROM cad_compteur                cpt,
 cad_calcul_en_cours_matric  cm
 WHERE cpt.matricule    = cm.matricule
 AND  cm.id            = id_tab_mat
 );
 --COMMIT;
 cad_avancement(id_tab_mat, 'Bascules ' || dtdeb);
 cad_init_bascules(id_tab_mat, NULL , dtdeb, dtfin);
 cad_avancement(id_tab_mat, 'Fin Bascules ' || dtdeb);
 
 IF (dtfin IS NOT NULL) THEN
 SELECT COUNT(*) INTO nbrub
 FROM tge_incidents_paie                                           ip,
 cad_calcul_en_cours_matric                                   cm,
 dic_adm_contrat                                              dac,
 -- MONOP DIT 50818
 dic_adm_contrat_situ                                         s ,
 (SELECT DISTINCT (rub_val_jour) FROM cad_param_lien_rub_cpt) lien
 WHERE cm.id                                 = id_tab_mat
 AND dac.NUMPAC                             = s.NUMPAC
 AND dac.PACMAT                             = s.PACMAT
 AND dac.NUMCNT                             = s.NUMCNT
 AND ip.code_ip                             = lien.rub_val_jour
 AND ip.paiezad                             = s.paiezad
 AND cm.matricule                           = dac.matric
 AND ip.idpacmat                            = dac.idpacmat
 AND ip.date_effet                         >= TO_DATE(dtdeb, 'yyyymmdd')
 AND ip.date_effet                         <= TO_DATE(dtfin, 'yyyymmdd')
 AND ip.date_effet BETWEEN dac.dsdcn AND NVL(dac.dsfcn, TO_DATE('20991231', 'yyyymmdd'));
 ELSE
 SELECT COUNT(*) INTO nbrub
 FROM tge_incidents_paie                                           ip,
 cad_calcul_en_cours_matric                                   cm,
 dic_adm_contrat                                              dac,
 -- MONOP DIT 50818
 dic_adm_contrat_situ                                         s ,
 (SELECT DISTINCT (rub_val_jour) FROM cad_param_lien_rub_cpt) lien
 WHERE cm.id                                 = id_tab_mat
 AND dac.NUMPAC                             = s.NUMPAC
 AND dac.PACMAT                             = s.PACMAT
 AND dac.NUMCNT                             = s.NUMCNT
 AND ip.code_ip                             = lien.rub_val_jour
 AND ip.paiezad                             = s.paiezad
 AND cm.matricule                           = dac.matric
 AND ip.idpacmat                            = dac.idpacmat
 AND ip.date_effet                         >= TO_DATE(dtdeb, 'yyyymmdd')
 AND ip.date_effet BETWEEN dac.dsdcn AND NVL(dac.dsfcn, TO_DATE('20991231', 'yyyymmdd'));
 END IF;
 
 IF nbrub > 0 OR ispreviouscad = 'true' THEN
 DECLARE
 CURSOR cur_rub
 IS
 SELECT
 dac.matric          AS matricule,
 ip.code_ip          AS rub_val_jour,
 ip.jour_heures      AS valeur,
 TO_CHAR(ip.date_effet, 'yyyymmdd')       AS date_jour,
 ip.jour_calendaire  AS val_calendaire,
 ip.jour_ouvre       AS val_ouvre,
 ip.jour_ouvrable    AS val_ouvrable,
 ip.jour_oeuvre      AS val_oeuvre
 FROM tge_incidents_paie                                             ip,
 cad_calcul_en_cours_matric                                     cm,
 dic_adm_contrat                                                 dac,
 -- MONOP DIT 50818
 dic_adm_contrat_situ                                            s  ,
 (SELECT DISTINCT (rub_val_jour) FROM cad_param_lien_rub_cpt)    lien
 WHERE cm.id                                 = id_tab_mat
 AND dac.NUMPAC                             = s.NUMPAC
 AND dac.PACMAT                             = s.PACMAT
 AND dac.NUMCNT                             = s.NUMCNT
 AND cm.matricule                           = dac.matric
 AND ip.code_ip                             = lien.rub_val_jour
 AND ip.paiezad                             = s.paiezad
 AND ip.idpacmat                            = dac.idpacmat
 AND ip.date_effet                         >= TO_DATE(dtdeb, 'yyyymmdd')
 AND ip.date_effet BETWEEN dac.dsdcn AND NVL(dac.dsfcn, TO_DATE('20991231', 'yyyymmdd'))
 ORDER BY cm.matricule, ip.date_effet;
 ligne_rub cur_rub%rowtype;
 BEGIN
 cad_mise_a_0_var(id_tab_mat, dtdeb);
 SELECT cad_seq_calcul.nextval INTO new_id FROM dual;
 rubrique := FALSE;
 
 OPEN cur_rub;
 LOOP
 FETCH cur_rub INTO ligne_rub;
 EXIT WHEN cur_rub%notfound;
 IF dateprec IS NULL OR (ligne_rub.date_jour < dateprec) THEN
 dateprec := dtdeb;
 END IF;
 MERGE INTO cad_calcul_en_cours_matric A USING (SELECT new_id AS new_id,ligne_rub.matricule AS matric FROM dual) b ON (A.ID = b.new_id AND A.matricule = b.matric)
 WHEN NOT MATCHED THEN
 INSERT (A.ID, A.matricule) VALUES (b.new_id, b.matric);
 
 rubrique := TRUE;
 IF ligne_rub.rub_val_jour != '_VIDE_' THEN
 cad_avancement(id_tab_mat, 'Début Valorisation rubrique : ' || ligne_rub.rub_val_jour || ' ,matric :' || ligne_rub.matricule || ' ,date:' || ligne_rub.date_jour);
 IF nbmat = 1 THEN
 cad_maj_valeur_rubjour(id_tab_mat, ligne_rub.matricule, dateprec, ligne_rub.date_jour, NVL(ligne_rub.valeur, 0), NVL(ligne_rub.val_calendaire, 0), NVL(ligne_rub.val_ouvrable, 0), NVL(ligne_rub.val_oeuvre, 0), NVL(ligne_rub.val_ouvre, 0), NVL(ligne_rub.rub_val_jour, 0), forcage);
 ELSE
 BEGIN
 cad_maj_valeur_rubjour(id_tab_mat, ligne_rub.matricule, dateprec, ligne_rub.date_jour, NVL(ligne_rub.valeur, 0), NVL(ligne_rub.val_calendaire, 0), NVL(ligne_rub.val_ouvrable, 0), NVL(ligne_rub.val_oeuvre,0), NVL(ligne_rub.val_ouvre, 0), NVL(ligne_rub.rub_val_jour, 0), forcage);
 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg := sqlerrm;
 cad_erreur(id_tab_mat, 'CAD_MAJ_VALEUR_LISTE', ligne_rub.matricule || ',' || ligne_rub.rub_val_jour || ',' || dateprec || ',' || ligne_rub.date_jour, err_code || '-' || err_msg);
 CONTINUE;
 END;
 END IF;
 cad_avancement(id_tab_mat, 'Fin Valorisation rubrique : ' || ligne_rub.rub_val_jour || ' ,matric :' || ligne_rub.matricule || ' ,date:' || ligne_rub.date_jour);
 END IF;
 dateprec := ligne_rub.date_jour;
 END LOOP;
 CLOSE cur_rub;
 
 IF rubrique THEN
 cad_avancement(new_id, 'Bascules ' || dtdeb);
 cad_init_bascules(new_id, NULL, dtdeb, NULL);
 cad_avancement(new_id, 'Fin Bascules ' || dtdeb);
 INSERT INTO cad_calcul_en_cours_cpt(id, code_compteur)
 (SELECT DISTINCT new_id AS id, code_compteur AS code_compteur
 FROM cad_compteur cpt, cad_calcul_en_cours_matric mat
 WHERE cpt.matricule = mat.matricule AND mat.id = new_id
 );
 cad_calcul(NULL, new_id, dtdeb, NULL);
 DELETE FROM cad_calcul_en_cours_rub WHERE id = new_id;
 DELETE FROM cad_calcul_en_cours_cpt WHERE id = new_id;
 DELETE FROM cad_calcul_en_cours_matric WHERE id = new_id;
 END IF;
 
 DELETE FROM cad_calcul_en_cours_rub WHERE id = id_tab_mat;
 DELETE FROM cad_calcul_en_cours_cpt WHERE id = id_tab_mat;
 DELETE FROM cad_calcul_en_cours_matric WHERE id = id_tab_mat;
 
 END;
 END IF;
 cad_avancement_info(id_tab_mat, id_tab_mat || ' terminé');
 IF nbmat > divide THEN
 COMMIT;
 END IF;
 RETURN 0; /* PAS D'ERREUR */
 
 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg := sqlerrm;
 cad_erreur(id_tab_mat, 'CAD_MAJ_RUB', dtdeb || ',' || dtfin || ',' || ispreviouscad || ',' || forcage || ',' || id_tab_mat, err_code || '-' || err_msg);
 RAISE;
 
 END CAD_MAJ_RUB;
 PROCEDURE             CAD_MAJ_VALEUR_LISTE_RUBJOUR(
 idmat               IN NUMBER,
 dtdeb               IN VARCHAR2,
 dtfin               IN VARCHAR2,
 forcage             IN VARCHAR2,
 ispreviouscad       IN VARCHAR2)
 IS
 reqpropagation      VARCHAR2(4000);
 matricprec          VARCHAR2(32);
 nbmat               NUMBER:=0;
 TYPE  typ_tab_id    IS TABLE OF NUMBER;
 tab_id typ_tab_id   :=typ_tab_id();
 new_id              NUMBER;
 nb_newid            NUMBER;
 divide              NUMBER:=300;
 retour              NUMBER;
 cn                  NUMBER;
 BEGIN
 --dbms_profiler.start_profiler;
 BEGIN
 SELECT is_debug INTO valdebug FROM cad_is_debug;
 EXCEPTION
 WHEN OTHERS THEN
 valdebug := 'N';
 END;
 
 -- TAILLE DU TAB_ID A 1/300 IEMES DE LA POPULATION
 SELECT COUNT (*) INTO nbmat FROM cad_calcul_en_cours_matric WHERE id = idmat;
 nb_newid := ROUND(nbmat / divide) + 1;
 tab_id.EXTEND(nb_newid);
 
 -- DECOUPE LA POPULATION PAR TRANCHE DE 1/300 IEMES
 cn := 1;
 WHILE (cn <= nb_newid) --FOR i IN 1..nb_newid
 LOOP
 SELECT cad_seq_calcul.nextval INTO new_id FROM dual;
 tab_id(cn) := new_id;
 INSERT INTO cad_calcul_en_cours_matric
 (SELECT new_id, matricule
 FROM (SELECT matricule, ROWNUM AS rown FROM cad_calcul_en_cours_matric WHERE id = idmat)
 WHERE rown BETWEEN ((cn - 1) * divide) AND cn * divide
 );
 --COMMIT
 cad_avancement_info(new_id, 'Création ID: ' || new_id);
 cn := cn + 1;
 END LOOP;
 
 -- TRAITEMENT POUR CHAQUE TRANCHE
 FOR i IN tab_id.FIRST..tab_id.LAST
 LOOP
 retour := cad_maj_rub(dtdeb, dtfin, ispreviouscad, forcage, tab_id(i));
 END LOOP;
 --dbms_profiler.flush_data;
 --dbms_profiler.stop_profiler;
 DELETE FROM cad_calcul_en_cours_cpt WHERE id = idmat;
 DELETE FROM cad_calcul_en_cours_matric WHERE id = idmat;
 DELETE FROM CAD_COMPTEUR CPT
 WHERE CPT.TYPEMJ in ('B','S')
 AND NOT EXISTS (
    SELECT 1 FROM CAD_REGLES_PREVUES_REALISEES RPR , CAD_PARAM_REGLES_MAJ PRM
    WHERE RPR.CODE_BASCULE = PRM.CODE_BASCULE
		AND CPT.CODE_COMPTEUR in (PRM.COMPTEUR_DEST,PRM.COMPTEUR_ORI)
    AND CPT.DJOUR >= RPR.DATE_THEO_BASCULE
    AND CPT.MATRICULE = RPR.MATRICULE
    AND CPT.TYPEMJ = RPR.TYPE_BASCULE
 )AND CPT.DJOUR >= dtdeb
 AND CPT.MATRICULE = matricule;

 EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg := sqlerrm;
 IF SQLCODE != '-20000' THEN
 DELETE FROM cad_calcul_en_cours_rub WHERE id = idmat;
 DELETE FROM cad_calcul_en_cours_cpt WHERE id = idmat;
 DELETE FROM cad_calcul_en_cours_matric WHERE id = idmat;
 raise_application_error(-20000, 'Problème(s) durant le recalcul des compteurs');
 ELSE
 DELETE FROM cad_calcul_en_cours_rub WHERE id = idmat;
 DELETE FROM cad_calcul_en_cours_cpt WHERE id = idmat;
 DELETE FROM cad_calcul_en_cours_matric WHERE id = idmat;
 RAISE;
 END IF;
 END CAD_MAJ_VALEUR_LISTE_RUBJOUR;
 PROCEDURE CAD_ROLLBACK_IMPORT(
 numseq IN NUMBER)
 AS
 BEGIN
 DELETE
 FROM cad_compteur a
 WHERE matricule IN
 (SELECT CAD_COMPTEUR_MIN_FOR_ROLL.matricule
 FROM CAD_COMPTEUR_MIN_FOR_ROLL
 WHERE id=numseq
 )
 AND djour>=
 (SELECT date_min
 FROM CAD_COMPTEUR_MIN_FOR_ROLL b
 WHERE id       =numseq
 AND a.matricule=b.matricule
 );
 INSERT
 INTO CAD_COMPTEUR
 (SELECT a.MATRICULE,
 a.CODE_COMPTEUR,
 a.DJOUR,
 a.TYPEMJ,
 a.DATE_MAJ,
 a.POT1_VALEURJ,
 a.POT1_VALEURH,
 a.POT1_FJ,
 a.POT1_FH,
 a.POT2_VALEURJ,
 a.POT2_VALEURH,
 a.POT2_FJ,
 a.POT2_FH,
 a.POT3_VALEURJ,
 a.POT3_VALEURH ,
 a.POT3_FJ,
 a.POT3_FH,
 a.POT4_VALEURJ,
 a.POT4_VALEURH,
 a.POT4_FJ,
 a.POT4_FH,
 a.POT5_VALEURJ,
 a.POT5_VALEURH,
 a.POT5_FJ,
 a.POT5_FH,
 a.POT6_VALEURJ,
 a.POT6_VALEURH,
 a.POT6_FJ,
 a.POT6_FH,
 a.POT7_VALEURJ,
 a.POT7_VALEURH,
 a.POT7_FJ ,
 a.POT7_FH,
 a.POT8_VALEURJ,
 a.POT8_VALEURH,
 a.POT8_FJ,
 a.POT8_FH,
 a.POT9_VALEURJ,
 a.POT9_VALEURH,
 a.POT9_FJ,
 a.POT9_FH,
 a.POT10_VALEURJ,
 a.POT10_VALEURH,
 a.POT10_FJ,
 a.POT10_FH,
 a.POT11_VALEURJ,
 a.POT11_VALEURH,
 a.POT11_FJ ,
 a.POT11_FH,
 a.POT12_VALEURJ,
 a.POT12_VALEURH,
 a.POT12_FJ,
 a.POT12_FH,
 a.POTV1_VALEURJ,
 a.POTV1_VALEURH,
 a.POTV2_VALEURJ,
 a.POTV2_VALEURH,
 a.POTV3_VALEURJ,
 a.POTV3_VALEURH,
 a.POTV4_VALEURJ,
 a.POTV4_VALEURH,
 a.POTV5_VALEURJ ,
 a.POTV5_VALEURH,
 a.POTV6_VALEURJ,
 a.POTV6_VALEURH
 FROM cad_compteur_for_roll a
 WHERE id=numseq
 );
 DELETE FROM CAD_COMPTEUR_MIN_FOR_ROLL WHERE id =numseq;
 DELETE FROM cad_compteur_for_roll WHERE id=numseq;
 END CAD_ROLLBACK_IMPORT;
 FUNCTION cad_calcul_date_relative(
 DATE_RELATIVE    IN VARCHAR2,
 DATE_COMPARAISON IN VARCHAR2 )
 RETURN VARCHAR2
 AS
 dte           VARCHAR2(12);
 TYPE tableau IS VARRAY(4) OF VARCHAR2(8);
 tab tableau :=tableau();
 pos        NUMBER;
 indice     NUMBER;
 subs       VARCHAR2(10);
 dteCalc    VARCHAR2(8);
 dtecompare DATE;
 unite      VARCHAR2(1);
 jour       VARCHAR2(2);
 mois       VARCHAR2(3);
 annee      VARCHAR2(4);
 BEGIN
 IF DATE_RELATIVE      IS NOT NULL THEN
 IF date_comparaison IS NULL THEN
 dtecompare        :=sysdate;
 ELSE
 dtecompare:=to_date(date_comparaison,'yyyymmdd');
 END IF;
 dte          :=DATE_RELATIVE;
 IF LENGTH(dte)<8 THEN
 tab.extend;
 tab(1):=dte;
 ELSE
 tab.extend;
 tab(1):=SUBSTR(dte,0,4);
 tab.extend;
 tab(2):=SUBSTR(dte,5);
 tab(2):=SUBSTR( tab(2),0,LENGTH( tab(2))-2);
 tab.extend;
 tab(3):=SUBSTR(dte,LENGTH(dte)-1);
 END IF;
 IF tab.last =3 THEN
 IF tab(3) ='00' THEN
 jour   :=TO_CHAR(dtecompare ,'dd');
 elsif SUBSTR( tab(3),1,1) IN ('L','M','W','J','V','S','D') THEN
 -- on prend le jour minimum possible pour la semaine puis on affinera
 IF SUBSTR( tab(3),2,1)   ='1' THEN
 jour                  :='08';
 elsif SUBSTR( tab(3),2,1)='2' THEN
 jour                  :='15';
 elsif SUBSTR( tab(3),2,1)='3' THEN
 jour                  :='22';
 elsif SUBSTR( tab(3),2,1)='4' THEN
 jour                  :='29';
 END IF;
 ELSE
 jour:=tab(3);
 END IF;
 IF tab(2)                     ='00' THEN
 mois                       :=TO_CHAR(dtecompare ,'mm');
 IF TO_CHAR(dtecompare ,'dd')<jour THEN
 mois                     :=TO_CHAR(add_Months(dtecompare,-1) ,'mm');
 ELSE
 mois:=TO_CHAR(dtecompare,'mm');
 END IF;
 elsif tab(2) LIKE '+%' THEN
 IF TO_CHAR(dtecompare ,'dd')<jour THEN
 mois                     :=TO_CHAR(add_Months(dtecompare,to_number(tab(2))-1) ,'mm');
 ELSE
 mois:=TO_CHAR(add_Months(dtecompare,to_number(tab(2))) ,'mm');
 END IF;
 elsif tab(2) LIKE '-%' THEN
 IF TO_CHAR(dtecompare ,'dd')>=jour THEN
 mois                      :=TO_CHAR(add_Months(dtecompare,to_number(tab(2))) ,'mm');
 ELSE
 mois:=TO_CHAR(add_Months(dtecompare,to_number(tab(2))) ,'mm');
 END IF;
 ELSE
 mois:=tab(2);
 END IF;
 IF tab(1)                       ='0000' THEN
 annee                        := TO_CHAR(dtecompare ,'yyyy');
 IF TO_CHAR(dtecompare ,'mmdd')<mois||jour THEN
 annee                      := TO_CHAR(add_Months(dtecompare,-12) ,'yyyy');
 ELSE
 annee:= TO_CHAR(dtecompare ,'yyyy');
 END IF;
 elsif tab(1) LIKE '+%' THEN
 IF TO_CHAR(dtecompare ,'mmdd')<mois||jour THEN
 annee                      := TO_CHAR(add_Months(dtecompare,12*(to_number(tab(1))-1)) ,'yyyy');
 ELSE
 annee:= TO_CHAR(add_Months(dtecompare,12*(to_number(tab(1)))) ,'yyyy');
 END IF;
 elsif tab(1) LIKE '-%' THEN
 IF TO_CHAR(dtecompare ,'mmdd')>=mois||jour THEN
 annee                       := TO_CHAR(add_Months(dtecompare,12*(to_number(tab(1)))) ,'yyyy');
 ELSE
 annee:= TO_CHAR(add_Months(dtecompare,12*(to_number(tab(1))-1)) ,'yyyy');
 END IF;
 ELSE
 annee:=tab(1);
 END IF;
 IF jour='32' THEN
 jour:=TO_CHAR(last_day(to_date(annee||mois||'01','yyyymmdd')) ,'dd');
 END IF;
 IF SUBSTR( tab(3),0,1) IN ('L','M','W','J','V','S','D') THEN
 jour                         :=CAD_CALCUL_JOUR_SEMAINE(SUBSTR( tab(3),1,1),SUBSTR(tab(3),2,1) ,annee,mois );
 IF tab(2)                     ='00' THEN
 mois                       :=TO_CHAR(dtecompare ,'mm');
 IF TO_CHAR(dtecompare ,'dd')<jour THEN
 mois                     :=TO_CHAR(add_Months(dtecompare,-1) ,'mm');
 ELSE
 mois:=TO_CHAR(dtecompare,'mm');
 END IF;
 elsif tab(2) LIKE '+%' THEN
 IF TO_CHAR(dtecompare ,'dd')<jour THEN
 mois                     :=TO_CHAR(add_Months(dtecompare,to_number(tab(2))-1) ,'mm');
 ELSE
 mois:=TO_CHAR(add_Months(dtecompare,to_number(tab(2))) ,'mm');
 END IF;
 elsif tab(2) LIKE '-%' THEN
 IF TO_CHAR(dtecompare ,'dd')>=jour THEN
 mois                      :=TO_CHAR(add_Months(dtecompare,to_number(tab(2))+1) ,'mm');
 ELSE
 mois:=TO_CHAR(add_Months(dtecompare,to_number(tab(2))) ,'mm');
 END IF;
 ELSE
 mois:=tab(2);
 END IF;
 jour                           :=CAD_CALCUL_JOUR_SEMAINE(SUBSTR( tab(3),0,1),SUBSTR(tab(3),2,1) ,annee,mois );
 IF tab(1)                       ='0000' THEN
 annee                        := TO_CHAR(dtecompare ,'yyyy');
 IF TO_CHAR(dtecompare ,'mmdd')<mois||jour THEN
 annee                      := TO_CHAR(add_Months(dtecompare,-12) ,'yyyy');
 ELSE
 annee:= TO_CHAR(dtecompare ,'yyyy');
 END IF;
 elsif tab(1) LIKE '+%' THEN
 IF TO_CHAR(dtecompare ,'mmdd')<mois||jour THEN
 annee                      := TO_CHAR(add_Months(dtecompare,12*(to_number(tab(1))-1)) ,'yyyy');
 ELSE
 annee:= TO_CHAR(add_Months(dtecompare,12*(to_number(tab(1)))) ,'yyyy');
 END IF;
 elsif tab(1) LIKE '-%' THEN
 IF TO_CHAR(dtecompare ,'mmdd')>mois||jour THEN
 annee                      := TO_CHAR(add_Months(dtecompare,12*(to_number(tab(1)))) ,'yyyy');
 ELSE
 annee:= TO_CHAR(add_Months(dtecompare,12*(to_number(tab(1))-1)) ,'yyyy');
 END IF;
 ELSE
 annee:=tab(1);
 END IF;
 jour:=CAD_CALCUL_JOUR_SEMAINE(SUBSTR( tab(3),0,1),SUBSTR(tab(3),2,1) ,annee,mois );
 END IF;
 dteCalc:=annee||mois||jour;
 ELSE
 IF tab(1) LIKE '+%' OR tab(1) LIKE '-%' THEN
 unite     := SUBSTR(tab(1), LENGTH(tab(1)));
 tab(1)    :=REPLACE(tab(1),unite,'');
 IF unite   ='A' THEN
 dteCalc :=TO_CHAR(add_Months(dtecompare,12*to_number(tab(1))) -to_number(SUBSTR(tab(1),1,1)||'1'),'yyyymmdd');
 elsif unite='M' THEN
 dteCalc :=TO_CHAR(add_Months(dtecompare,to_number(tab(1))) -to_number(SUBSTR(tab(1),1,1)||'1'),'yyyymmdd');
 elsif unite='J' THEN
 dteCalc :=TO_CHAR(dtecompare+to_number(tab(1)) ,'yyyymmdd');
 END IF;
 END IF;
 END IF;
 END IF;
 RETURN dteCalc;
 END cad_calcul_date_relative;
 FUNCTION CAD_CALCUL_DATE_RELATIVE_AV(
 DATE_RELATIVE     IN VARCHAR2,
 DATE_COMPARAISON  IN VARCHAR2,
 DATE_VALIDITE_REL IN VARCHAR2 )
 RETURN VARCHAR2
 AS
 ANNEE_RESOLU  VARCHAR2(10);
 dtevalid      DATE;
 var_annee     VARCHAR2(10);
 reste         VARCHAR2(10);
 DATE_VALIDITE VARCHAR2(8);
 BEGIN
 DATE_VALIDITE                     :=CAD_CALCUL_DATE_RELATIVE(DATE_VALIDITE_REL,DATE_COMPARAISON );
 dtevalid                          :=to_date(DATE_VALIDITE,'yyyymmdd');
 IF instr(upper(DATE_RELATIVE),'AV')>0 THEN
 var_annee                       :=SUBSTR(DATE_RELATIVE,3,2);
 reste                           :=SUBSTR(DATE_RELATIVE,5);
 IF var_annee                     ='00' THEN
 ANNEE_RESOLU                  := TO_CHAR(dtevalid ,'yyyy');
 elsif var_annee LIKE '+%' THEN
 ANNEE_RESOLU:= TO_CHAR(add_Months(dtevalid,12*(to_number(var_annee))) ,'yyyy');
 elsif var_annee LIKE '-%' THEN
 ANNEE_RESOLU:= TO_CHAR(add_Months(dtevalid,12*(to_number(var_annee))) ,'yyyy');
 ELSE
 ANNEE_RESOLU:=TO_CHAR(dtevalid ,'yyyy');
 END IF;
 ANNEE_RESOLU:=ANNEE_RESOLU||reste;
 ELSE
 ANNEE_RESOLU:=DATE_RELATIVE;
 END IF;
 RETURN CAD_CALCUL_DATE_RELATIVE(ANNEE_RESOLU,DATE_COMPARAISON );
 END CAD_CALCUL_DATE_RELATIVE_AV;
 FUNCTION CAD_CALCUL_DATE_REL_AV_FIN(
 DATE_ACQ_FIN   IN VARCHAR2,
 DATE_ACQ_DEBUT IN VARCHAR2,
 DATE_COMPARE   IN VARCHAR2,
 DATE_VAL_DEBUT IN VARCHAR2)
 RETURN VARCHAR2
 AS
 BEGIN
 RETURN CAD_CALCUL_DATE_RELATIVE(DATE_ACQ_FIN,CAD_CALCUL_DATE_RELATIVE_AV(DATE_ACQ_DEBUT,DATE_COMPARE,DATE_VAL_DEBUT) );
 END CAD_CALCUL_DATE_REL_AV_FIN;
 FUNCTION CAD_CALCUL_DATE_RELATIVE_FIN(
 DATE_RELATIVE_FIN   IN VARCHAR2,
 DATE_RELATIVE_DEBUT IN VARCHAR2,
 DATE_COMPARE        IN VARCHAR2 )
 RETURN VARCHAR2
 AS
 BEGIN
 RETURN CAD_CALCUL_DATE_RELATIVE(DATE_RELATIVE_FIN,CAD_CALCUL_DATE_RELATIVE(DATE_RELATIVE_DEBUT,DATE_COMPARE) );
 END CAD_CALCUL_DATE_RELATIVE_FIN;
 FUNCTION cad_formate_date_relative(
 DATE_RELATIVE    IN VARCHAR2,
 DATE_COMPARAISON IN VARCHAR2 )
 RETURN VARCHAR2
 AS
 BEGIN
 RETURN CAD_CALCUL_DATE_RELATIVE(DATE_RELATIVE,DATE_COMPARAISON);
 END cad_formate_date_relative;
 FUNCTION CAD_INTERRO_THEME(
 MATRIC       IN VARCHAR2 ,
 p_CODE_THEME IN VARCHAR2 ,
 p_DJOUR      IN VARCHAR2,
 collectif    IN VARCHAR2,
 finPeriode   IN NUMBER DEFAULT NULL)
 RETURN CAD_RESULTAT_THEME
 AS
 CURSOR cur_items
 IS
 SELECT *
 FROM CAD_THEMES_ITEMS
 WHERE (THEME_PERE =p_CODE_THEME
 OR p_CODE_THEME  IS NULL)
 AND ACTIF         ='O'
 ORDER BY THEME_PERE,
 ordre;
 ligne_items CAD_THEMES_ITEMS%ROWTYPE;
 ligne_lib CAD_THEMES_CPT%ROWTYPE;
 ligne_Date CAD_THEMES_CPT%ROWTYPE;
 ligne_calc CAD_THEMES_CPT%ROWTYPE;
 ligne_cpt CAD_COMPTEUR%ROWTYPE;
 liste_cpt VARCHAR(4000);
 requete CLOB;
 reqSelect CLOB;
 TYPE tableau IS VARRAY(50) OF VARCHAR(50);
 tabCpt tableau       :=tableau();
 col tableau          :=tableau();
 tabPotsParCpt tableau:=tableau();
 tabPots tableau      :=tableau();
 posVir   NUMBER;
 indice   NUMBER;
 indice2  NUMBER;
 subs     VARCHAR(50);
 tmp      NUMBER;
 tmpRes   NUMBER;
 elt      VARCHAR(50);
 numLigne NUMBER;
 retour CAD_RESULTAT_THEME:=CAD_RESULTAT_THEME();
 dateinterro     VARCHAR(8);
 unite           VARCHAR(1);
 numDonnee       NUMBER;
 theme_pere_prec VARCHAR(20);
 numpot          NUMBER;
 numpotV         NUMBER;
 dad             VARCHAR(10);
 daf             VARCHAR(10);
 dvd             VARCHAR(10);
 dvf             VARCHAR(10);
 dtcalc          VARCHAR(12);
 dteoucp         VARCHAR(12);
 typeEcran       VARCHAR(1);
 trouve          INT;
 nb_clauseselect INT;
 valdebug        VARCHAR2(1);
 format          VARCHAR(4);
 deb             NUMBER;
 fin             NUMBER;
 total           NUMBER:=0;
 dateRequested   VARCHAR(8);
 BEGIN
 SELECT format_heure INTO format FROM CAD_THEMES WHERE code_theme=p_CODE_THEME;
 BEGIN
 SELECT is_debug INTO valdebug FROM CAD_IS_DEBUG;
 EXCEPTION
 WHEN OTHERS THEN
 valdebug:='N';
 END;
 IF collectif='O' THEN
 typeEcran:='C';
 ELSE
 typeEcran:='I';
 END IF;
 numDonnee:=0;
 OPEN cur_items;
 LOOP
 FETCH cur_items INTO ligne_items;
 EXIT
 WHEN cur_items%NOTFOUND ;
 -- si non actif on passe à la ligne suivante
 --  IF ligne_items.actif='N' THEN CONTINUE; END IF;
 IF theme_pere_prec IS NULL OR theme_pere_prec <>ligne_items.theme_pere THEN
 numDonnee        :=numDonnee+1;
 retour.extend;
 retour(numDonnee)           :=CAD_LIGNE_RESULTAT_THEME(NULL,NULL,NULL,NULL,NULL);
 retour(numDonnee).matricule :=matric;
 retour(numDonnee).CODE_THEME:= ligne_items.theme_pere;
 retour(numDonnee).code_item :=ligne_items.code_item;
 retour(numDonnee).lib_item  :=ligne_items.LIBELLE;
 END IF;
 -- Récupération des dates si il y en a
 DECLARE
 CURSOR cur_items_Date
 IS
 SELECT *
 FROM CAD_THEMES_CPT a
 WHERE code   = ligne_items.theme_pere
 AND ( (type  ='L'
 AND typeecran='I')
 OR (typeecran='C'
 AND (type    ='LC'
 OR ( type    ='L'
 AND NOT EXISTS
 (SELECT NULL
 FROM CAD_THEMES_CPT cpt
 WHERE cpt.code=a.code
 AND cpt.type  ='LC'
 AND cpt.ordre =a.ordre
 ) )) ))
 AND calcul LIKE ('D%')
 ORDER BY ordre;
 BEGIN
 OPEN cur_items_date;
 LOOP
 FETCH cur_items_date INTO ligne_date;
 EXIT
 WHEN cur_items_date%NOTFOUND ;
 BEGIN
 -- calcul date
 SELECT LIB_CPT_POT
 INTO dteoucp
 FROM CAD_THEMES_CPT a
 WHERE code   = ligne_items.code_item
 AND ( (type  ='V'
 AND typeecran='I')
 OR (typeecran='C'
 AND (type    ='VC'
 OR ( type    ='V'
 AND NOT EXISTS
 (SELECT NULL
 FROM CAD_THEMES_CPT cpt
 WHERE cpt.code=a.code
 AND cpt.type  ='VC'
 AND cpt.ordre =a.ordre
 ) )) ))
 AND ordre         =ligne_date.ordre;
 -- on demande à fin de periode
 IF finPeriode IS NOT NULL THEN
 SELECT DATE_FIN_PER
 INTO dateRequested
 FROM CAD_MATRIC_DATEVALID a
 WHERE matricule  =matric
 AND code_compteur=dteoucp
 AND a.DATE_EFFET =
 (SELECT MAX(date_effet)
 FROM cad_matric_datevalid b
 WHERE b.date_effet<= p_DJOUR
 AND a.code_compteur=b.code_compteur
 AND a.matricule    =b.matricule
 );
 ELSE
 dateRequested:=p_DJOUR;
 END IF;	
 IF LENGTH(dteoucp)>5 THEN
 dtcalc         :=cad_calcul_date_relative(dteoucp,NULL);
 ELSE
 BEGIN
 IF ligne_date.calcul ='DAD' THEN
 SELECT DATE_DEB_ACQUIS
 INTO dtcalc
 FROM CAD_MATRIC_DATEVALID a
 WHERE matricule  =matric
 AND code_compteur=dteoucp
 AND a.DATE_EFFET =
 (SELECT MAX(date_effet)
 FROM cad_matric_datevalid b
 WHERE b.date_effet<= dateRequested
 AND a.code_compteur=b.code_compteur
 AND a.matricule    =b.matricule
 );
 elsif ligne_date.calcul ='DAF' THEN
 SELECT DATE_FIN_ACQUIS
 INTO dtcalc
 FROM CAD_MATRIC_DATEVALID a
 WHERE matricule  =matric
 AND code_compteur=dteoucp
 AND a.DATE_EFFET =
 (SELECT MAX(date_effet)
 FROM cad_matric_datevalid b
 WHERE b.date_effet<= dateRequested
 AND a.code_compteur=b.code_compteur
 AND a.matricule    =b.matricule
 );
 elsif ligne_date.calcul ='DVD' THEN
 SELECT DATE_DEB_PER
 INTO dtcalc
 FROM CAD_MATRIC_DATEVALID a
 WHERE matricule  =matric
 AND code_compteur=dteoucp
 AND a.DATE_EFFET =
 (SELECT MAX(date_effet)
 FROM cad_matric_datevalid b
 WHERE b.date_effet<= dateRequested
 AND a.code_compteur=b.code_compteur
 AND a.matricule    =b.matricule
 );
 elsif ligne_date.calcul ='DVF' THEN
 SELECT DATE_FIN_PER
 INTO dtcalc
 FROM CAD_MATRIC_DATEVALID a
 WHERE matricule  =matric
 AND code_compteur=dteoucp
 AND a.DATE_EFFET =
 (SELECT MAX(date_effet)
 FROM cad_matric_datevalid b
 WHERE b.date_effet<= dateRequested
 AND a.code_compteur=b.code_compteur
 AND a.matricule    =b.matricule
 );
 END IF;
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 IF ligne_date.calcul ='DAD' THEN
 SELECT CAD_CALCUL_DATE_RELATIVE(DATE_DEB_ACQUIS, dateRequested)
 INTO dtcalc
 FROM CAD_PARAM_STRUCT_CPT a
 WHERE code_compteur   =dteoucp;
 elsif ligne_date.calcul ='DAF' THEN
 SELECT CAD_CALCUL_DATE_RELATIVE(DATE_FIN_ACQUIS, dateRequested)
 INTO dtcalc
 FROM CAD_PARAM_STRUCT_CPT a
 WHERE code_compteur   =dteoucp;
 elsif ligne_date.calcul ='DVD' THEN
 SELECT CAD_CALCUL_DATE_RELATIVE(DTDEB_PERIODE, dateRequested)
 INTO dtcalc
 FROM CAD_PARAM_STRUCT_CPT a
 WHERE code_compteur   =dteoucp;
 elsif ligne_date.calcul ='DVF' THEN
 SELECT CAD_CALCUL_DATE_RELATIVE(DTFIN_PERIODE, dateRequested)
 INTO dtcalc
 FROM CAD_PARAM_STRUCT_CPT a
 WHERE code_compteur=dteoucp;
 END IF;
 END;
 END IF;
 IF ligne_date.calcul    ='DAD' THEN
 dad                  :=dtcalc;
 elsif ligne_date.calcul ='DAF' THEN
 daf                  :=dtcalc;
 elsif ligne_date.calcul ='DVD' THEN
 dvd                  :=dtcalc;
 elsif ligne_date.calcul ='DVF' THEN
 dvf                  :=dtcalc;
 END IF;
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 NULL;
 END;
 END LOOP;
 CLOSE cur_items_date;
 -- récupération des compteurs à utiliser pour l'item (ordre 0, type V)
 SELECT LIB_CPT_POT
 INTO liste_cpt
 FROM CAD_THEMES_CPT a
 WHERE code =ligne_items.code_item
 AND ordre  =0
 AND type   ='V';
 --  AND ( (type  ='V'
 --  AND typeecran='I')
 -- OR (typeecran='C'
 --  AND (type    ='VC'
 --  OR ( type    ='V'
 -- AND NOT EXISTS
 --   (SELECT NULL
 --   FROM CAD_THEMES_CPT cpt
 --   WHERE cpt.code=a.code
 --   AND cpt.type  ='VC'
 --   AND cpt.ordre =a.ordre
 --   ) )) ));
 indice                 :=0;
 tabcpt                 :=tableau();
 WHILE LENGTH(liste_cpt) >0
 LOOP
 indice      :=indice+1;
 posVir      :=instr(liste_cpt,',');
 IF (posVir   >0) THEN
 subs      :=SUBSTR(liste_cpt,0,posVir);
 liste_cpt :=SUBSTR(liste_cpt,posVir+1);
 subs      :=REPLACE(subs,',','');
 tabcpt.extend;
 tabcpt(indice):=subs;
 ELSE
 tabcpt.extend;
 tabcpt(indice):=liste_cpt;
 liste_cpt     :='';
 END IF;
 END LOOP;
 END;
 DECLARE
 CURSOR cur_lib
 IS
 SELECT *
 FROM CAD_THEMES_CPT a
 WHERE code   =ligne_items.theme_pere
 AND ( (type  ='L'
 AND typeecran='I')
 OR (typeecran='C'
 AND (type    ='LC'
 OR ( type    ='L'
 AND NOT EXISTS
 (SELECT NULL
 FROM CAD_THEMES_CPT cpt
 WHERE cpt.code=a.code
 AND cpt.type  ='LC'
 AND cpt.ordre =a.ordre
 ) )) ))
 ORDER BY ordre;
 BEGIN
 col:=tableau();
 OPEN cur_lib;
 LOOP
 FETCH cur_lib INTO ligne_lib;
 EXIT
 WHEN cur_lib%NOTFOUND ;
 BEGIN
 -- récupération des pots à utiliser pour chaque compteur
 SELECT *
 INTO ligne_calc
 FROM CAD_THEMES_CPT a
 WHERE code   =ligne_items.code_item
 AND ordre    =ligne_lib.ordre
 AND ( (type  ='V'
 AND typeecran='I')
 OR (typeecran='C'
 AND (type    ='VC'
 OR ( type    ='V'
 AND NOT EXISTS
 (SELECT NULL
 FROM CAD_THEMES_CPT cpt
 WHERE cpt.code=a.code
 AND cpt.type  ='VC'
 AND cpt.ordre =a.ordre
 ) )) ));
 requete                               :='';
 reqselect                             :='';
 elt                                   :='';
 IF ligne_lib.CALCUL                    ='R' OR ligne_lib.CALCUL='P' OR ligne_lib.CALCUL='VP' THEN
 deb                                 := DBMS_UTILITY.get_time;
 indice                              :=0;
 tabPotsParCpt                       :=tableau();
 WHILE LENGTH(ligne_calc.LIB_CPT_POT) >0
 LOOP
 indice                   :=indice+1;
 posVir                   :=instr(ligne_calc.LIB_CPT_POT,',');
 IF (posVir                >0) THEN
 subs                   :=SUBSTR(ligne_calc.LIB_CPT_POT,0,posVir);
 ligne_calc.LIB_CPT_POT :=SUBSTR(ligne_calc.LIB_CPT_POT,posVir+1);
 subs                   :=REPLACE(subs,',','');
 tabPotsParCpt.extend;
 tabPotsParCpt(indice) :=subs;
 ELSE
 tabPotsParCpt.extend;
 tabPotsParCpt(indice)  :=ligne_calc.LIB_CPT_POT;
 ligne_calc.LIB_CPT_POT :='';
 END IF;
 END LOOP;
 -- Ecriture des requetes
 nb_clauseselect:=0;
 tmp            :=0;
 FOR i IN 1..indice
 LOOP
 tmpres                        :=0;
 indice2                       :=0;
 tabPots                       :=tableau();
 trouve                        :=0;
 WHILE LENGTH(tabPotsParCpt(i)) >0
 LOOP
 trouve             :=1;
 indice2            :=indice2+1;
 posVir             :=instr(tabPotsParCpt(i),'^');
 IF (posVir          >0) THEN
 subs             :=SUBSTR(tabPotsParCpt(i),0,posVir);
 tabPotsParCpt(i) :=SUBSTR(tabPotsParCpt(i),posVir+1);
 subs             :=REPLACE(subs,'^','');
 tabPots.extend;
 tabPots(indice2) :=subs;
 ELSE
 tabPots.extend;
 tabPots(indice2) :=tabPotsParCpt(i);
 tabPotsParCpt(i) :='';
 END IF;
 END LOOP;
 IF trouve =0 THEN
 CONTINUE;
 END IF;
 IF nb_clauseselect <=1 THEN
 unite            :=cad_unite_cpt(matric, dateRequested,tabcpt(i));
 END IF;
 IF ligne_lib.CALCUL   ='R' THEN
 dateinterro        := dateRequested;
 elsif ligne_lib.CALCUL='P' THEN
 -- récuperer date fin valid
 dateinterro        :=dvf;
 elsif ligne_lib.CALCUL='VP' THEN
 -- récuperer date fin valid
 dateinterro:=dvf;
 END IF;
 IF ligne_lib.CALCUL='R' OR ligne_lib.CALCUL='P' THEN
 BEGIN
 --select *  INTO ligne_cpt from (select * from CAD_COMPTEUR where code_compteur=tabcpt(i) and matricule =matric and djour <=dateinterro order by djour desc,typemj desc) where rownum=1;
 -- select *   INTO ligne_cpt from CAD_COMPTEUR a where code_compteur=tabcpt(i) and matricule =matric and djour||typemj=( select max(b.djour||b.typemj)   from CAD_COMPTEUR b where b.code_compteur=a.code_compteur and b.matricule =a.matricule and b.djour <=dateinterro );
 SELECT MATRICULE,
 CODE_COMPTEUR,
 DJOUR,
 TYPEMJ,
 DATE_MAJ,
 POT1_VALEURJ,
 POT1_VALEURH,
 POT1_FJ,
 POT1_FH,
 POT2_VALEURJ ,
 POT2_VALEURH ,
 POT2_FJ ,
 POT2_FH ,
 POT3_VALEURJ ,
 POT3_VALEURH ,
 POT3_FJ ,
 POT3_FH ,
 POT4_VALEURJ ,
 POT4_VALEURH ,
 POT4_FJ ,
 POT4_FH ,
 POT5_VALEURJ ,
 POT5_VALEURH ,
 POT5_FJ ,
 POT5_FH ,
 POT6_VALEURJ ,
 POT6_VALEURH ,
 POT6_FJ ,
 POT6_FH ,
 POT7_VALEURJ ,
 POT7_VALEURH ,
 POT7_FJ ,
 POT7_FH ,
 POT8_VALEURJ ,
 POT8_VALEURH ,
 POT8_FJ ,
 POT8_FH ,
 POT9_VALEURJ ,
 POT9_VALEURH ,
 POT9_FJ ,
 POT9_FH ,
 POT10_VALEURJ ,
 POT10_VALEURH ,
 POT10_FJ ,
 POT10_FH ,
 POT11_VALEURJ ,
 POT11_VALEURH ,
 POT11_FJ ,
 POT11_FH ,
 POT12_VALEURJ ,
 POT12_VALEURH ,
 POT12_FJ ,
 POT12_FH ,
 POTV1_VALEURJ ,
 POTV1_VALEURH ,
 POTV2_VALEURJ ,
 POTV2_VALEURH ,
 POTV3_VALEURJ ,
 POTV3_VALEURH ,
 POTV4_VALEURJ ,
 POTV4_VALEURH ,
 POTV5_VALEURJ ,
 POTV5_VALEURH ,
 POTV6_VALEURJ ,
 POTV6_VALEURH
 INTO ligne_cpt
 FROM
 (SELECT a.*,
 rank() over(order by djour DESC,typemj DESC) rn
 FROM CAD_COMPTEUR a
 WHERE code_compteur=tabcpt(i)
 AND matricule      =matric
 AND djour         <=dateinterro
 )
 WHERE rn=1;
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 CONTINUE;
 WHEN OTHERS THEN
 raise;
 END;
 elsif ligne_lib.CALCUL='VP' THEN
 BEGIN
 SELECT NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 NULL,
 SUM(NVL(POTV1_VALEURj,0)) AS POTV1_VALEURj,
 SUM(NVL(POTV1_VALEURh,0)) AS POTV1_VALEUh,
 SUM(NVL(POTV2_VALEURj,0)) AS POTV2_VALEURj,
 SUM(NVL(POTV2_VALEURh,0)) AS POTV2_VALEURh,
 SUM(NVL(POTV3_VALEURj,0)) AS POTV3_VALEURj,
 SUM(NVL(POTV3_VALEURh,0)) AS POTV3_VALEURh,
 SUM(NVL(POTV4_VALEURj,0)) AS POTV4_VALEURj,
 SUM(NVL(POTV4_VALEURh,0)) AS POTV4_VALEURh,
 SUM(NVL(POTV5_VALEURj,0)) AS POTV5_VALEURj,
 SUM(NVL(POTV5_VALEURh,0)) AS POTV5_VALEURh,
 SUM(NVL(POTV6_VALEURj,0)) AS POTV6_VALEURj,
 SUM(NVL(POTV6_VALEURh,0)) AS POTV6_VALEURh
 INTO ligne_cpt
 FROM
 (SELECT *
 FROM CAD_COMPTEUR
 WHERE code_compteur=tabcpt(i)
 AND matricule      =matric
 AND djour         <=dateinterro
 AND djour          > dateRequested
 );
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 CONTINUE;
 WHEN OTHERS THEN
 raise;
 END;
 END IF;
 FOR j IN 1..indice2
 LOOP
 tmpres            :=0;
 IF ligne_lib.CALCUL='R' OR ligne_lib.CALCUL='P' THEN
 IF tabpots(j)    ='POT1' THEN
 IF (unite      ='H') THEN
 tmpRes      :=NVL(ligne_cpt.POT1_Fh,NVL(ligne_cpt.POT1_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT1_Fj,NVL(ligne_cpt.POT1_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT2' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT2_Fh,NVL(ligne_cpt.POT2_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT2_Fj,NVL(ligne_cpt.POT2_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT3' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT3_Fh,NVL(ligne_cpt.POT3_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT3_Fj,NVL(ligne_cpt.POT3_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT4' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT4_Fh,NVL(ligne_cpt.POT4_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT4_Fj,NVL(ligne_cpt.POT4_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT5' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT5_Fh,NVL(ligne_cpt.POT5_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT5_Fj,NVL(ligne_cpt.POT5_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT6' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT6_Fh,NVL(ligne_cpt.POT6_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT6_Fj,NVL(ligne_cpt.POT6_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT7' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT7_Fh,NVL(ligne_cpt.POT7_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT7_Fj,NVL(ligne_cpt.POT7_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT8' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT8_Fh,NVL(ligne_cpt.POT8_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT8_Fj,NVL(ligne_cpt.POT8_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT9' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT9_Fh,NVL(ligne_cpt.POT9_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT9_Fj,NVL(ligne_cpt.POT9_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT10' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT10_Fh,NVL(ligne_cpt.POT10_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT10_Fj,NVL(ligne_cpt.POT10_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT11' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT11_Fh,NVL(ligne_cpt.POT11_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT11_Fj,NVL(ligne_cpt.POT11_VALEURj,0));
 END IF;
 elsif tabpots(j)='POT12' THEN
 IF (unite     ='H') THEN
 tmpRes     :=NVL(ligne_cpt.POT12_Fh,NVL(ligne_cpt.POT12_VALEURh,0));
 ELSE
 tmpRes:=NVL(ligne_cpt.POT12_Fj,NVL(ligne_cpt.POT12_VALEURj,0));
 END IF;
 END IF;
 elsif ligne_lib.CALCUL='VP' THEN
 numpot             :=REPLACE(tabpots(j),'POT','');
 SELECT numpot_var
 INTO numpotV
 FROM
 (SELECT
 CASE
 WHEN potv1=numpot
 THEN 1
 WHEN potv2=numpot
 THEN 2
 WHEN potv3=numpot
 THEN 3
 WHEN potv4=numpot
 THEN 4
 WHEN potv5=numpot
 THEN 5
 WHEN potv6=numpot
 THEN 6
 END AS numpot_var
 FROM cad_param_calcul
 WHERE code_compteur=tabcpt(i)
 );
 IF numpotV  =1 THEN
 IF (unite ='H') THEN
 tmpRes :=NVL(ligne_cpt.POTV1_VALEURh,0);
 ELSE
 tmpRes:=NVL(ligne_cpt.POTV1_VALEURj,0);
 END IF;
 elsif numpotV=2 THEN
 IF (unite  ='H') THEN
 tmpRes  :=NVL(ligne_cpt.POTV2_VALEURh,0);
 ELSE
 tmpRes:=NVL(ligne_cpt.POTV2_VALEURj,0);
 END IF;
 elsif numpotV=3 THEN
 IF (unite  ='H') THEN
 tmpRes  :=NVL(ligne_cpt.POTV3_VALEURh,0);
 ELSE
 tmpRes:=NVL(ligne_cpt.POTV3_VALEURj,0);
 END IF;
 elsif numpotV=4 THEN
 IF (unite  ='H') THEN
 tmpRes  :=NVL(ligne_cpt.POTV4_VALEURh,0);
 ELSE
 tmpRes:=NVL(ligne_cpt.POTV4_VALEURj,0);
 END IF;
 elsif numpotV=5 THEN
 IF (unite  ='H') THEN
 tmpRes  :=NVL(ligne_cpt.POTV5_VALEURh,0);
 ELSE
 tmpRes:=NVL(ligne_cpt.POTV5_VALEURj,0);
 END IF;
 elsif numpotV=6 THEN
 IF (unite  ='H') THEN
 tmpRes  :=NVL(ligne_cpt.POTV6_VALEURh,0);
 ELSE
 tmpRes:=NVL(ligne_cpt.POTV6_VALEURj,0);
 END IF;
 END IF;
 END IF;
 tmp:=tmp+tmpRes;
 END LOOP;
 END LOOP;
 IF tmp>0 AND tmp<1 THEN
 elt:='0'||tmp;
 elsif tmp>-1 AND tmp<0 THEN
 elt:=tmp;
 if INSTR(elt, '-,') = 1 then
 elt := '-0,' || SUBSTR( elt, 3 );
 end if;
 ELSE
 elt:=tmp;
 END IF;
 fin  := DBMS_UTILITY.get_time;
 total:=total+(fin-deb);
 --DBMS_OUTPUT.put_line('Type R,P,VP '||total);
 --FIXME utiliser la procédure trace_dbms_output()
 elsif ligne_lib.CALCUL='U' THEN
 elt                :=unite;
 elsif ligne_lib.CALCUL='DVD' THEN
 elt                :=dvd;
 elsif ligne_lib.CALCUL='DVF' THEN
 elt                :=dvf;
 elsif ligne_lib.CALCUL='DAD' THEN
 elt                :=dad;
 elsif ligne_lib.CALCUL='DAF' THEN
 elt                :=daf;
 elsif ligne_lib.CALCUL='COL' THEN
 deb                := DBMS_UTILITY.get_time;
 FOR l IN reverse 1..col.count
 LOOP
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT, 'C'||l,'to_number('''||NVL(col(l),0)||''')');
 END LOOP;
 EXECUTE immediate ( 'select '||ligne_calc.LIB_CPT_POT||' from dual') INTO tmp;
 IF tmp>0 AND tmp<1 THEN
 elt:='0'||tmp;
 elsif tmp>-1 AND tmp<0 THEN
 elt:=tmp;
 if INSTR(elt, '-,') = 1 then
 elt := '-0,' || SUBSTR( elt, 3 );
 end if;
 ELSE
 elt:=tmp;
 END IF;
 fin  := DBMS_UTILITY.get_time;
 total:=total+(fin-deb);
 --DBMS_OUTPUT.put_line('Type COL '||total);
 --FIXME utiliser la procédure trace_dbms_output()
 elsif ligne_lib.CALCUL='C' THEN
 deb                := DBMS_UTILITY.get_time;
 FOR i IN 1..indice
 LOOP
 -- récuperer les valeurs des pots pour chaque compteur
 SELECT *
 INTO ligne_cpt
 FROM
 (SELECT *
 FROM CAD_COMPTEUR
 WHERE code_compteur=tabcpt(i)
 AND matricule      =matric
 AND djour         <=dateinterro
 ORDER BY djour DESC,
 typemj DESC
 )
 WHERE rownum=1;
 --EXECUTE immediate requete INTO ligne_cpt;
 -- remplacer les pots
 IF unite                  ='H' THEN
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT12',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT12_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT11',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT11_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT10',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT10_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT9',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT9_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT8',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT8_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT7',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT7_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT6',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT6_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT5',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT5_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT4',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT4_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT3',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT3_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT2',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT2_VALEURH,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT1',NVL(ligne_cpt.POT1_FH,NVL(ligne_cpt.POT1_VALEURH,0)));
 ELSE
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT12',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT12_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT11',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT11_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT10',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT10_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT9',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT9_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT8',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT8_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT7',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT7_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT6',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT6_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT5',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT5_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT4',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT4_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT3',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT3_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT2',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT2_VALEURJ,0)));
 ligne_calc.LIB_CPT_POT :=REPLACE( ligne_calc.LIB_CPT_POT,tabcpt(i)||'.POT1',NVL(ligne_cpt.POT1_FJ,NVL(ligne_cpt.POT1_VALEURJ,0)));
 END IF;
 END LOOP;
 EXECUTE immediate ( 'select '||ligne_calc.LIB_CPT_POT||' from dual') INTO tmp;
 IF tmp>0 AND tmp<1 THEN
 elt:='0'||tmp;
 elsif tmp>-1 AND tmp<0 THEN
 elt:=tmp;
 if INSTR(elt, '-,') = 1 then
 elt := '-0,' || SUBSTR( elt, 3 );
 end if;
 ELSE
 elt:=tmp;
 END IF;
 fin  := DBMS_UTILITY.get_time;
 total:=total+(fin-deb);
 --DBMS_OUTPUT.put_line('Type C'||total);
 --FIXME utiliser la procédure trace_dbms_output()
 END IF;
 deb                        := DBMS_UTILITY.get_time;
 IF ligne_lib.NON_AFFICHAGE IS NOT NULL AND cad_condition_non_aff( dateRequested,ligne_lib.CALCUL,ligne_lib.NON_AFFICHAGE,elt)=1 THEN
 retour.delete(numDonnee);
 EXIT;
 END IF;
 col.extend;
 col(ligne_lib.ordre) :=elt;
 IF (unite             ='H' AND ligne_lib.CALCUL IN ('C','COL','R','P','VP')) THEN
 IF format           ='HHMM' THEN
 -- en HHMM
 elt      :=conversionSecondesHHMM(elt);
 elsif format='HC' THEN
 -- en HHCC
 elt:=conversionSecondesHHCC(elt);
 END IF;
 elsif ligne_lib.CALCUL IN ('C','COL','R','P','VP') AND elt IS NULL THEN
 elt                                                      :='0';
 END IF;
 IF ligne_calc.ordre           =1 THEN
 retour(numDonnee).RESULTAT :=NVL(elt,'');
 ELSE
 retour(numDonnee).RESULTAT :=NVL(retour(numDonnee).RESULTAT,'')||'^'||NVL(elt,'');
 END IF;
 fin  := DBMS_UTILITY.get_time;
 total:=total+(fin-deb);
 --DBMS_OUTPUT.put_line('Ajout donnée'||total);
 --FIXME utiliser la procédure trace_dbms_output()
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 IF ligne_calc.ordre           =1 THEN
 retour(numDonnee).RESULTAT :='';
 ELSE
 retour(numDonnee).RESULTAT :=NVL(retour(numDonnee).RESULTAT,'')||'^'||'';
 END IF;
 col.extend;
 END;
 END LOOP;
 CLOSE cur_lib;
 END;
 END LOOP;
 CLOSE cur_items;
 FOR i in retour.first .. retour.last LOOP
   IF retour(i).RESULTAT LIKE '%^^%' OR retour(i).RESULTAT LIKE '^%' OR retour(i).RESULTAT LIKE '%^' THEN
     retour.delete(i);
   END IF;
 END LOOP;
 RETURN retour;
 END CAD_INTERRO_THEME;
 FUNCTION CAD_INTERRO_THEME_COLL(
 idPop      IN NUMBER ,
 CODE_THEME IN VARCHAR2 ,
 DJOUR      IN VARCHAR2,
 collectif  IN VARCHAR2)
 RETURN CAD_RESULTAT_THEME
 AS
 CURSOR cur_pop
 IS
 SELECT * FROM REQ_POPULATION WHERE num=idPop;
 ligne_pop REQ_POPULATION%ROWTYPE;
 retour CAD_RESULTAT_THEME:=CAD_RESULTAT_THEME();
 tmp CAD_RESULTAT_THEME   :=CAD_RESULTAT_THEME();
 i binary_integer ;
 dernier binary_integer ;
 BEGIN
 OPEN cur_pop;
 LOOP
 FETCH cur_pop INTO ligne_pop;
 EXIT
 WHEN cur_pop%NOTFOUND ;
 tmp     :=CAD_INTERRO_THEME(ligne_pop.matric,code_theme,djour,'O') ;
 i       := tmp.first ;
 WHILE i IS NOT NULL
 LOOP
 dernier:=NVL(retour.last,0);
 retour.extend;
 retour(dernier+1):=tmp(i);
 i                := tmp.next(i) ;
 END LOOP;
 END LOOP;
 CLOSE cur_pop;
 RETURN retour;
 END CAD_INTERRO_THEME_COLL;
 FUNCTION CAD_SOLDE(
 MATRIC   IN VARCHAR2 ,
 DATEJOUR IN VARCHAR2 ,
 RUB      IN VARCHAR2 )
 RETURN NUMBER
 AS
 CURSOR cur_cpt
 IS
 SELECT code_compteur,
 pot_solde,
 pot_variation,
 min_soldej,
 min_soldeh,
 ordre
 FROM CAD_PARAM_LIEN_RUB_CPT
 WHERE RUB_VAL_JOUR =rub
 ORDER BY ordre;
 ligne_cpt cur_cpt%ROWTYPE;
 retour NUMBER:=0;
 req    VARCHAR(1000);
 unite  VARCHAR(1);
 valcpt NUMBER;
 BEGIN
 unite:= cad_unite(matric,datejour,rub);
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO ligne_cpt;
 EXIT
 WHEN cur_cpt%NOTFOUND ;
 req    :='select * from (select ';
 IF unite='H' THEN
 req  :=req||'nvl(POT'||ligne_cpt.pot_solde||'_FH,nvl(POT'||ligne_cpt.pot_solde||'_VALEURH,0))';
 ELSE
 req:=req||'nvl(POT'||ligne_cpt.pot_solde||'_FJ,nvl(POT'||ligne_cpt.pot_solde||'_VALEURJ,0))';
 END IF;
 req:=req||' from CAD_COMPTEUR where code_compteur=:cpt and matricule =:matric and djour <=:datejour order by djour desc,typemj desc) where rownum=1';
 BEGIN
 EXECUTE IMMEDIATE req INTO valcpt USING ligne_cpt.code_compteur,
 matric,
 datejour ;
 EXCEPTION
 WHEN NO_DATA_FOUND THEN
 valcpt:=0;
 END;
 retour:=retour+valcpt;
 END LOOP;
 CLOSE cur_cpt;
 RETURN retour;
 END CAD_SOLDE;
 PROCEDURE CAD_BASCULE_UNIQUE(
 IDMATRIC    IN NUMBER ,
 BASCULE     IN VARCHAR2 ,
 DATEBAS     IN VARCHAR2,
 SUPPRESSION IN VARCHAR2)
 AS
 pos  NUMBER:=0;
 subs VARCHAR2(4000);
 req CLOB;
 requpdate VARCHAR2(4000);
 djourReq  VARCHAR2(1000);
 dteRecalc VARCHAR2(8);
 TYPE Tab_Rowid
 IS
 TABLE OF VARCHAR(100);
 T_Id Tab_Rowid;
 T_IdBasc Tab_Rowid;
 code_basc_prec VARCHAR(20);
 TYPE T_param
 IS
 RECORD
 (
 cpt_dest VARCHAR(20),
 requete CLOB );
 param T_param;
 BEGIN
 SELECT compteur_dest,
 requetes
 INTO param
 FROM CAD_PARAM_REGLES_MAJ
 WHERE code_bascule=bascule;
 DELETE
 FROM CAD_COMPTEUR
 WHERE TYPEMJ     ='I'
 AND CODE_COMPTEUR=param.cpt_dest
 AND DJOUR        =DATEBAS
 AND MATRICULE   IN
 (SELECT matricule FROM CAD_CALCUL_EN_COURS_MATRIC WHERE id=idmatric
 );
 IF SUPPRESSION IS NULL THEN
 INSERT
 INTO CAD_COMPTEUR
 (
 matricule,
 code_compteur,
 djour,
 typemj,
 date_maj
 )
 (SELECT matricule,
 param.cpt_dest,
 datebas,
 'I',
 sysdate
 FROM CAD_CALCUL_EN_COURS_MATRIC
 WHERE id=idmatric
 );
 req :=REPLACE(param.requete,'VALEURJ=','FJ=');
 req :=REPLACE(req,'VALEURH=','FH=');
 DECLARE
 CURSOR cur_cpt
 IS
 SELECT cad_compteur.*,
 cad_compteur.rowid
 FROM cad_compteur, CAD_CALCUL_EN_COURS_MATRIC
 WHERE TYPEMJ     ='I'
 AND CODE_COMPTEUR=param.cpt_dest
 AND DJOUR        =DATEBAS
 AND cad_compteur.MATRICULE =CAD_CALCUL_EN_COURS_MATRIC.matricule
 and   CAD_CALCUL_EN_COURS_MATRIC.id=idmatric;
 lig_cpt cur_cpt%rowtype;
 BEGIN
 OPEN cur_cpt;
 LOOP
 FETCH cur_cpt INTO lig_cpt;
 EXIT
 WHEN cur_cpt%NOTFOUND ;
 -- select max(d.djour)  into djourReq from CAD_COMPTEUR d where d.MATRICULE=lig_cpt.MATRICULE and d.CODE_COMPTEUR=lignebascule.COMPTEUR_ORI AND DJOUR<DATEBAS;
 IF t_id IS NULL THEN
 t_id  :=Tab_Rowid(lig_cpt.rowid);
 ELSE
 t_id.extend();
 t_id(t_id.last):=lig_cpt.rowid;
 END IF;
 END LOOP;
 CLOSE cur_cpt;
 END;
 djourReq           :=' (select max(d.djour)  from CAD_COMPTEUR d where d.MATRICULE=ca.MATRICULE and d.CODE_COMPTEUR=ori.code_compteur AND d.DJOUR<'''||datebas||'''  )  and typemj=(select max(typemj) from CAD_COMPTEUR d where d.code_compteur = ori.code_compteur and d.djour = ori.djour and d.matricule = ori.matricule) ';
 IF t_id            IS NOT NULL THEN
 WHILE LENGTH(req) >0
 LOOP
 IF instr(req,';')>0 THEN
 subs          :=SUBSTR(req,0,instr(req,';'));
 ELSE
 subs:=req;
 END IF;
 req      :=REPLACE(req,subs,'');
 req      :=REPLACE(req,subs,'');
 subs     :=REPLACE(subs,'_DJOUR_',djourReq);
 subs     :=REPLACE(subs,';','');
 requpdate:='update CAD_COMPTEUR ca set '||subs||' where rowid=:1' ;
 FORALL i IN T_Id.first..T_Id.last
 EXECUTE immediate requpdate USING t_id(i);
 END LOOP;
 END IF;
 END IF;
 SELECT MIN(dte)
 INTO dteRecalc
 FROM
 (SELECT MAX(d.djour) AS dte,
 d.matricule
 FROM CAD_COMPTEUR d,cad_calcul_en_cours_matric
 WHERE d.MATRICULE = cad_calcul_en_cours_matric.matricule and cad_calcul_en_cours_matric.id=IDMATRIC
 AND d.CODE_COMPTEUR=param.cpt_dest
 AND d.DJOUR
 ||d.typemj<DATEBAS
 ||'I'
 GROUP BY d.matricule
 );
 CAD_MAJ_VALEUR_LISTE_RUBJOUR( IDMATRIC , dteRecalc , NULL , 'true' , 'true' );
 /*EXCEPTION
 WHEN OTHERS THEN
 err_code := SQLCODE;
 err_msg  :=SQLERRM;
 CAD_ERREUR(IDMATRIC ,'CAD_BASCULE_UNIQUE', IDMATRIC||','|| BASCULE ||','|| DATEBAS  ,err_code||'-'||err_msg);
 raise;*/
 END CAD_BASCULE_UNIQUE;
 END CAD;
