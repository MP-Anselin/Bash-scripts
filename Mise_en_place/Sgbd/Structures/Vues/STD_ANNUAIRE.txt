##
TAG_CHARSET=@€éèç
##
STD_ANNUAIRE
=SQL=
CREATE OR REPLACE FORCE VIEW "STD_ANNUAIRE" ("MATRICULE", "NOM", "PRENOM", "LOGIN", "MATRICRESP", "LABELRESP", "NOMRESP", "PRENOMRESP", "LOGINRESP",  "PHONE1EXT", "PHONE1NUM", "PHONE1LIB", "PHONE2EXT", "PHONE2NUM", "PHONE2LIB", "PHONE3EXT", "PHONE3NUM", "PHONE3LIB", "PHONE4EXT", "PHONE4NUM", "PHONE4LIB", "EMAIL1LIB", "EMAIL1ADRESSE", "EMAIL2LIB", "EMAIL2ADRESSE", "EMPLOILIB", "EMPLOI", "ETABLISSEMENTLIB", "ETABLISSEMENT", "INTITULE1", "VALEUR1", "INTITULE2", "VALEUR2", "INTITULE3", "VALEUR3", "INTITULE4", "VALEUR4", "INTITULE5", "VALEUR5", "INTITULE6", "VALEUR6", "INTITULE7", "VALEUR7", "INTITULE8", "VALEUR8", "INTITULE9", "VALEUR9") AS 
  (
SELECT
 DIC_ADM_PERSO.MATRIC AS MATRICULE,
 DIC_ADM_PERSO.NOM      AS NOM,
 DIC_ADM_PERSO.PRENOM      AS PRENOM,
 (SELECT MIN(LOGIN) FROM SYS_USR_CONFIG SUC1 
 WHERE SUC1.REQUETEMATRIC = SECUPACMAT.MATRIC AND 
(LOGIN LIKE '%-%' OR NOT EXISTS (SELECT 1 FROM SYS_USR_CONFIG SUC2 WHERE REQUETEMATRIC=SUC1.REQUETEMATRIC AND LOGIN LIKE '%-%'))) AS LOGIN,
 (
 SELECT MIN(MATRICPERE)
 FROM ORG_SUBALTERNE
 WHERE CODORG = 'GENERAL' AND ORG_SUBALTERNE.MATRICFILS=DIC_ADM_PERSO.MATRIC
 ) as MATRICRESP,
 'Responsable hiérarchique' as labelresp,
 (SELECT NOM
 FROM DIC_ADM_PERSO EORG
 WHERE EORG.MATRIC=
 (SELECT MIN(MATRICPERE)
 FROM ORG_SUBALTERNE
 WHERE CODORG = 'GENERAL' AND ORG_SUBALTERNE.MATRICFILS=DIC_ADM_PERSO.MATRIC
 )) AS NOMRESP,
 (SELECT PRENOM
 FROM DIC_ADM_PERSO EORG
 WHERE EORG.MATRIC=
 (SELECT MIN(MATRICPERE)
 FROM ORG_SUBALTERNE
 WHERE CODORG = 'GENERAL' AND ORG_SUBALTERNE.MATRICFILS=DIC_ADM_PERSO.MATRIC
 )) AS PRENOMRESP,
 ''                     AS LOGINRESP, 
 ''                     AS PHONE1EXT,
 DIC_ADM_PERSO.NOPRO    AS PHONE1NUM,
 'Bureau'               AS PHONE1LIB,  
 ''                     AS PHONE2EXT,
 DIC_ADM_PERSO.NOPORT   AS PHONE2NUM,
 'Mobile Pro'           AS PHONE2LIB,
 ''   					AS PHONE3EXT,
 DIC_ADM_PERSO.NOFAX    AS PHONE3NUM,
 'Fax'                  AS PHONE3LIB,  
 ''                     AS PHONE4EXT,
 DIC_ADM_PERSO.NOPORP   AS PHONE4NUM,
 'Mobile perso'         AS PHONE4LIB,
 'Email' 				AS EMAIL1LIB,
 DIC_ADM_PERSO.MELPRO   AS EMAIL1ADRESSE,
 'Email perso'     		AS EMAIL2LIB,
 DIC_ADM_PERSO.MELPER     AS EMAIL2ADRESSE,
 'Emploi'               AS emploilib,
 (SELECT F.LIBELLE
 FROM GA_FILIERE F
 WHERE
 SECUPACMAT.FILIR   =F.FILIERE
 AND SECUPACMAT.SSFIL   =F.REGROUPEMENT_METIER
 AND SECUPACMAT.METIER  =F.METIER
 AND SECUPACMAT.EMPLOI  =F.QUALIFICATION
 AND SECUPACMAT.NUMPAC  =F.NUMPAC
 )              AS emploi,
 'Etablissement' AS etablissementlib,
 (
 select max(ent.libelle) from std_struc_affectation aff, 
 std_struc_entite ent
 where aff.code_entite = ent.code_entite
  and  aff.date_eff between ent.date_eff and ent.date_fin
  and  aff.matric =  DIC_ADM_PERSO.MATRIC
  and sysdate between TO_DATE(aff.date_eff,'yyyymmdd') and to_date(aff.date_fin,'yyyymmdd')
  and aff.codts = 1
 ) AS etablissement,
 '' AS INTITULE1,
 '' AS VALEUR1,
 '' AS INTITULE2,
 '' AS VALEUR2,
 '' AS INTITULE3,
 '' AS VALEUR3,
 '' AS INTITULE4,
 '' AS VALEUR4,
 '' AS INTITULE5,
 '' AS VALEUR5,
 '' AS INTITULE6,
 '' AS VALEUR6,
 '' AS INTITULE7,
 '' AS VALEUR7,
 '' AS INTITULE8,
 '' AS VALEUR8,
 '' AS INTITULE9,
 '' AS VALEUR9
 FROM DIC_ADM_PERSO,SECUPACMAT WHERE PRIORITE_SITUATION = 0 AND DIC_ADM_PERSO.MATRIC = SECUPACMAT.MATRIC)
