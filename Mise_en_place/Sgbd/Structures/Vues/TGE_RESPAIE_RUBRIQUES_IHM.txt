##
TAG_CHARSET=@€ιθη
##
TGE_RESPAIE_RUBRIQUES_IHM
=SQL=
CREATE OR REPLACE FORCE VIEW "TGE_RESPAIE_RUBRIQUES_IHM" ("NUMPAC", "PAIEZAD", "PACMAT", "NUMCNT", "CODERUB", "CODERES", "IMPUTATION", "CODECAISSE", "LIBRUB", "NATURERUB", "NOMBRE", "TAUX", "MONTANT", "SENS", "ORDRE", "TYPE", "CLASSE", "PERIODEPAIE", "PERIODE_TRI", "PERIODE_DDMMYYYY", "PERIODE_AFF", "PERIODE_AFFECTATION", "PERIODE_RATTACH_DEB", "PERIODE_RATTACH_FIN", "DATE_DEB_ARRET", "LIB_PERIODE_EMPLOI", "LIB_PERIODE_EMPLOI_2") AS 
  SELECT
 DTR.NUMPAC,
 DTR.PAIEZAD,
 DTR.PACMAT,
 (select DACS.NUMCNT from DIC_ADM_CONTRAT_SITU DACS
 WHERE DACS.NUMPAC=DTR.NUMPAC AND DACS.PAIEZAD=DTR.PAIEZAD AND DACS.NUMCNT=(
 SELECT MAX(DACH.NUMCNT)
 FROM DIC_ADM_CONTRAT_HISTO DACH
 WHERE DACH.NUMPAC=DTR.NUMPAC AND DACH.PAIEZAD=DTR.PAIEZAD
 and DACH.PACMAT = DACS.PACMAT
 AND DTR.PERIODEPAIE BETWEEN TRUNC(DACH.DATE_EFF,'mm') AND DACH.DATE_FIN_BO
 )) as NUMCNT,
 DTR.CODERUB,
 DTR.CODERES,
 DTR.IMPUTATION,
 CASE
 WHEN NVL(TRP.oldcot,'N')='N' AND DTR.CAISSE_RUB IS NOT NULL
 THEN DTR.CAISSE_RUB
 ELSE RUB.CODECAISSE
 END as CODECAISSE,
 NVL((case
 when nvl(TRP.oldcot,'N') = 'N' THEN (select LIB_RESOLU from TGE_REF_LIBRUB_COTIS cotlib where nvl(DTR.CAISSE_RUB,'*') =  cotlib.CODECAISSE and  cotlib.CODERUB = DTR.CODERUB and DTR.NUMPAC = cotlib.NUMPAC)
 ELSE (select LIB_RESOLU from TGE_REF_LIBRUB_COTIS cotlib where nvl(RUB.CODECAISSE,'*') = cotlib.CODECAISSE and  cotlib.CODERUB = RUB.CODERUB and RUB.NUMPAC = cotlib.NUMPAC)
 END), RUB.LIBRUB) as LIBRUB,
 RUB.NATURERUB,
 DTR.NOMBRE,
 DTR.TAUX,
 DTR.MONTANT,
 DTR.SENS,
 DTR.ORDRE,
 DTR.TYPE,
 DTR.CLASSE,
 DTR.PERIODEPAIE,
 to_char(DTR.PERIODEPAIE, 'YYYYMMDD') as PERIODE_TRI,
 to_char(DTR.PERIODEPAIE, 'DD.MM.YYYY') as PERIODE_DDMMYYYY,
 REGEXP_REPLACE(to_char(DTR.PERIODEPAIE, 'Month YYYY'),'[ ]+',' ') as PERIODE_AFF,
 DTR.PERIODE_AFFECTATION,
 DTR.PERIODE_RATTACH_DEB,
 DTR.PERIODE_RATTACH_FIN,
 DTR.DATE_DEB_ARRET,
 (select case
 when DACS.DSFSC=to_date('20991231','yyyymmdd')
 then 'A partir du '||to_char(DACS.DSDSC, 'DD.MM.YYYY')
 else 'Du '||to_char(DACS.DSDSC, 'DD.MM.YYYY')||' au '||to_char(DACS.DSFSC, 'DD.MM.YYYY')
 end from DIC_ADM_CONTRAT_SITU DACS
 WHERE DACS.NUMPAC=DTR.NUMPAC AND DACS.PAIEZAD=DTR.PAIEZAD AND DACS.NUMCNT=(
 SELECT MAX(DACH.NUMCNT)
 FROM DIC_ADM_CONTRAT_HISTO DACH
 WHERE DACH.NUMPAC=DTR.NUMPAC AND DACH.PAIEZAD=DTR.PAIEZAD
 and DACH.PACMAT = DACS.PACMAT
 AND DTR.PERIODEPAIE BETWEEN TRUNC(DACH.DATE_EFF,'mm') AND DACH.DATE_FIN_BO
 )) as LIB_PERIODE_EMPLOI,
 (select case
 when DACS.DSFSC=to_date('20991231','yyyymmdd')
 then to_char(DACS.DSDSC, 'DD.MM.YYYY')
 else to_char(DACS.DSDSC, 'DD.MM.YYYY')||' au '||to_char(DACS.DSFSC, 'DD.MM.YYYY')
 end from DIC_ADM_CONTRAT_SITU DACS
 WHERE DACS.NUMPAC=DTR.NUMPAC AND DACS.PAIEZAD=DTR.PAIEZAD AND DACS.NUMCNT=(
 SELECT MAX(DACH.NUMCNT)
 FROM DIC_ADM_CONTRAT_HISTO DACH
 WHERE DACH.NUMPAC=DTR.NUMPAC AND DACH.PAIEZAD=DTR.PAIEZAD
 and DACH.PACMAT = DACS.PACMAT
 AND DTR.PERIODEPAIE BETWEEN TRUNC(DACH.DATE_EFF,'mm') AND DACH.DATE_FIN_BO
 )) as LIB_PERIODE_EMPLOI_2
 from
 DIC_TGE_RESPAIE_RUBRIQUE DTR
 left outer join TGE_REF_RUBRIQUE RUB
 on RUB.CODERUB=DTR.CODERUB
 and (
 RUB.NUMPAC=DTR.NUMPAC
 or (not exists (select 1 from TGE_REF_RUBRIQUE where TGE_REF_RUBRIQUE.NUMPAC=DTR.NUMPAC) and RUB.NUMPAC='*')
 )
 LEFT OUTER JOIN TGE_REF_PAC TRP
 ON TRP.numpac=DTR.numpac
