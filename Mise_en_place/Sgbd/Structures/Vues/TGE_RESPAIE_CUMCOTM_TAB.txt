##
TAG_CHARSET=@€ιθη
##
TGE_RESPAIE_CUMCOTM_TAB
=SQL=
CREATE OR REPLACE VIEW TGE_RESPAIE_CUMCOTM_TAB AS
SELECT distinct
  DTR.CAISSE_CUMCOTM AS CODE ,
  DTR.CAISSE_CUMCOTM  ||' - '||TRC.LIBCAISSE AS LIBELLE ,
  TRC.LIBCAISSE  ,
  DTR.NUMPAC ,
  DTR.PAIEZAD ,
  DTR.PACMAT ,
  DACS.NUMCNT 
FROM 
  DIC_TGE_RESPAIE_CUMCOTM DTR
  LEFT OUTER JOIN TGE_REF_CAISSE TRC
    ON TRC.CODECAISSE=DTR.CAISSE_CUMCOTM
      AND (TRC.NUMPAC  =DTR.NUMPAC
      OR (NOT EXISTS
        (SELECT *
        FROM TGE_REF_CAISSE
        WHERE TGE_REF_CAISSE.CODECAISSE=DTR.CAISSE_CUMCOTM
        AND TGE_REF_CAISSE.NUMPAC      =DTR.NUMPAC
        )
      AND TRC.NUMPAC='*'))  
  , DIC_ADM_CONTRAT_SITU DACS 
WHERE DACS.NUMPAC=DTR.NUMPAC AND DACS.PAIEZAD=DTR.PAIEZAD AND DACS.NUMCNT=(
 SELECT MAX(DACH.NUMCNT)
 FROM DIC_ADM_CONTRAT_HISTO DACH
 WHERE DACH.NUMPAC=DTR.NUMPAC AND DACH.PAIEZAD=DTR.PAIEZAD
 and DACH.PACMAT = DACS.PACMAT
 AND DTR.DTDEB_CUMCOTM BETWEEN TRUNC(DACH.DATE_EFF,'mm') AND DACH.DATE_FIN_BO
)
