##
HRORG_DOSSIERS_PERDUS
==
CREATE OR REPLACE FORCE VIEW "HRORG_DOSSIERS_PERDUS" ("TYPE_KO", "DOS_NUM", "TRACE_NUM", "PROC_NUM", "PROC_LIBELLE", "OP_NUM", "OP_LIBELLE", "DATEWKF", "DOS_REF", "DOS_DESC", "FCT_ROLE", "CODE_USER", "ROLE_USER", "CODE_TS", "DATE_EFFET_HRO", "CODE_ENTITE", "GV_VALIDE") AS ( select 'INACCESSIBLE' AS TYPE_KO, dos_num, trace_num, proc_num, proc_libelle, op_num, op_libelle, datewkf, dos_ref, dos_desc, fct_role, code_user, role_user, code_ts, date_effet_hro, code_entite, hrorg_get_groupe_valideur (code_ts,op_num,date_effet_hro,code_entite) as gv_valide from ( select wt.trace_num, wt.dos_num, wt.proc_num, wpr.proc_libelle, wt.op_num, wo.op_libelle, TO_CHAR(TO_DATE(wpa3.p_val, 'YYYYMMDDHH24MISS'), 'DD/MM/YYYY')as datewkf, wt.dos_ref, wt.dos_desc, wr.fct_role, wp.code_user, wp.role_user, (select count(distinct up.login) from sys_groupe_valideurs gv, sys_usr_profil up where gv.login=up.login and (wr.fct_role='*' or to_char(code_profil)=wr.fct_role) and groupe_valideurs=wp.code_user) as ExpertOk, nvl(wpa4.p_val,(select codts from std_struc_type where critere_valideurs=1)) as code_ts, nvl(wpa5.p_val, to_char(SYSDATE, 'yyyymmdd')) as date_effet_hro, nvl(wpa1.p_val,(select DECODE(code_entite,'@NON_AFFECTE@','(Non affecté)',code_entite) from std_struc_affectation where matric=wpa2.p_val and codts=nvl(wpa4.p_val,(select codts from std_struc_type where critere_valideurs=1)) and nvl(wpa5.p_val, to_char(SYSDATE, 'yyyymmdd')) between date_eff and date_fin)) as code_entite from wkf_tracabilite wt inner join wkf_op_roleall wr on wr.op_num = wt.op_num inner join wkf_possession wp on wp.trace_num = wt.trace_num inner join wkf_operations wo on wt.op_num = wo.op_num and wt.proc_num = wo.proc_num inner join wkf_processus wpr on wt.proc_num = wpr.proc_num left outer join wkf_param wpa1 on wt.dos_num=wpa1.dos_num and wpa1.p_nom='HRO_GV_CODE_ENTITE' left outer join wkf_param wpa2 on wt.dos_num=wpa2.dos_num and wpa2.p_nom='MATRIC' left outer join wkf_param wpa3 on wt.dos_num=wpa3.dos_num and wpa3.p_nom='DATE_INITIALIZE' left outer join wkf_param wpa4 on wt.dos_num=wpa4.dos_num and wpa4.p_nom='HRO_GV_CODTS' left outer join wkf_param wpa5 on wt.dos_num=wpa5.dos_num and wpa5.p_nom='HRO_GV_DATE_EFFET' where wt.etat='D' and wp.role_user='GV' ) where ExpertOk=0 UNION select 'OBSOLETE', dos_num, trace_num, proc_num, proc_libelle, op_num, op_libelle, datewkf, dos_ref, dos_desc, fct_role, code_user, role_user, code_ts, date_effet_hro, code_entite, hrorg_get_groupe_valideur (code_ts,op_num,date_effet_hro,code_entite) as gv_valide from ( select wt.trace_num, wt.dos_num, wt.proc_num, wpr.proc_libelle, wt.op_num, wo.op_libelle, TO_CHAR(TO_DATE(wpa3.p_val, 'YYYYMMDDHH24MISS'), 'DD/MM/YYYY')as datewkf, wt.dos_ref, wt.dos_desc, wr.fct_role, wp.code_user, wp.role_user, nvl(wpa4.p_val,(select codts from std_struc_type where critere_valideurs=1)) as code_ts, nvl(wpa5.p_val, to_char(SYSDATE, 'yyyymmdd')) as date_effet_hro, nvl(wpa1.p_val,(select DECODE(code_entite,'@NON_AFFECTE@','(Non affecté)',code_entite) from std_struc_affectation where matric=wpa2.p_val and codts=nvl(wpa4.p_val,(select codts from std_struc_type where critere_valideurs=1)) and nvl(wpa5.p_val, to_char(SYSDATE, 'yyyymmdd')) between date_eff and date_fin)) as code_entite from wkf_tracabilite wt inner join wkf_op_roleall wr on wr.op_num = wt.op_num inner join wkf_possession wp on wp.trace_num = wt.trace_num inner join wkf_operations wo on wt.op_num = wo.op_num and wt.proc_num = wo.proc_num inner join wkf_processus wpr on wt.proc_num = wpr.proc_num left outer join wkf_param wpa1 on wt.dos_num=wpa1.dos_num and wpa1.p_nom='HRO_GV_CODE_ENTITE' left outer join wkf_param wpa2 on wt.dos_num=wpa2.dos_num and wpa2.p_nom='MATRIC' left outer join wkf_param wpa3 on wt.dos_num=wpa3.dos_num and wpa3.p_nom='DATE_INITIALIZE' left outer join wkf_param wpa4 on wt.dos_num=wpa4.dos_num and wpa4.p_nom='HRO_GV_CODTS' left outer join wkf_param wpa5 on wt.dos_num=wpa5.dos_num and wpa5.p_nom='HRO_GV_DATE_EFFET' where wt.etat='T' and wt.DOS_DESC LIKE ('%obsolète%') and wp.role_user='GV' ) UNION select 'PERDU', dos_num, trace_num, proc_num, proc_libelle, op_num, op_libelle, datewkf, dos_ref, dos_desc, fct_role, code_user, role_user, code_ts, date_effet_hro, code_entite, hrorg_get_groupe_valideur (code_ts,op_num,date_effet_hro,code_entite) as gv_valide from ( select wt.trace_num, wt.dos_num, wt.proc_num, wpr.proc_libelle, wt.op_num, wo.op_libelle, TO_CHAR(TO_DATE(wpa3.p_val, 'YYYYMMDDHH24MISS'), 'DD/MM/YYYY')as datewkf, wt.dos_ref, wt.dos_desc, wr.fct_role, wp.code_user, wp.role_user, wbg.fct_num, fu.fct_class, nvl(wpa4.p_val,(select codts from std_struc_type where critere_valideurs=1)) as code_ts, nvl(wpa5.p_val, to_char(SYSDATE, 'yyyymmdd')) as date_effet_hro, nvl(wpa1.p_val,(select DECODE(code_entite,'@NON_AFFECTE@','(Non affecté)',code_entite) from std_struc_affectation where matric=wpa2.p_val and codts=nvl(wpa4.p_val,(select codts from std_struc_type where critere_valideurs=1)) and nvl(wpa5.p_val, to_char(SYSDATE, 'yyyymmdd')) between date_eff and date_fin)) as code_entite from wkf_tracabilite wt inner join wkf_op_roleall wr on wr.op_num = wt.op_num inner join wkf_possession wp on wp.trace_num = wt.trace_num inner join wkf_operations wo on wt.op_num = wo.op_num and wt.proc_num = wo.proc_num inner join wkf_processus wpr on wt.proc_num = wpr.proc_num left outer join wkf_param wpa1 on wt.dos_num=wpa1.dos_num and wpa1.p_nom='HRO_GV_CODE_ENTITE' left outer join wkf_param wpa2 on wt.dos_num=wpa2.dos_num and wpa2.p_nom='MATRIC' left outer join wkf_param wpa3 on wt.dos_num=wpa3.dos_num and wpa3.p_nom='DATE_INITIALIZE' left outer join wkf_param wpa4 on wt.dos_num=wpa4.dos_num and wpa4.p_nom='HRO_GV_CODTS' left outer join wkf_param wpa5 on wt.dos_num=wpa5.dos_num and wpa5.p_nom='HRO_GV_DATE_EFFET' left outer join wkf_branch_gen wbg on wbg.code_retour=wt.code_retour and wbg.op_dest_num=wt.op_num and wbg.tr_num=wt.tr_emet left outer join wkf_fctuser fu on fu.fct_num=wbg.fct_num where wt.etat in ('D','P') and wp.role_user='R' and wp.code_user='DBA' ) where fct_class like '%GroupeValideurs%' )
