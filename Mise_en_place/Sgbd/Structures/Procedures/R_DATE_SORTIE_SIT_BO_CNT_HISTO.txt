##
R_DATE_SORTIE_SIT_BO_CNT_HISTO
=SQL=
create or replace
PROCEDURE R_DATE_SORTIE_SIT_BO_CNT_HISTO AS 
BEGIN
  -- Procédure de reprise des dates de sortie BO dans la table DIC_ADM_CONTRAT_HISTO 
  EXECUTE_IMMEDIATE_STRING( 'INSERT INTO TABLE_SORTIE_SIT_BO_TEMPORARY (SELECT MATRIC,DATE_EFF,DATE_SORTIE_SIT_BO AS DATE_SORTIE_SIT_BO_OLD,NVL(LEAD(DATE_EFF_MOINS_UN) OVER(PARTITION BY MATRIC ORDER BY DATE_EFF), TO_DATE(''20991231'',''yyyymmdd'')) AS DATE_SORTIE_SIT_BO_NEW FROM (SELECT DISTINCT MATRIC,DATE_EFF,DATE_SORTIE_SIT_BO,DATE_EFF-1 AS DATE_EFF_MOINS_UN FROM DIC_ADM_CONTRAT_HISTO WHERE MATRIC IS NOT NULL))',1);
  --COMMIT;
  EXECUTE_IMMEDIATE_STRING( 'MERGE INTO DIC_ADM_CONTRAT_HISTO C USING  (SELECT * FROM TABLE_SORTIE_SIT_BO_TEMPORARY WHERE  NVL(DATE_SORTIE_SIT_BO_NEW,to_date(''19001231'',''yyyymmdd'')) <> NVL(DATE_SORTIE_SIT_BO_OLD,to_date(''19001231'',''yyyymmdd''))) T ON  (T.MATRIC=C.MATRIC AND T.DATE_EFF=C.DATE_EFF) WHEN MATCHED THEN UPDATE SET TYPE_WRITER=''N'', C.DATE_SORTIE_SIT_BO  = T.DATE_SORTIE_SIT_BO_NEW',1);
  --COMMIT;
  EXECUTE_IMMEDIATE_STRING( 'TRUNCATE TABLE TABLE_SORTIE_SIT_BO_TEMPORARY',0);
  -- Fin
EXCEPTION WHEN OTHERS THEN
 EXECUTE_IMMEDIATE_STRING( 'TRUNCATE TABLE TABLE_SORTIE_SIT_BO_TEMPORARY',0);
END R_DATE_SORTIE_SIT_BO_CNT_HISTO;
