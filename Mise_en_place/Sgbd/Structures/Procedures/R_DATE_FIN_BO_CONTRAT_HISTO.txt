##
R_DATE_FIN_BO_CONTRAT_HISTO
=SQL=
create or replace
PROCEDURE R_DATE_FIN_BO_CONTRAT_HISTO AS 
BEGIN
  -- Procédure de reprise des dates de fin BO dans la table DIC_ADM_CONTRAT_HISTO
  BEGIN
    EXECUTE_IMMEDIATE_STRING( 'DROP TABLE TABLE_DATE_FIN_BO',0);
  EXCEPTION WHEN OTHERS THEN NULL; END;

  EXECUTE_IMMEDIATE_STRING( 'CREATE TABLE TABLE_DATE_FIN_BO(NUMPAC VARCHAR2(6),PAIEZAD VARCHAR2(8),DATE_EFF DATE,DATE_FIN_BO_OLD DATE,DATE_FIN_BO_NEW DATE,PRIMARY KEY(NUMPAC,PAIEZAD,DATE_EFF))',0);

  EXECUTE_IMMEDIATE_STRING( 'INSERT INTO TABLE_DATE_FIN_BO (SELECT NUMPAC,PAIEZAD,DATE_EFF,DATE_FIN_BO AS DATE_FIN_BO_OLD,NVL(LEAD(DATE_EFF_MOINS_UN) OVER(PARTITION BY NUMPAC,PAIEZAD ORDER BY DATE_EFF), TO_DATE(''20991231'',''yyyymmdd'')) AS DATE_FIN_BO_NEW FROM (SELECT DISTINCT NUMPAC,PAIEZAD,DATE_EFF,DATE_FIN_BO,DATE_EFF-1 AS DATE_EFF_MOINS_UN FROM DIC_ADM_CONTRAT_HISTO WHERE PAIEZAD IS NOT NULL))',0);

  EXECUTE_IMMEDIATE_STRING( 'MERGE INTO DIC_ADM_CONTRAT_HISTO C USING  (SELECT * FROM TABLE_DATE_FIN_BO WHERE  NVL(DATE_FIN_BO_NEW,to_date(''19001231'',''yyyymmdd'')) <> NVL(DATE_FIN_BO_OLD,to_date(''19001231'',''yyyymmdd''))) T ON  (T.NUMPAC=C.NUMPAC  AND T.PAIEZAD=C.PAIEZAD  AND T.DATE_EFF=C.DATE_EFF) WHEN MATCHED THEN UPDATE SET TYPE_WRITER=''N'', C.DATE_FIN_BO  = T.DATE_FIN_BO_NEW',0);

  EXECUTE_IMMEDIATE_STRING( 'DROP TABLE TABLE_DATE_FIN_BO',0);
  -- Fin
  COMMIT;
END R_DATE_FIN_BO_CONTRAT_HISTO;
