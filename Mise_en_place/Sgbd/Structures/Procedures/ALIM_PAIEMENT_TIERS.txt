##
TAG_CHARSET=@€éèç
##
ALIM_PAIEMENT_TIERS
=SQL=
CREATE OR REPLACE PROCEDURE ALIM_PAIEMENT_TIERS (p_NumpacCible VARCHAR2) AS
 v_requete CLOB;
 v_periode VARCHAR2(6);
 v_statut VARCHAR2(1);
 v_requete_maj_statut CLOB;
 v_tableExiste NUMBER;
 v_MPE VARCHAR2(1);
 
 BEGIN
 -- Initialisation de la période et du statut de la campagne à I
 --select PERIODEENCOURS into v_periode FROM TGE_REF_PAC where NUMPAC = p_NumpacCible;
 select TO_CHAR(max(PERIODEPAIE),'YYYYMM') into v_periode from DIC_TGE_RESPAIE_RUBRIQUE where NUMPAC= p_NumpacCible;
 v_statut := 'I';
 v_requete_maj_statut := 'Update TIERS_PILOTAGE set STATUT = :1 where NUMPAC = '''||p_NumpacCible||''' AND PERIODE = TO_DATE ('||v_periode||',''YYYYMM'')';
 
 
 -- Insertion dans la table de pilotage de la campagne en cours
 DELETE TIERS_PILOTAGE WHERE NUMPAC = p_NumpacCible AND PERIODE = TO_DATE (v_periode,'YYYYMM');
 INSERT INTO TIERS_PILOTAGE (NUMPAC,PERIODE,STATUT,SAISIE_BLOQUE_OPP,SAISIE_BLOQUE_PEN) VALUES (p_NumpacCible, TO_DATE (v_periode,'YYYYMM'),v_statut,'O','O');
 COMMIT;
 
 -- Suppression des lignes pour le numpac cible à la période en cours
 DELETE from DIC_PAIEMENT_TIERS where TIERS_NUMPAC = p_NumpacCible AND TIERS_MOIS_PAIE = TO_DATE (v_periode,'YYYYMM');
 
 
 -- Insertion des Oppositions en mode de paiement Virement pour le numpac cible à la période en cours
 BEGIN
 Insert into DIC_PAIEMENT_TIERS (
 TIERS_MOIS_PAIE,
 TIERS_TYPE,
 TIERS_NUMPAC,
 TIERS_MATRIC,
 TIERS_PACMAT,
 TIERS_PAIEZAD,
 TIERS_NOM,
 TIERS_PRENOM,
 TIERS_CODSTE,
 TIERS_CODETB,
 TIERS_CODE_BQE,
 TIERS_NUMERO,
 TIERS_NUM_DOS,
 TIERS_CODRUB,
 TIERS_LIBELLE,
 TIERS_MONTANT,
 TIERS_ACTIF,
 TIERS_BENEFICIAIRE,
 TIERS_DOM_BQE,
 TIERS_IBAN,
 TIERS_BIC,
 TIERS_POP_GFF)
 
 (select
 to_date(v_periode,'YYYYMM'),
 'O',
 TGE_REF_PAC.NUMPAC,
 DIC_TGE_OPPOSITIONS.MATRIC,
 DIC_TGE_OPPOSITIONS.PACMAT,
 DIC_TGE_RESPAIE_RUBRIQUE.PAIEZAD,
 SECUPACMAT.NOM,
 SECUPACMAT.PRENOM,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSSJ,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSCE,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSBE,
 DIC_TGE_OPPOSITIONS.NUM_OPPOSITION,
 DIC_TGE_OPPOSITIONS.NUM_DOSS_OPPOSITION,
 DIC_TGE_RESPAIE_RUBRIQUE.CODERUB,
 DIC_TGE_OPPOSITIONS.LIB_COMP_OPPOSITION,
 ABS(DIC_TGE_RESPAIE_RUBRIQUE.MONTANT),
 'O',
 DIC_TGE_OPPOSITIONS.NOM_BENEFICIAIRE,
 DIC_TGE_OPPOSITIONS.DOMICILIATION_BANQUE,
 DIC_TGE_OPPOSITIONS.CODE_PAYS_IBAN||CLE_IBAN||CODE_IBAN2||CODE_IBAN3||CODE_IBAN4||CODE_IBAN5||CODE_IBAN6||CODE_IBAN7||CODE_IBAN8||CODE_IBAN9,
 DIC_TGE_OPPOSITIONS.BIC_OPPOSITION,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSPOP
 FROM TGE_REF_PAC
 join TIERS_RUB_TRANSCO on TGE_REF_PAC.NUMPAC = TIERS_RUB_TRANSCO.NUMPAC
 join (select rub.numpac,max(rub.paiezad) as paiezad,rub.pacmat,rub.periodepaie,rub.coderub,sum(rub.montant) as montant from DIC_TGE_RESPAIE_RUBRIQUE rub where rub.montant<0 group by (rub.numpac,rub.pacmat,rub.periodepaie,rub.coderub)) DIC_TGE_RESPAIE_RUBRIQUE on DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC=TGE_REF_PAC.NUMPAC AND TO_CHAR(DIC_TGE_RESPAIE_RUBRIQUE.PERIODEPAIE,'YYYYMM')=v_periode AND DIC_TGE_RESPAIE_RUBRIQUE.CODERUB = TIERS_RUB_TRANSCO.CODRUB
 join DIC_TGE_OPPOSITIONS on DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC=DIC_TGE_OPPOSITIONS.NUMPAC AND DIC_TGE_RESPAIE_RUBRIQUE.PACMAT=DIC_TGE_OPPOSITIONS.PACMAT AND TO_NUMBER(DIC_TGE_OPPOSITIONS.NUM_OPPOSITION) = TO_NUMBER(TIERS_RUB_TRANSCO.NUMERO)
 join SECUPACMAT on SECUPACMAT.NUMPAC=TGE_REF_PAC.NUMPAC AND SECUPACMAT.PACMAT=DIC_TGE_OPPOSITIONS.PACMAT
 join DIC_TGE_RESPAIE_HISTO on DIC_TGE_RESPAIE_HISTO.NUMPAC = DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC AND DIC_TGE_RESPAIE_HISTO.PAIEZAD=DIC_TGE_RESPAIE_RUBRIQUE.PAIEZAD AND DIC_TGE_RESPAIE_HISTO.DTDEB_HISTO=DIC_TGE_RESPAIE_RUBRIQUE.PERIODEPAIE 
 WHERE
 MODE_OPPOSITION = 'V' AND DIC_TGE_RESPAIE_RUBRIQUE.MONTANT<0 AND TIERS_RUB_TRANSCO.TYPE = 'O' AND TGE_REF_PAC.NUMPAC = p_NumpacCible);
 
 --si plantage on met le statut de la campagne à jours en E (Erreur) et on arrete le traitement
 EXCEPTION
 WHEN OTHERS
 THEN
 v_statut := 'E';
 EXECUTE IMMEDIATE v_requete_maj_statut USING v_statut;
 COMMIT;
 RAISE;
 END;
 
 -- Insertion des Pensions 1 en mode de paiement Virement pour le numpac cible à la période en cours
 BEGIN
 Insert into DIC_PAIEMENT_TIERS (
 TIERS_MOIS_PAIE,
 TIERS_TYPE,
 TIERS_NUMPAC,
 TIERS_MATRIC,
 TIERS_PACMAT,
 TIERS_PAIEZAD,
 TIERS_NOM,
 TIERS_PRENOM,
 TIERS_CODSTE,
 TIERS_CODETB,
 TIERS_CODE_BQE,
 TIERS_NUMERO,
 TIERS_CODRUB,
 TIERS_MONTANT,
 TIERS_ACTIF,
 TIERS_BENEFICIAIRE,
 TIERS_DOM_BQE,
 TIERS_IBAN,
 TIERS_BIC,
 TIERS_POP_GFF)
 
 (select
 to_date(v_periode,'YYYYMM'),
 'P',
 TGE_REF_PAC.NUMPAC,
 DIC_PENSION.MATRIC,
 DIC_PENSION.PACMAT,
 DIC_TGE_RESPAIE_RUBRIQUE.PAIEZAD,
 SECUPACMAT.NOM,
 SECUPACMAT.PRENOM,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSSJ,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSCE,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSBE,
 TIERS_RUB_TRANSCO.NUMERO,
 DIC_TGE_RESPAIE_RUBRIQUE.CODERUB,
 ABS(DIC_TGE_RESPAIE_RUBRIQUE.MONTANT),
 'O',
 NVL(DIC_PENSION.NOM1_PEN || ' ' || DIC_PENSION.PRENOM1_PEN,DIC_PENSION.ORGA_1) ,
 DIC_PENSION.LIBQE_PEN,
 DIC_PENSION.IBAPA_PEN||IBACC_PEN||IBA21_PEN||IBA31_PEN||IBA41_PEN||IBA51_PEN||IBA61_PEN||IBA71_PEN||IBA81_PEN||IBA91_PEN,
 DIC_PENSION.BIC1_PEN,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSPOP
 FROM TGE_REF_PAC
 join TIERS_RUB_TRANSCO on TGE_REF_PAC.NUMPAC = TIERS_RUB_TRANSCO.NUMPAC
 join (select rub.numpac,max(rub.paiezad) as paiezad,rub.pacmat,rub.periodepaie,rub.coderub,sum(rub.montant) as montant from DIC_TGE_RESPAIE_RUBRIQUE rub where rub.montant<0 group by (rub.numpac,rub.pacmat,rub.periodepaie,rub.coderub))DIC_TGE_RESPAIE_RUBRIQUE on DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC=TGE_REF_PAC.NUMPAC AND TO_CHAR(DIC_TGE_RESPAIE_RUBRIQUE.PERIODEPAIE,'YYYYMM')=v_periode
 AND DIC_TGE_RESPAIE_RUBRIQUE.CODERUB = TIERS_RUB_TRANSCO.CODRUB
 join DIC_PENSION on DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC=DIC_PENSION.NUMPAC AND DIC_TGE_RESPAIE_RUBRIQUE.PACMAT=DIC_PENSION.PACMAT
 join SECUPACMAT on SECUPACMAT.NUMPAC=TGE_REF_PAC.NUMPAC AND SECUPACMAT.PACMAT=DIC_PENSION.PACMAT
 join DIC_TGE_RESPAIE_HISTO on DIC_TGE_RESPAIE_HISTO.NUMPAC = DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC AND DIC_TGE_RESPAIE_HISTO.PAIEZAD=DIC_TGE_RESPAIE_RUBRIQUE.PAIEZAD AND DIC_TGE_RESPAIE_HISTO.DTDEB_HISTO=DIC_TGE_RESPAIE_RUBRIQUE.PERIODEPAIE
 where
 TO_NUMBER(TIERS_RUB_TRANSCO.NUMERO)=1 AND TIERS_RUB_TRANSCO.TYPE='P' AND DIC_TGE_RESPAIE_RUBRIQUE.MONTANT<0 AND DIC_PENSION.MODPAI1_PEN='V' AND TGE_REF_PAC.NUMPAC = p_NumpacCible);
 
 --si plantage on met le statut de la campagne à jours en E (Erreur) et on arrete le traitement
 EXCEPTION
 WHEN OTHERS
 THEN
 v_statut := 'E';
 EXECUTE IMMEDIATE v_requete_maj_statut USING v_statut;
 COMMIT;
 RAISE;
 END;
 
 -- Insertion des Pensions 2 en mode de paiement Virement pour le numpac cible à la période en cours
 BEGIN
 Insert into DIC_PAIEMENT_TIERS (
 TIERS_MOIS_PAIE,
 TIERS_TYPE,
 TIERS_NUMPAC,
 TIERS_MATRIC,
 TIERS_PACMAT,
 TIERS_PAIEZAD,
 TIERS_NOM,
 TIERS_PRENOM,
 TIERS_CODSTE,
 TIERS_CODETB,
 TIERS_CODE_BQE,
 TIERS_NUMERO,
 TIERS_CODRUB,
 TIERS_MONTANT,
 TIERS_ACTIF,
 TIERS_BENEFICIAIRE,
 TIERS_DOM_BQE,
 TIERS_IBAN,
 TIERS_BIC,
 TIERS_POP_GFF)
 
 (select
 to_date(v_periode,'YYYYMM'),
 'P',
 TGE_REF_PAC.NUMPAC,
 DIC_PENSION.MATRIC,
 DIC_PENSION.PACMAT,
 DIC_TGE_RESPAIE_RUBRIQUE.PAIEZAD,
 SECUPACMAT.NOM,
 SECUPACMAT.PRENOM,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSSJ,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSCE,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSBE,
 TIERS_RUB_TRANSCO.NUMERO,
 DIC_TGE_RESPAIE_RUBRIQUE.CODERUB,
 ABS(DIC_TGE_RESPAIE_RUBRIQUE.MONTANT),
 'O',
 NVL(DIC_PENSION.NOM2_PEN || ' ' || DIC_PENSION.PRENOM2_PEN,DIC_PENSION.ORGA_2) ,
 DIC_PENSION.LIBQE2_PEN,
 DIC_PENSION.IBAPA2_PEN||IBACC2_PEN||IBA22_PEN||IBA32_PEN||IBA42_PEN||IBA52_PEN||IBA62_PEN||IBA72_PEN||IBA82_PEN||IBA92_PEN,
 DIC_PENSION.BIC2_PEN,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSPOP
 FROM TGE_REF_PAC
 join TIERS_RUB_TRANSCO on TGE_REF_PAC.NUMPAC = TIERS_RUB_TRANSCO.NUMPAC
 join (select rub.numpac,max(rub.paiezad) as paiezad ,rub.pacmat,rub.periodepaie,rub.coderub,sum(rub.montant) as montant from DIC_TGE_RESPAIE_RUBRIQUE rub 
    where rub.montant<0 group by (rub.numpac,rub.pacmat,rub.periodepaie,rub.coderub))DIC_TGE_RESPAIE_RUBRIQUE on DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC=TGE_REF_PAC.NUMPAC AND TO_CHAR(DIC_TGE_RESPAIE_RUBRIQUE.PERIODEPAIE,'YYYYMM')=v_periode
 AND DIC_TGE_RESPAIE_RUBRIQUE.CODERUB = TIERS_RUB_TRANSCO.CODRUB
 join DIC_PENSION on DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC=DIC_PENSION.NUMPAC AND DIC_TGE_RESPAIE_RUBRIQUE.PACMAT=DIC_PENSION.PACMAT
 join SECUPACMAT on SECUPACMAT.NUMPAC=TGE_REF_PAC.NUMPAC AND SECUPACMAT.PACMAT=DIC_PENSION.PACMAT 
 join DIC_TGE_RESPAIE_HISTO on DIC_TGE_RESPAIE_HISTO.NUMPAC = DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC AND DIC_TGE_RESPAIE_HISTO.PAIEZAD=DIC_TGE_RESPAIE_RUBRIQUE.PAIEZAD AND DIC_TGE_RESPAIE_HISTO.DTDEB_HISTO=DIC_TGE_RESPAIE_RUBRIQUE.PERIODEPAIE 
 where
 TO_NUMBER(TIERS_RUB_TRANSCO.NUMERO)=2 AND TIERS_RUB_TRANSCO.TYPE='P' AND DIC_TGE_RESPAIE_RUBRIQUE.MONTANT<0 AND DIC_PENSION.MODPAI1_PEN='V' AND TGE_REF_PAC.NUMPAC = p_NumpacCible);
 
 --si plantage on met le statut de la campagne à jours en E (Erreur) et on arrete le traitement
 EXCEPTION
 WHEN OTHERS
 THEN
 v_statut := 'E';
 EXECUTE IMMEDIATE v_requete_maj_statut USING v_statut;
 COMMIT;
 RAISE;
 END;
 
 -- Insertion des Pensions 3 en mode de paiement Virement pour le numpac cible à la période en cours
 BEGIN
 Insert into DIC_PAIEMENT_TIERS (
 TIERS_MOIS_PAIE,
 TIERS_TYPE,
 TIERS_NUMPAC,
 TIERS_MATRIC,
 TIERS_PACMAT,
 TIERS_PAIEZAD,
 TIERS_NOM,
 TIERS_PRENOM,
 TIERS_CODSTE,
 TIERS_CODETB,
 TIERS_CODE_BQE,
 TIERS_NUMERO,
 TIERS_CODRUB,
 TIERS_MONTANT,
 TIERS_ACTIF,
 TIERS_BENEFICIAIRE,
 TIERS_DOM_BQE,
 TIERS_IBAN,
 TIERS_BIC,
 TIERS_POP_GFF)
 
 (select
 to_date(v_periode,'YYYYMM'),
 'P',
 TGE_REF_PAC.NUMPAC,
 DIC_PENSION.MATRIC,
 DIC_PENSION.PACMAT,
 DIC_TGE_RESPAIE_RUBRIQUE.PAIEZAD,
 SECUPACMAT.NOM,
 SECUPACMAT.PRENOM,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSSJ,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSCE,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSBE,
 TIERS_RUB_TRANSCO.NUMERO,
 DIC_TGE_RESPAIE_RUBRIQUE.CODERUB,
 ABS(DIC_TGE_RESPAIE_RUBRIQUE.MONTANT),
 'O',
 NVL(DIC_PENSION.NOM3_PEN || ' ' || DIC_PENSION.PRENOM3_PEN,DIC_PENSION.ORGA_3) ,
 DIC_PENSION.LIBQE3_PEN,
 DIC_PENSION.IBAPA3_PEN||IBACC3_PEN||IBA23_PEN||IBA33_PEN||IBA43_PEN||IBA53_PEN||IBA63_PEN||IBA73_PEN||IBA83_PEN||IBA93_PEN,
 DIC_PENSION.BIC3_PEN,
 DIC_TGE_RESPAIE_HISTO.PREVTIERSPOP
 FROM TGE_REF_PAC
 join TIERS_RUB_TRANSCO on TGE_REF_PAC.NUMPAC = TIERS_RUB_TRANSCO.NUMPAC
 join (select rub.numpac,max(rub.paiezad) as paiezad,rub.pacmat,rub.periodepaie,rub.coderub,sum(rub.montant) as montant from DIC_TGE_RESPAIE_RUBRIQUE rub where rub.montant<0 group by (rub.numpac,rub.pacmat,rub.periodepaie,rub.coderub))DIC_TGE_RESPAIE_RUBRIQUE on DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC=TGE_REF_PAC.NUMPAC AND TO_CHAR(DIC_TGE_RESPAIE_RUBRIQUE.PERIODEPAIE,'YYYYMM')=v_periode
 AND DIC_TGE_RESPAIE_RUBRIQUE.CODERUB = TIERS_RUB_TRANSCO.CODRUB
 join DIC_PENSION on DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC=DIC_PENSION.NUMPAC AND DIC_TGE_RESPAIE_RUBRIQUE.PACMAT=DIC_PENSION.PACMAT
 join SECUPACMAT on SECUPACMAT.NUMPAC=TGE_REF_PAC.NUMPAC AND SECUPACMAT.PACMAT=DIC_PENSION.PACMAT
 join DIC_TGE_RESPAIE_HISTO on DIC_TGE_RESPAIE_HISTO.NUMPAC = DIC_TGE_RESPAIE_RUBRIQUE.NUMPAC AND DIC_TGE_RESPAIE_HISTO.PAIEZAD=DIC_TGE_RESPAIE_RUBRIQUE.PAIEZAD AND DIC_TGE_RESPAIE_HISTO.DTDEB_HISTO=DIC_TGE_RESPAIE_RUBRIQUE.PERIODEPAIE 
 where
 TO_NUMBER(TIERS_RUB_TRANSCO.NUMERO)=3 AND TIERS_RUB_TRANSCO.TYPE='P' AND DIC_TGE_RESPAIE_RUBRIQUE.MONTANT<0 AND DIC_PENSION.MODPAI1_PEN='V' AND TGE_REF_PAC.NUMPAC = p_NumpacCible);
 
 --si plantage on met le statut de la campagne à jours en E (Erreur) et on arrete le traitement
 EXCEPTION
 WHEN OTHERS
 THEN
 v_statut := 'E';
 EXECUTE IMMEDIATE v_requete_maj_statut USING v_statut;
 COMMIT;
 RAISE;
 END;
 
 -- Mise a jour du CODE CHRONO si on est en MPE et qu'on est dans une version où la table DIC_ADM_CONTRAT_SITU existe
 SELECT count(table_name) INTO v_tableExiste FROM USER_TABLES WHERE table_name = upper('DIC_ADM_CONTRAT_SITU');
 SELECT MPE INTO v_MPE FROM TGE_REF_PAC WHERE NUMPAC = p_NumpacCible;
 IF v_tableExiste > 0 and v_MPE='O' THEN
 BEGIN
 UPDATE DIC_PAIEMENT_TIERS set TIERS_CODE_CHRONO = (select CODE_CHRONO from DIC_ADM_CONTRAT_SITU WHERE DIC_PAIEMENT_TIERS.TIERS_PAIEZAD = DIC_ADM_CONTRAT_SITU.PAIEZAD AND DIC_PAIEMENT_TIERS.TIERS_NUMPAC = DIC_ADM_CONTRAT_SITU.NUMPAC)where TIERS_NUMPAC = p_NumpacCible AND TIERS_MOIS_PAIE = TO_DATE (v_periode,'YYYYMM');
 --si plantage on met le statut de la campagne à jours en E (Erreur) et on arrete le traitement
 EXCEPTION
 WHEN OTHERS
 THEN
 v_statut := 'E';
 EXECUTE IMMEDIATE v_requete_maj_statut USING v_statut;
 COMMIT;
 RAISE;
 END;
 END IF;
 
 -- Traitement terminé mise à jours du statut de la table de pilotage C pour campagne en cours et debloquage des saisies
 v_statut := 'C';
 EXECUTE IMMEDIATE v_requete_maj_statut USING v_statut;
 UPDATE TIERS_PILOTAGE SET SAISIE_BLOQUE_OPP='N',SAISIE_BLOQUE_PEN='N' where NUMPAC = p_NumpacCible AND PERIODE = TO_DATE (v_periode,'YYYYMM');
 
 COMMIT;
 
 END;