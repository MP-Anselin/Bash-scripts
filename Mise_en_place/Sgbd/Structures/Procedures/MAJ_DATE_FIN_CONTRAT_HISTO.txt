##
MAJ_DATE_FIN_CONTRAT_HISTO
=SQL=
CREATE OR REPLACE PROCEDURE MAJ_DATE_FIN_CONTRAT_HISTO 
IS 
BEGIN
  -- Procédure de reprise des dates de fin  dans la table DIC_ADM_CONTRAT_HISTO
  BEGIN
    EXECUTE_IMMEDIATE_STRING( 'DROP TABLE TABLE_DATE_FIN',0);
  EXCEPTION WHEN OTHERS THEN NULL; END;

  EXECUTE_IMMEDIATE_STRING( 'CREATE TABLE TABLE_DATE_FIN(NUMPAC VARCHAR2(6),PACMAT  VARCHAR2(8),NUMCNT NUMBER,DATE_EFF DATE,DATE_FIN_OLD DATE,DATE_FIN_NEW DATE,PRIMARY KEY(NUMPAC,PACMAT,NUMCNT,DATE_EFF))',0);

  EXECUTE_IMMEDIATE_STRING( 'INSERT INTO TABLE_DATE_FIN(SELECT NUMPAC,PACMAT,NUMCNT,DATE_EFF,DATE_FIN  AS DATE_FIN_OLD,LEAST(NVL(LEAD(DATE_EFF_MOINS_UN) OVER(PARTITION BY NUMPAC,PACMAT,NUMCNT ORDER BY DATE_EFF), TO_DATE(''20991231'',''yyyymmdd'')),DSFCN) AS DATE_FIN_NEW FROM
 (SELECT DISTINCT dach.NUMPAC,dach.PACMAT,dach.NUMCNT,dach.DATE_EFF,dach.DATE_FIN,dach.DATE_EFF-1 AS DATE_EFF_MOINS_UN,NVL(dac.DSFCN,TO_DATE(''20991231'',''yyyymmdd'')) AS DSFCN FROM DIC_ADM_CONTRAT dac,DIC_ADM_CONTRAT_HISTO dach
  WHERE dac.NUMPAC      =dach.NUMPAC AND dac.PACMAT      =dach.PACMAT AND dac.NUMCNT      =dach.NUMCNT))',0);

  EXECUTE_IMMEDIATE_STRING( 'MERGE INTO DIC_ADM_CONTRAT_HISTO C USING(SELECT * FROM TABLE_DATE_FIN WHERE NVL(DATE_FIN_NEW,to_date(''19001231'',''yyyymmdd'')) <> NVL(DATE_FIN_OLD,to_date(''19001231'',''yyyymmdd'')))
T ON (T.NUMPAC=C.NUMPAC AND T.PACMAT=C.PACMAT AND T.NUMCNT=C.NUMCNT AND T.DATE_EFF=C.DATE_EFF)
WHEN MATCHED THEN UPDATE SET TYPE_WRITER=''N'', C.DATE_FIN = T.DATE_FIN_NEW',0);

  EXECUTE_IMMEDIATE_STRING( 'DROP TABLE TABLE_DATE_FIN',0);
  -- Fin
  COMMIT;
END MAJ_DATE_FIN_CONTRAT_HISTO;
