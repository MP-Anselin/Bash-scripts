##
SECNAV_MAJ_CURRENT_CONTRAT
=SQL=
CREATE OR REPLACE PROCEDURE SECNAV_MAJ_CURRENT_CONTRAT(p_matric VARCHAR2, p_majDataContrat NUMBER, p_majDataContratHisto NUMBER, p_alimTmp NUMBER) AS
  v_dateEff DATE;
  v_count        NUMBER;
  nbtabledach    NUMBER;
BEGIN
  IF p_matric='DO_MAJ' THEN
    -- On se met à minuit
    v_dateEff := TRUNC(SYSDATE,'dd');

    -- On met à jour CURRENT_DSDCN_MATRIC dans la table temporaire (date de début du contrat courant pour le MATRIC)
    UPDATE SECUPACMAT_TMP_CONTRAT SET CURRENT_DSDCN_MATRIC=(SELECT MAX(DSDCN) FROM DIC_ADM_CONTRAT WHERE DIC_ADM_CONTRAT.MATRIC=SECUPACMAT_TMP_CONTRAT.MATRIC AND v_dateEff BETWEEN DSDCN AND NVL(DSFCN, TO_DATE('20991231','yyyymmdd')));
    UPDATE SECUPACMAT_TMP_CONTRAT SET CURRENT_DSDCN_MATRIC=(SELECT MIN(DSDCN) FROM DIC_ADM_CONTRAT WHERE DIC_ADM_CONTRAT.MATRIC=SECUPACMAT_TMP_CONTRAT.MATRIC AND DSDCN>v_dateEff) WHERE CURRENT_DSDCN_MATRIC IS NULL;
    UPDATE SECUPACMAT_TMP_CONTRAT SET CURRENT_DSDCN_MATRIC=(SELECT MAX(DSDCN) FROM DIC_ADM_CONTRAT WHERE DIC_ADM_CONTRAT.MATRIC=SECUPACMAT_TMP_CONTRAT.MATRIC AND DSDCN<v_dateEff) WHERE CURRENT_DSDCN_MATRIC IS NULL;

    -- On met à jour CURRENT_NUMCNT_PACMAT et CURRENT_DSDCN_PACMAT dans la table temporaire (contrat courant et date de début correspondante pour le NUMPAC/PACMAT)
    UPDATE SECUPACMAT_TMP_CONTRAT SET (CURRENT_NUMCNT_PACMAT, CURRENT_DSDCN_PACMAT)=(SELECT MAX(NUMCNT), MAX(DSDCN) FROM DIC_ADM_CONTRAT WHERE DIC_ADM_CONTRAT.NUMPAC=SECUPACMAT_TMP_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT.PACMAT=SECUPACMAT_TMP_CONTRAT.PACMAT AND v_dateEff BETWEEN DSDCN AND NVL(DSFCN, TO_DATE('20991231','yyyymmdd')));
    UPDATE SECUPACMAT_TMP_CONTRAT SET (CURRENT_NUMCNT_PACMAT, CURRENT_DSDCN_PACMAT)=(SELECT MIN(NUMCNT), MIN(DSDCN) FROM DIC_ADM_CONTRAT WHERE DIC_ADM_CONTRAT.NUMPAC=SECUPACMAT_TMP_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT.PACMAT=SECUPACMAT_TMP_CONTRAT.PACMAT AND DSDCN>v_dateEff) WHERE CURRENT_NUMCNT_PACMAT IS NULL;
    UPDATE SECUPACMAT_TMP_CONTRAT SET (CURRENT_NUMCNT_PACMAT, CURRENT_DSDCN_PACMAT)=(SELECT MAX(NUMCNT), MAX(DSDCN) FROM DIC_ADM_CONTRAT WHERE DIC_ADM_CONTRAT.NUMPAC=SECUPACMAT_TMP_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT.PACMAT=SECUPACMAT_TMP_CONTRAT.PACMAT AND DSDCN<v_dateEff) WHERE CURRENT_NUMCNT_PACMAT IS NULL;

    -- On met à jour DATE_EFF_CONTRAT_PACMAT dans la table temporaire (date effet courante du contrat courant pour le NUMPAC/PACMAT)
    UPDATE SECUPACMAT_TMP_CONTRAT SET DATE_EFF_CONTRAT_PACMAT=(SELECT MAX(DATE_EFF) FROM DIC_ADM_CONTRAT_HISTO WHERE DIC_ADM_CONTRAT_HISTO.NUMPAC=SECUPACMAT_TMP_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT_HISTO.PACMAT=SECUPACMAT_TMP_CONTRAT.PACMAT AND DIC_ADM_CONTRAT_HISTO.NUMCNT=SECUPACMAT_TMP_CONTRAT.CURRENT_NUMCNT_PACMAT AND v_dateEff BETWEEN DATE_EFF AND DATE_FIN) WHERE CURRENT_NUMCNT_PACMAT IS NOT NULL;
    UPDATE SECUPACMAT_TMP_CONTRAT SET DATE_EFF_CONTRAT_PACMAT=(SELECT MIN(DATE_EFF) FROM DIC_ADM_CONTRAT_HISTO WHERE DIC_ADM_CONTRAT_HISTO.NUMPAC=SECUPACMAT_TMP_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT_HISTO.PACMAT=SECUPACMAT_TMP_CONTRAT.PACMAT AND DIC_ADM_CONTRAT_HISTO.NUMCNT=SECUPACMAT_TMP_CONTRAT.CURRENT_NUMCNT_PACMAT AND DATE_EFF>v_dateEff) WHERE CURRENT_NUMCNT_PACMAT IS NOT NULL AND DATE_EFF_CONTRAT_PACMAT IS NULL;
    UPDATE SECUPACMAT_TMP_CONTRAT SET DATE_EFF_CONTRAT_PACMAT=(SELECT MAX(DATE_EFF) FROM DIC_ADM_CONTRAT_HISTO WHERE DIC_ADM_CONTRAT_HISTO.NUMPAC=SECUPACMAT_TMP_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT_HISTO.PACMAT=SECUPACMAT_TMP_CONTRAT.PACMAT AND DIC_ADM_CONTRAT_HISTO.NUMCNT=SECUPACMAT_TMP_CONTRAT.CURRENT_NUMCNT_PACMAT AND DATE_EFF<v_dateEff) WHERE CURRENT_NUMCNT_PACMAT IS NOT NULL AND DATE_EFF_CONTRAT_PACMAT IS NULL;
    UPDATE SECUPACMAT_TMP_CONTRAT SET DATE_EFF_CONTRAT_PACMAT=(SELECT DSDCN FROM DIC_ADM_CONTRAT WHERE DIC_ADM_CONTRAT.NUMPAC=SECUPACMAT_TMP_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT.PACMAT=SECUPACMAT_TMP_CONTRAT.PACMAT AND DIC_ADM_CONTRAT.NUMCNT=SECUPACMAT_TMP_CONTRAT.CURRENT_NUMCNT_PACMAT) WHERE CURRENT_NUMCNT_PACMAT IS NOT NULL AND DATE_EFF_CONTRAT_PACMAT IS NULL;

    -- On met à jour PRIORITE_SITUATION dans la table temporaire (Différence en jour entre la date de début du contrat courant pour le NUMPAC/PACMAT et la date de début du contrat courant pour le MATRIC)
    UPDATE SECUPACMAT_TMP_CONTRAT SET PRIORITE_SITUATION=(CURRENT_DSDCN_PACMAT-CURRENT_DSDCN_MATRIC) WHERE CURRENT_DSDCN_PACMAT IS NOT NULL AND CURRENT_DSDCN_MATRIC IS NOT NULL;
    UPDATE SECUPACMAT_TMP_CONTRAT SET PRIORITE_SITUATION=0 WHERE CURRENT_DSDCN_PACMAT IS NULL AND CURRENT_DSDCN_MATRIC IS NULL;
    UPDATE SECUPACMAT_TMP_CONTRAT SET PRIORITE_SITUATION=(WITH LIST_NUMPAC AS (SELECT NUMPAC, ROWNUM AS RN FROM (SELECT NUMPAC FROM TGE_REF_PAC ORDER BY NUMPAC DESC) UNION SELECT '*', 999999999 FROM DUAL WHERE NOT EXISTS (SELECT 1 FROM TGE_REF_PAC WHERE NUMPAC='*')) SELECT RN-(SELECT MIN(RN) FROM LIST_NUMPAC WHERE NUMPAC IN (SELECT NUMPAC FROM SECUPACMAT_TMP_CONTRAT T WHERE T.MATRIC=SECUPACMAT_TMP_CONTRAT.MATRIC)) FROM LIST_NUMPAC WHERE LIST_NUMPAC.NUMPAC=SECUPACMAT_TMP_CONTRAT.NUMPAC) WHERE PRIORITE_SITUATION=0 AND MATRIC IN (SELECT MATRIC FROM (SELECT MATRIC, COUNT(*) AS NB_SIT_0 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.PRIORITE_SITUATION=0 GROUP BY MATRIC) WHERE NB_SIT_0>1);

    -- On met à jour CURRENT_NUMCNT, DATE_EFF_CONTRAT et PRIORITE_SITUATION de SECUPACMAT (ou SECUPACMAT_TMP)
    IF p_alimTmp=0 THEN
      UPDATE SECUPACMAT     SET (CURRENT_NUMCNT,DATE_EFF_CONTRAT,PRIORITE_SITUATION)=(SELECT CURRENT_NUMCNT_PACMAT,DATE_EFF_CONTRAT_PACMAT,PRIORITE_SITUATION FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=SECUPACMAT    .NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=SECUPACMAT    .PACMAT) WHERE EXISTS (SELECT 1 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=SECUPACMAT    .NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=SECUPACMAT    .PACMAT);
      UPDATE SECUPACMAT     SET PRIORITE_SITUATION=0 WHERE PRIORITE_SITUATION IS NULL AND NOT EXISTS (SELECT 1 FROM SECUPACMAT     S WHERE PRIORITE_SITUATION=0 AND S.MATRIC=SECUPACMAT    .MATRIC);
      UPDATE SECUPACMAT     SET PRIORITE_SITUATION=99 WHERE PRIORITE_SITUATION IS NULL;
      UPDATE SECUPACMAT     SET PRIORITE_SITUATION=0 WHERE NUMPAC='TMPPAC';
    ELSE
      UPDATE SECUPACMAT_TMP SET (CURRENT_NUMCNT,DATE_EFF_CONTRAT,PRIORITE_SITUATION)=(SELECT CURRENT_NUMCNT_PACMAT,DATE_EFF_CONTRAT_PACMAT,PRIORITE_SITUATION FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=SECUPACMAT_TMP.NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=SECUPACMAT_TMP.PACMAT) WHERE EXISTS (SELECT 1 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=SECUPACMAT_TMP.NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=SECUPACMAT_TMP.PACMAT);
      UPDATE SECUPACMAT_TMP SET PRIORITE_SITUATION=0 WHERE PRIORITE_SITUATION IS NULL AND NOT EXISTS (SELECT 1 FROM SECUPACMAT_TMP S WHERE PRIORITE_SITUATION=0 AND S.MATRIC=SECUPACMAT_TMP.MATRIC);
      UPDATE SECUPACMAT_TMP SET PRIORITE_SITUATION=99 WHERE PRIORITE_SITUATION IS NULL;
      UPDATE SECUPACMAT_TMP SET PRIORITE_SITUATION=0 WHERE NUMPAC='TMPPAC';
    END IF;

    -- On met à jour DATE_EFF_CONTRAT de DIC_ADM_CONTRAT
    UPDATE DIC_ADM_CONTRAT SET TYPE_WRITER='N', DATE_EFF_CONTRAT=(SELECT MAX(DATE_EFF) FROM DIC_ADM_CONTRAT_HISTO WHERE DIC_ADM_CONTRAT_HISTO.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT_HISTO.PACMAT=DIC_ADM_CONTRAT.PACMAT AND DIC_ADM_CONTRAT_HISTO.NUMCNT=DIC_ADM_CONTRAT.NUMCNT AND v_dateEff BETWEEN DATE_EFF AND DATE_FIN) WHERE EXISTS (SELECT 1 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=DIC_ADM_CONTRAT.PACMAT);
    UPDATE DIC_ADM_CONTRAT SET TYPE_WRITER='N', DATE_EFF_CONTRAT=(SELECT MIN(DATE_EFF) FROM DIC_ADM_CONTRAT_HISTO WHERE DIC_ADM_CONTRAT_HISTO.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT_HISTO.PACMAT=DIC_ADM_CONTRAT.PACMAT AND DIC_ADM_CONTRAT_HISTO.NUMCNT=DIC_ADM_CONTRAT.NUMCNT AND DATE_EFF>v_dateEff) WHERE DATE_EFF_CONTRAT IS NULL AND EXISTS (SELECT 1 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=DIC_ADM_CONTRAT.PACMAT);
    UPDATE DIC_ADM_CONTRAT SET TYPE_WRITER='N', DATE_EFF_CONTRAT=(SELECT MAX(DATE_EFF) FROM DIC_ADM_CONTRAT_HISTO WHERE DIC_ADM_CONTRAT_HISTO.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT_HISTO.PACMAT=DIC_ADM_CONTRAT.PACMAT AND DIC_ADM_CONTRAT_HISTO.NUMCNT=DIC_ADM_CONTRAT.NUMCNT AND DATE_EFF<v_dateEff) WHERE DATE_EFF_CONTRAT IS NULL AND EXISTS (SELECT 1 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=DIC_ADM_CONTRAT.PACMAT);
    UPDATE DIC_ADM_CONTRAT SET TYPE_WRITER='N', DATE_EFF_CONTRAT=DSDCN WHERE DATE_EFF_CONTRAT IS NULL AND EXISTS (SELECT 1 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=DIC_ADM_CONTRAT.PACMAT);
    UPDATE DIC_ADM_CONTRAT SET TYPE_WRITER='N', CURRENT_PAIEZAD=(SELECT PAIEZAD FROM DIC_ADM_CONTRAT_HISTO WHERE DIC_ADM_CONTRAT_HISTO.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND DIC_ADM_CONTRAT_HISTO.PACMAT=DIC_ADM_CONTRAT.PACMAT AND DIC_ADM_CONTRAT_HISTO.NUMCNT=DIC_ADM_CONTRAT.NUMCNT AND DIC_ADM_CONTRAT_HISTO.DATE_EFF=DIC_ADM_CONTRAT.DATE_EFF_CONTRAT) WHERE EXISTS (SELECT 1 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.NUMPAC=DIC_ADM_CONTRAT.NUMPAC AND SECUPACMAT_TMP_CONTRAT.PACMAT=DIC_ADM_CONTRAT.PACMAT);

    -- On met à jour CURRENT_NUMPAC, CURRENT_PACMAT, CURRENT_NUMCNT et DATE_EFF_CONTRAT de DIC_ADM_PERSO
    UPDATE DIC_ADM_PERSO SET TYPE_WRITER='N', (CURRENT_NUMPAC, CURRENT_PACMAT, CURRENT_NUMCNT, DATE_EFF_CONTRAT)=(SELECT NUMPAC, PACMAT, CURRENT_NUMCNT_PACMAT, DATE_EFF_CONTRAT_PACMAT FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.MATRIC=DIC_ADM_PERSO.MATRIC AND SECUPACMAT_TMP_CONTRAT.PRIORITE_SITUATION=0) WHERE EXISTS (SELECT 1 FROM SECUPACMAT_TMP_CONTRAT WHERE SECUPACMAT_TMP_CONTRAT.MATRIC=DIC_ADM_PERSO.MATRIC);

    IF p_majDataContrat=1 THEN
      -- 7) On met à jour les données CONTRAT
      SECNAV_MAJ_DATA_CONTRAT(p_alimTmp);
    END IF;
    IF p_majDataContratHisto=1 THEN
      -- 8) On met à jour les données CONTRAT_HISTO
      SECNAV_MAJ_DATA_CONTRAT_HISTO(p_alimTmp);
      /*récupération de la varsys NB_EXTENSION_DACH*/
	 SELECT
	 to_number(valvar)
	 INTO nbtabledach
	 FROM
	 sys_varsys
	 WHERE
	 codvar = 'NB_EXTENSION_DACH'
	 AND module = 'SYS';	
	 IF ( nbtabledach > 0 AND nbtabledach < 6 ) THEN
	 	v_count := 1;
	 	WHILE ( v_count <= nbtabledach ) LOOP
		 EXECUTE IMMEDIATE( 'CALL SECNAV_MAJ_DATA_CONTRAT_HISTO'|| v_count ||'(' || p_alimTmp || ')');
		 v_count := v_count + 1;
		END LOOP;
	 END IF;
    END IF;
  ELSE
    -- On insère dans la table temporaire les NUMPAC/PACMAT/MATRIC des enregistrements à mettre à jour
    IF p_matric IS NULL THEN
      IF p_alimTmp=0 THEN
        INSERT INTO SECUPACMAT_TMP_CONTRAT (NUMPAC, PACMAT, MATRIC) SELECT DISTINCT NUMPAC, PACMAT, MATRIC FROM SECUPACMAT    ;
      ELSE
        INSERT INTO SECUPACMAT_TMP_CONTRAT (NUMPAC, PACMAT, MATRIC) SELECT DISTINCT NUMPAC, PACMAT, MATRIC FROM SECUPACMAT_TMP;
      END IF;
    ELSE
      IF p_alimTmp=0 THEN
        INSERT INTO SECUPACMAT_TMP_CONTRAT (NUMPAC, PACMAT, MATRIC) SELECT DISTINCT NUMPAC, PACMAT, MATRIC FROM SECUPACMAT     WHERE MATRIC=p_matric;
      ELSE
        INSERT INTO SECUPACMAT_TMP_CONTRAT (NUMPAC, PACMAT, MATRIC) SELECT DISTINCT NUMPAC, PACMAT, MATRIC FROM SECUPACMAT_TMP WHERE MATRIC=p_matric;
      END IF;
    END IF;
    IF SQL%ROWCOUNT>0 THEN
      SECNAV_MAJ_CURRENT_CONTRAT('DO_MAJ', p_majDataContrat, p_majDataContratHisto, p_alimTmp);
      -- DIT 47820 : SECUPACMAT_TMP_CONTRAT is a temporary table 
      -- Truncate table instead of deleting 
      EXECUTE_IMMEDIATE_STRING( 'TRUNCATE  TABLE SECUPACMAT_TMP_CONTRAT',0);
    END IF;
  END IF;
END SECNAV_MAJ_CURRENT_CONTRAT;
