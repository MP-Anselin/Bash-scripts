##
SECNAV_MAJ_CURRENT_PERSO
=SQL=
CREATE OR REPLACE PROCEDURE SECNAV_MAJ_CURRENT_PERSO(p_matric VARCHAR2, p_majDataPerso NUMBER, p_majDataPersoHisto NUMBER, p_alimTmp NUMBER) AS
  v_dateEff DATE;
BEGIN
  IF p_matric='DO_MAJ' THEN
    -- On se met à minuit
    v_dateEff := TO_DATE(TO_CHAR(SYSDATE,'yyyymmdd'),'yyyymmdd');

    -- On met à jour DATE_EFF_PERSO dans la table temporaire
    UPDATE SECUPACMAT_TMP_PERSO SET DATE_EFF_PERSO=(SELECT MAX(DATE_EFF) FROM DIC_ADM_PERSO_HISTO WHERE DIC_ADM_PERSO_HISTO.MATRIC=SECUPACMAT_TMP_PERSO.MATRIC AND v_dateEff BETWEEN DATE_EFF AND DATE_FIN);
    UPDATE SECUPACMAT_TMP_PERSO SET DATE_EFF_PERSO=(SELECT MIN(DATE_EFF) FROM DIC_ADM_PERSO_HISTO WHERE DIC_ADM_PERSO_HISTO.MATRIC=SECUPACMAT_TMP_PERSO.MATRIC AND DATE_EFF>v_dateEff) WHERE DATE_EFF_PERSO IS NULL;
    UPDATE SECUPACMAT_TMP_PERSO SET DATE_EFF_PERSO=(SELECT MAX(DATE_EFF) FROM DIC_ADM_PERSO_HISTO WHERE DIC_ADM_PERSO_HISTO.MATRIC=SECUPACMAT_TMP_PERSO.MATRIC AND DATE_EFF<v_dateEff) WHERE DATE_EFF_PERSO IS NULL;
    UPDATE SECUPACMAT_TMP_PERSO SET DATE_EFF_PERSO=(SELECT DSNAI FROM DIC_ADM_PERSO WHERE DIC_ADM_PERSO.MATRIC=SECUPACMAT_TMP_PERSO.MATRIC) WHERE DATE_EFF_PERSO IS NULL;

    -- On met à jour DATE_EFF_PERSO de SECUPACMAT (ou SECUPACMAT_TMP)
    IF p_alimTmp=0 THEN
      UPDATE SECUPACMAT     SET DATE_EFF_PERSO=(SELECT DATE_EFF_PERSO FROM SECUPACMAT_TMP_PERSO WHERE SECUPACMAT_TMP_PERSO.MATRIC=SECUPACMAT    .MATRIC) WHERE EXISTS (SELECT * FROM SECUPACMAT_TMP_PERSO WHERE SECUPACMAT_TMP_PERSO.MATRIC=SECUPACMAT    .MATRIC);
    ELSE
      UPDATE SECUPACMAT_TMP SET DATE_EFF_PERSO=(SELECT DATE_EFF_PERSO FROM SECUPACMAT_TMP_PERSO WHERE SECUPACMAT_TMP_PERSO.MATRIC=SECUPACMAT_TMP.MATRIC) WHERE EXISTS (SELECT * FROM SECUPACMAT_TMP_PERSO WHERE SECUPACMAT_TMP_PERSO.MATRIC=SECUPACMAT_TMP.MATRIC);
    END IF;

    -- On met à jour DATE_EFF_PERSO de DIC_ADM_PERSO
    UPDATE DIC_ADM_PERSO SET TYPE_WRITER='N', DATE_EFF_PERSO=(SELECT DATE_EFF_PERSO FROM SECUPACMAT_TMP_PERSO WHERE SECUPACMAT_TMP_PERSO.MATRIC=DIC_ADM_PERSO.MATRIC) WHERE EXISTS (SELECT * FROM SECUPACMAT_TMP_PERSO WHERE SECUPACMAT_TMP_PERSO.MATRIC=DIC_ADM_PERSO.MATRIC);

    IF p_majDataPerso=1 THEN
      -- 3) On met à jour les données PERSO
      SECNAV_MAJ_DATA_PERSO(p_alimTmp);
    END IF;
    IF p_majDataPersoHisto=1 THEN
      -- 4) On met à jour les données PERSO_HISTO
      SECNAV_MAJ_DATA_PERSO_HISTO(p_alimTmp);
    END IF;
  ELSE
    -- On insère dans la table temporaire le MATRIC à mettre à jour
    IF p_matric IS NULL THEN
      IF p_alimTmp=0 THEN
        INSERT INTO SECUPACMAT_TMP_PERSO (MATRIC) SELECT DISTINCT MATRIC FROM SECUPACMAT    ;
      ELSE
        INSERT INTO SECUPACMAT_TMP_PERSO (MATRIC) SELECT DISTINCT MATRIC FROM SECUPACMAT_TMP;
      END IF;
    ELSE
      INSERT INTO SECUPACMAT_TMP_PERSO (MATRIC) SELECT p_matric FROM DUAL;
    END IF;
    IF SQL%ROWCOUNT>0 THEN
      SECNAV_MAJ_CURRENT_PERSO('DO_MAJ', p_majDataPerso, p_majDataPersoHisto, p_alimTmp);
      IF p_matric IS NULL THEN
        DELETE FROM SECUPACMAT_TMP_PERSO;
      ELSE
        DELETE FROM SECUPACMAT_TMP_PERSO WHERE MATRIC=p_matric;
      END IF;
    END IF;
  END IF;
END SECNAV_MAJ_CURRENT_PERSO;
