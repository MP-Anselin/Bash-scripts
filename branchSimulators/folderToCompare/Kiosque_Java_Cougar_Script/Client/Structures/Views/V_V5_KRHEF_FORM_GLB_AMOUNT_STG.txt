##
V_V5_KRHEF_FORM_GLB_AMOUNT_STG
=SQL=
CREATE OR REPLACE VIEW V_V5_KRHEF_FORM_GLB_AMOUNT_STG ("ID_INSCRIPTION_REF","ID_SESSION_REF","ORDRE_PLAN","COUT_GLOBAL","RESTANT_EMPLOYEUR","TOTAL_COUT","TOTAL_FINANCEMENT","TOTAL_PEC","TOTAL_REMBOURSEMENT","MAINTIEN_SALAIRE_STAGIAIRE","SALAIRE_HTT","FONCTIONNEMENT_PEDAGO","HEBERGEMENT_RESTAURATION","TRANSPORT","MATERIEL","TUTORAT","COUT_FORMATEUR","FRAIS_PERSO_FORMATEUR_INT","FRAIS_PERSO_FORMATEUR_EXT","LOCAUX_ENTRETIEN","ORGANISATION_ADMINISTRATIVE","FIN_MAINTIEN_SALAIRE_STAGIAIRE","FIN_SALAIRE_HTT","FIN_FONCTIONNEMENT_PEDAGO","FIN_HEBERGEMENT_RESTAURATION","FIN_TRANSPORT","FIN_MATERIEL","FIN_TUTORAT","FIN_COUT_FORMATEUR","FIN_FRAIS_PERSO_FORMATEUR_INT","FIN_FRAIS_PERSO_FORMATEUR_EXT","FIN_LOCAUX_ENTRETIEN","FIN_ORGANISATION_ADMIN","PEC_MAINTIEN_SALAIRE_STAGIAIRE","PEC_SALAIRE_HTT","PEC_FONCTIONNEMENT_PEDAGO","PEC_HEBERGEMENT_RESTAURATION","PEC_TRANSPORT","PEC_MATERIEL","PEC_TUTORAT","PEC_COUT_FORMATEUR","PEC_FRAIS_PERSO_FORMATEUR_INT","PEC_FRAIS_PERSO_FORMATEUR_EXT","PEC_LOCAUX_ENTRETIEN","PEC_ORGANISATION_ADMIN","RBT_MAINTIEN_SALAIRE_STAGIAIRE","RBT_SALAIRE_HTT","RBT_FONCTIONNEMENT_PEDAGO","RBT_HEBERGEMENT_RESTAURATION","RBT_TRANSPORT","RBT_MATERIEL","RBT_TUTORAT","RBT_COUT_FORMATEUR","RBT_FRAIS_PERSO_FORMATEUR_INT","RBT_FRAIS_PERSO_FORMATEUR_EXT","RBT_LOCAUX_ENTRETIEN","RBT_ORGANISATION_ADMIN") AS 
select cout.ID_INSCRIPTION_REF
         , cout.ID_SESSION_REF
         , cout.ORDRE_PLAN

         -- Calcul dynamique du cout global et restant employeur
         -- (Les valeurs stockées dans T_V5_KRHEF_FORMATION_COUT ne sont pas
         --  toujours correctement mises à jour par le PHP)
         ,   sum(nvl(cout.TOTAL_COUT, 0))
           + sum(nvl(fin.TOTAL_FINANCEMENT, 0))
           as COUT_GLOBAL

         ,   sum(nvl(cout.TOTAL_COUT, 0))
           + sum(nvl(fin.TOTAL_FINANCEMENT, 0))
           - sum(nvl(cout.TOTAL_PEC, 0))
           - sum(nvl(fin.TOTAL_REMBOURSEMENT, 0))
           as RESTANT_EMPLOYEUR

         -- Totaux des couts / financements / PEC / remboursements
         , sum(nvl(cout.TOTAL_COUT, 0)) as TOTAL_COUT
         , sum(nvl(fin.TOTAL_FINANCEMENT, 0)) as TOTAL_FINANCEMENT
         , sum(nvl(cout.TOTAL_PEC, 0)) as TOTAL_PEC
         , sum(nvl(fin.TOTAL_REMBOURSEMENT, 0)) as TOTAL_REMBOURSEMENT

         -- Détail des couts
         , sum(nvl(cout.MAINTIEN_SALAIRE_STAGIAIRE, 0)) as MAINTIEN_SALAIRE_STAGIAIRE
         , sum(nvl(cout.SALAIRE_HTT, 0)) as SALAIRE_HTT
         , sum(nvl(cout.FONCTIONNEMENT_PEDAGO, 0)) as FONCTIONNEMENT_PEDAGO
         , sum(nvl(cout.HEBERGEMENT_RESTAURATION, 0)) as HEBERGEMENT_RESTAURATION
         , sum(nvl(cout.TRANSPORT, 0)) as TRANSPORT
         , sum(nvl(cout.MATERIEL, 0)) as MATERIEL
         , sum(nvl(cout.TUTORAT, 0)) as TUTORAT
         , sum(nvl(cout.COUT_FORMATEUR, 0)) as COUT_FORMATEUR
         , sum(nvl(cout.FRAIS_PERSO_FORMATEUR_INT, 0)) as FRAIS_PERSO_FORMATEUR_INT
         , sum(nvl(cout.FRAIS_PERSO_FORMATEUR_EXT, 0)) as FRAIS_PERSO_FORMATEUR_EXT
         , sum(nvl(cout.LOCAUX_ENTRETIEN, 0)) as LOCAUX_ENTRETIEN
         , sum(nvl(cout.ORGANISATION_ADMINISTRATIVE, 0)) as ORGANISATION_ADMINISTRATIVE

         -- Détail des financements
         , sum(nvl(fin.FIN_MAINTIEN_SALAIRE_STAGIAIRE, 0)) as FIN_MAINTIEN_SALAIRE_STAGIAIRE
         , sum(nvl(fin.FIN_SALAIRE_HTT, 0)) as FIN_SALAIRE_HTT
         , sum(nvl(fin.FIN_FONCTIONNEMENT_PEDAGO, 0)) as FIN_FONCTIONNEMENT_PEDAGO
         , sum(nvl(fin.FIN_HEBERGEMENT_RESTAURATION, 0)) as FIN_HEBERGEMENT_RESTAURATION
         , sum(nvl(fin.FIN_TRANSPORT, 0)) as FIN_TRANSPORT
         , sum(nvl(fin.FIN_MATERIEL, 0)) as FIN_MATERIEL
         , sum(nvl(fin.FIN_TUTORAT, 0)) as FIN_TUTORAT
         , sum(nvl(fin.FIN_COUT_FORMATEUR, 0)) as FIN_COUT_FORMATEUR
         , sum(nvl(fin.FIN_FRAIS_PERSO_FORMATEUR_INT, 0)) as FIN_FRAIS_PERSO_FORMATEUR_INT
         , sum(nvl(fin.FIN_FRAIS_PERSO_FORMATEUR_EXT, 0)) as FIN_FRAIS_PERSO_FORMATEUR_EXT
         , sum(nvl(fin.FIN_LOCAUX_ENTRETIEN, 0)) as FIN_LOCAUX_ENTRETIEN
         , sum(nvl(fin.FIN_ORGANISATION_ADMIN, 0)) as FIN_ORGANISATION_ADMIN

         -- Détail des PEC
         , sum(cout.PEC_MAINTIEN_SALAIRE_STAGIAIRE) as PEC_MAINTIEN_SALAIRE_STAGIAIRE
         , sum(cout.PEC_SALAIRE_HTT) as PEC_SALAIRE_HTT
         , sum(cout.PEC_FONCTIONNEMENT_PEDAGO) as PEC_FONCTIONNEMENT_PEDAGO
         , sum(cout.PEC_HEBERGEMENT_RESTAURATION) as PEC_HEBERGEMENT_RESTAURATION
         , sum(cout.PEC_TRANSPORT) as PEC_TRANSPORT
         , sum(cout.PEC_MATERIEL) as PEC_MATERIEL
         , sum(cout.PEC_TUTORAT) as PEC_TUTORAT
         , sum(cout.PEC_COUT_FORMATEUR) as PEC_COUT_FORMATEUR
         , sum(cout.PEC_FRAIS_PERSO_FORMATEUR_INT) as PEC_FRAIS_PERSO_FORMATEUR_INT
         , sum(cout.PEC_FRAIS_PERSO_FORMATEUR_EXT) as PEC_FRAIS_PERSO_FORMATEUR_EXT
         , sum(cout.PEC_LOCAUX_ENTRETIEN) as PEC_LOCAUX_ENTRETIEN
         , sum(cout.PEC_ORGANISATION_ADMIN) as PEC_ORGANISATION_ADMIN

         -- Détail des remboursemements
         , sum(nvl(fin.RBT_MAINTIEN_SALAIRE_STAGIAIRE, 0)) as RBT_MAINTIEN_SALAIRE_STAGIAIRE
         , sum(nvl(fin.RBT_SALAIRE_HTT, 0)) as RBT_SALAIRE_HTT
         , sum(nvl(fin.RBT_FONCTIONNEMENT_PEDAGO, 0)) as RBT_FONCTIONNEMENT_PEDAGO
         , sum(nvl(fin.RBT_HEBERGEMENT_RESTAURATION, 0)) as RBT_HEBERGEMENT_RESTAURATION
         , sum(nvl(fin.RBT_TRANSPORT, 0)) as RBT_TRANSPORT
         , sum(nvl(fin.RBT_MATERIEL, 0)) as RBT_MATERIEL
         , sum(nvl(fin.RBT_TUTORAT, 0)) as RBT_TUTORAT
         , sum(nvl(fin.RBT_COUT_FORMATEUR, 0)) as RBT_COUT_FORMATEUR
         , sum(nvl(fin.RBT_FRAIS_PERSO_FORMATEUR_INT, 0)) as RBT_FRAIS_PERSO_FORMATEUR_INT
         , sum(nvl(fin.RBT_FRAIS_PERSO_FORMATEUR_EXT, 0)) as RBT_FRAIS_PERSO_FORMATEUR_EXT
         , sum(nvl(fin.RBT_LOCAUX_ENTRETIEN, 0)) as RBT_LOCAUX_ENTRETIEN
         , sum(nvl(fin.RBT_ORGANISATION_ADMIN, 0)) as RBT_ORGANISATION_ADMIN

      from -- Regroupement des couts et PEC par collaborateur / session / plan
           V_V5_KRHEF_FORM_GLB_COUT_STG cout
           -- Regroupement des financements et remboursements par collaborateur / session / plan
 left join V_V5_KRHEF_FORM_GLB_FIN_STG fin
        on fin.ID_INSCRIPTION_REF = cout.ID_INSCRIPTION_REF
       and fin.ORDRE_PLAN = cout.ORDRE_PLAN
     group by cout.ID_INSCRIPTION_REF
         , cout.ID_SESSION_REF
         , cout.ORDRE_PLAN
