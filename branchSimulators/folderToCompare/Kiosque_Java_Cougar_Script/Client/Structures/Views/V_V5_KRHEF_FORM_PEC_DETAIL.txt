##
V_V5_KRHEF_FORM_PEC_DETAIL
=SQL=
CREATE OR REPLACE VIEW V_V5_KRHEF_FORM_PEC_DETAIL ("FROM_FINANCEMENT","ID_SESSION","ID_PLAN","NUM_SEQ","COLLABORATEUR","ID_INSCRIPTION","ID_AFF_BDG_TYPE","DISPOSITIF","ID_AFF_BDG_DETAIL","CODE_SOCIETE","ORGANISME_PEC","MONTANT_PRISE_EN_CHARGE","PEC_TRANSPORT","PEC_MAINTIEN_SALAIRE_STAGIAIRE","PEC_TUTORAT","PEC_SALAIRE_HTT","PEC_ORGANISATION_ADMIN","PEC_RESTANT_EMPLOYEUR","PEC_LOCAUX_ENTRETIEN","PEC_FRAIS_PERSO_FORMATEUR_INT","PEC_FRAIS_PERSO_FORMATEUR_EXT","PEC_FONCTIONNEMENT_PEDAGO","PEC_HEBERGEMENT_RESTAURATION","PEC_MATERIEL","PEC_COUT_FORMATEUR","FIN_TRANSPORT","FIN_MAINTIEN_SALAIRE_STAGIAIRE","FIN_TUTORAT","FIN_SALAIRE_HTT","FIN_ORGANISATION_ADMIN","FIN_RESTANT_EMPLOYEUR","FIN_LOCAUX_ENTRETIEN","FIN_FRAIS_PERSO_FORMATEUR_INT","FIN_FRAIS_PERSO_FORMATEUR_EXT","FIN_FONCTIONNEMENT_PEDAGO","FIN_HEBERGEMENT_RESTAURATION","FIN_MATERIEL","FIN_COUT_FORMATEUR") AS 
select
  1 as FROM_FINANCEMENT,
  fc.ID_SESSION,
  ins_seq.ID_PLAN,
  fc.NUM_SEQ,
  fc.COLLABORATEUR,
  ins_seq.ID_INSCRIPTION_SEQ as ID_INSCRIPTION,
  fc.ID_AFF_BDG_TYPE,
  fc.DISPOSITIF,
  null as ID_AFF_BDG_DETAIL,  -- Pas d affectation budgetaire particuliere pour les financements
  fc.CODE_SOCIETE,
  fc.ID_ORGANISME as ORGANISME_PEC,
  case
    when fc.TYPE_FINANCEMENT = 'F' then 0
    else nvl(PEC_TRANSPORT, 0) + nvl(PEC_MAINTIEN_SALAIRE_STAGIAIRE, 0) + nvl(PEC_TUTORAT, 0) + nvl(PEC_SALAIRE_HTT, 0) + nvl(PEC_ORGANISATION_ADMIN, 0) + nvl(PEC_RESTANT_EMPLOYEUR, 0) + nvl(PEC_LOCAUX_ENTRETIEN, 0) + nvl(PEC_FRAIS_PERSO_FORMATEUR_INT, 0) + nvl(PEC_FRAIS_PERSO_FORMATEUR_EXT, 0) + nvl(PEC_FONCTIONNEMENT_PEDAGO, 0) + nvl(PEC_HEBERGEMENT_RESTAURATION, 0) + nvl(PEC_MATERIEL, 0) + nvl(PEC_COUT_FORMATEUR, 0)
  end as MONTANT_PRISE_EN_CHARGE,
  case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_TRANSPORT, 0) else 0 end as PEC_TRANSPORT, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_MAINTIEN_SALAIRE_STAGIAIRE, 0) else 0 end as PEC_MAINTIEN_SALAIRE_STAGIAIRE, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_TUTORAT, 0) else 0 end as PEC_TUTORAT, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_SALAIRE_HTT, 0) else 0 end as PEC_SALAIRE_HTT, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_ORGANISATION_ADMIN, 0) else 0 end as PEC_ORGANISATION_ADMIN, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_RESTANT_EMPLOYEUR, 0) else 0 end as PEC_RESTANT_EMPLOYEUR, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_LOCAUX_ENTRETIEN, 0) else 0 end as PEC_LOCAUX_ENTRETIEN, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_FRAIS_PERSO_FORMATEUR_INT, 0) else 0 end as PEC_FRAIS_PERSO_FORMATEUR_INT, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_FRAIS_PERSO_FORMATEUR_EXT, 0) else 0 end as PEC_FRAIS_PERSO_FORMATEUR_EXT, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_FONCTIONNEMENT_PEDAGO, 0) else 0 end as PEC_FONCTIONNEMENT_PEDAGO, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_HEBERGEMENT_RESTAURATION, 0) else 0 end as PEC_HEBERGEMENT_RESTAURATION, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_MATERIEL, 0) else 0 end as PEC_MATERIEL, case when fc.TYPE_FINANCEMENT = 'R' then nvl(PEC_COUT_FORMATEUR, 0) else 0 end as PEC_COUT_FORMATEUR, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_TRANSPORT, 0) else 0 end as FIN_TRANSPORT, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_MAINTIEN_SALAIRE_STAGIAIRE, 0) else 0 end as FIN_MAINTIEN_SALAIRE_STAGIAIRE, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_TUTORAT, 0) else 0 end as FIN_TUTORAT, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_SALAIRE_HTT, 0) else 0 end as FIN_SALAIRE_HTT, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_ORGANISATION_ADMIN, 0) else 0 end as FIN_ORGANISATION_ADMIN, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_RESTANT_EMPLOYEUR, 0) else 0 end as FIN_RESTANT_EMPLOYEUR, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_LOCAUX_ENTRETIEN, 0) else 0 end as FIN_LOCAUX_ENTRETIEN, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_FRAIS_PERSO_FORMATEUR_INT, 0) else 0 end as FIN_FRAIS_PERSO_FORMATEUR_INT, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_FRAIS_PERSO_FORMATEUR_EXT, 0) else 0 end as FIN_FRAIS_PERSO_FORMATEUR_EXT, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_FONCTIONNEMENT_PEDAGO, 0) else 0 end as FIN_FONCTIONNEMENT_PEDAGO, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_HEBERGEMENT_RESTAURATION, 0) else 0 end as FIN_HEBERGEMENT_RESTAURATION, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_MATERIEL, 0) else 0 end as FIN_MATERIEL, case when fc.TYPE_FINANCEMENT = 'F' then nvl(PEC_COUT_FORMATEUR, 0) else 0 end as FIN_COUT_FORMATEUR
from
  V_V5_KRHEF_FINANCEMENT_COLL fc,
  V_V5_KRHEF_FORM_INSCR ins,
  V_V5_KRHEF_FORM_INSCR_SEQ ins_seq,
  V_V5_KRHEF_SESSION ses,
  T_V5_KRHEF_AFF_BDG_TYPE abt
where ins.ID_INSCRIPTION = ins_seq.ID_INSCRIPTION
  and ins.ID_SESSION = fc.ID_SESSION
  and ins_seq.NUM_SEQ = fc.NUM_SEQ
  and ins.COLLABORATEUR = fc.COLLABORATEUR
  and ins.DATE_REPORT is null
  and ses.ID_SESSION = ins.ID_SESSION
  and fc.ID_AFF_BDG_TYPE = abt.ID_AFF_BDG_TYPE(+)
union all
select
  0 as FROM_FINANCEMENT,
  cout.ID_SESSION,
  ins.ID_PLAN,
  cout.NUM_SEQ,
  ins.COLLABORATEUR,
  cout.ID_INSCRIPTION,
  abt.ID_AFF_BDG_TYPE,
  abt.DISPOSITIF,
  cout.ID_AFF_BDG_DETAIL,
  null as CODE_SOCIETE,
  cout.ORGANISME_PEC,
  cout.MONTANT_PRISE_EN_CHARGE,
  nvl(PEC_TRANSPORT, 0) as PEC_TRANSPORT, nvl(PEC_MAINTIEN_SALAIRE_STAGIAIRE, 0) as PEC_MAINTIEN_SALAIRE_STAGIAIRE, nvl(PEC_TUTORAT, 0) as PEC_TUTORAT, nvl(PEC_SALAIRE_HTT, 0) as PEC_SALAIRE_HTT, nvl(PEC_ORGANISATION_ADMIN, 0) as PEC_ORGANISATION_ADMIN, nvl(PEC_RESTANT_EMPLOYEUR, 0) as PEC_RESTANT_EMPLOYEUR, nvl(PEC_LOCAUX_ENTRETIEN, 0) as PEC_LOCAUX_ENTRETIEN, nvl(PEC_FRAIS_PERSO_FORMATEUR_INT, 0) as PEC_FRAIS_PERSO_FORMATEUR_INT, nvl(PEC_FRAIS_PERSO_FORMATEUR_EXT, 0) as PEC_FRAIS_PERSO_FORMATEUR_EXT, nvl(PEC_FONCTIONNEMENT_PEDAGO, 0) as PEC_FONCTIONNEMENT_PEDAGO, nvl(PEC_HEBERGEMENT_RESTAURATION, 0) as PEC_HEBERGEMENT_RESTAURATION, nvl(PEC_MATERIEL, 0) as PEC_MATERIEL, nvl(PEC_COUT_FORMATEUR, 0) as PEC_COUT_FORMATEUR, 0 as FIN_TRANSPORT, 0 as FIN_MAINTIEN_SALAIRE_STAGIAIRE, 0 as FIN_TUTORAT, 0 as FIN_SALAIRE_HTT, 0 as FIN_ORGANISATION_ADMIN, 0 as FIN_RESTANT_EMPLOYEUR, 0 as FIN_LOCAUX_ENTRETIEN, 0 as FIN_FRAIS_PERSO_FORMATEUR_INT, 0 as FIN_FRAIS_PERSO_FORMATEUR_EXT, 0 as FIN_FONCTIONNEMENT_PEDAGO, 0 as FIN_HEBERGEMENT_RESTAURATION, 0 as FIN_MATERIEL, 0 as FIN_COUT_FORMATEUR
from
  T_V5_KRHEF_FORMATION_COUT cout,
  T_V5_KRHEF_AFF_BDG_DETAIL abd,
  T_V5_KRHEF_AFF_BDG_TYPE abt,
  T_V5_KRHEF_FORMATION_INSCR ins
where cout.NUM_SEQ != 0
  and cout.ID_AFF_BDG_DETAIL = abd.ID_AFF_BDG_DETAIL
  and abd.ID_AFF_BDG_TYPE = abt.ID_AFF_BDG_TYPE
  and cout.ID_INSCRIPTION = ins.ID_INSCRIPTION
