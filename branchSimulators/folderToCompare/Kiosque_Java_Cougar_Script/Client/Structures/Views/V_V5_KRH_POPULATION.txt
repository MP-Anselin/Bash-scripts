##
V_V5_KRH_POPULATION
=SQL=
  CREATE OR REPLACE VIEW V_V5_KRH_POPULATION AS 
  WITH monCollab AS (
    SELECT 
        MATRICULE,
        EST_EXPERT_ENTR,
        EST_EXPERT_FORM,
        EST_EXPERT_TAL,
        EST_GESTIONNAIRE_ENTR,
        EST_GESTIONNAIRE_FORM,
        EST_GESTIONNAIRE_TAL
    FROM V_V5_KRH_SALARIE_USER
), maPopu AS (
    SELECT DISTINCT ACTEUR,COLLABORATEUR FROM (
        SELECT T.ACTEUR,T.COLLABORATEUR FROM T_KRH_DESIGN_CLI_XP_ENTR t INNER JOIN monCollab C ON T.ACTEUR = C.MATRICULE WHERE C.EST_EXPERT_ENTR = 1 UNION ALL
        SELECT T.ACTEUR,T.COLLABORATEUR FROM T_KRH_DESIGN_CLI_XP_FORM t INNER JOIN monCollab C ON T.ACTEUR = C.MATRICULE WHERE  C.EST_EXPERT_FORM = 1 UNION ALL
        SELECT T.ACTEUR,T.COLLABORATEUR FROM T_KRH_DESIGN_CLI_XP_TAL t INNER JOIN monCollab C ON T.ACTEUR = C.MATRICULE WHERE C.EST_EXPERT_TAL = 1 UNION ALL
        SELECT T.ACTEUR,T.COLLABORATEUR FROM T_KRH_DESIGN_CLI_GEST_ENTR t INNER JOIN monCollab C ON T.ACTEUR = C.MATRICULE WHERE C.EST_GESTIONNAIRE_ENTR = 1 UNION ALL
        SELECT T.ACTEUR,T.COLLABORATEUR FROM T_KRH_DESIGN_CLI_GEST_FORM t INNER JOIN monCollab C ON T.ACTEUR = C.MATRICULE WHERE C.EST_GESTIONNAIRE_FORM = 1 UNION ALL
        SELECT T.ACTEUR,T.COLLABORATEUR FROM T_KRH_DESIGN_CLI_GEST_TAL t INNER JOIN monCollab C ON T.ACTEUR = C.MATRICULE WHERE C.EST_GESTIONNAIRE_TAL = 1
    )
)
SELECT 
    c.MATRICULE,
    p.ID_POPULATION,
    p.LIBELLE,
    (SELECT COUNT(*) FROM maPopu p3 WHERE p3.ACTEUR = C.MATRICULE AND p3.COLLABORATEUR IN (
        SELECT p2.MATRICULE FROM T_V5_KRH_POPULATION p2 WHERE p2.ID_POPULATION = p.ID_POPULATION
    )) AS NB_VIS,
    p.NOMBRE_SALARIES AS NB_TOT
FROM monCollab C, T_V5_POPULATION_DEF p
