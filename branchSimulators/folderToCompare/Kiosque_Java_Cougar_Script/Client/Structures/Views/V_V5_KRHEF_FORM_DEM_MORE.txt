##
V_V5_KRHEF_FORM_DEM_MORE
=SQL=
CREATE OR REPLACE VIEW V_V5_KRHEF_FORM_DEM_MORE ("ID_FORMATION_DEMANDE","PLAN_GELE","COLLECTIF","ID_ENT","ID_CATALOGUE","TYPE_DEMANDE","Q1","Q2","Q3","Q4","Q5","Q6","URGENCE_EXPERT","URGENCE_MANAGER","URGENCE_COLLABO","ID_ECHELLE_COLLABO","ID_ECHELLE_MANAGER","STATUT_COLLABO","STATUT_MANAGER","STATUT_EXPERT","TYPE_COUT","DIF","DISPOSITION_CIF","TRAITE_DIF","CATEGORIE","ID_ORGANISME","TOP_SESSIONS_EFFECTUEES","ID_FORM","DATE_VALID_COLLABO","DATE_VALID_MANAGER","DATE_DEMANDE","DATE_REPONSE","COLLABORATEUR","MANAGER","EXPERT","DATE_MAJ","DATE_TRAITE_DIF","MAT_TRAITE_DIF","MATRICULE_MAJ","OBJECTIF_DEMANDE","PROGRAMME_FORMATION","OBJET_DEMANDE","CODE_STAGE","LIBELLE_FORMATION","COMMENTAIRE_EXPERT","LIBELLE_ORGANISME","ID_AXE_STRATEG","MODALITE","NBRE_COLLECTIF","SOLDE_COLLECTIF","ID_REF_COLLECTIF","DOMAINE","PROFESSIONNALISATION","IMPUTABILITE","ORIGINE_DEMANDE","DEMANDE_DIF_NUMERO","ID_FORMATION_REPORT","ID_FORM_CATALOGUE","TYPE_PLURIANNUALITE","NATURE_FORMATION","CALCUL_AUTO_COUT_SALARIAL","MODALITE_EVAL_FORMATION","DATE_EDITION_DESCR_FORM","DATE_ENVOI_DESCR_FORM","INTERNE","FORMATEUR","CREATED_BY_ROLE","CREATED_BY_MATRICULE","DATE_EMAIL_TRAITE_DIF","CPF","FORM_CERTIFIANTE","FORM_QUALIFIANTE","COMMENTAIRE_EMETTEUR","WF_DEMANDE_ETAT","WF_DEMANDE_ANNUL_ETAT","OBLIGATOIRE","CPF_TRANSITION","ALTERNANCE_PRO_A","CURRENT_STATUS","ID_FORM_TAL","DEMANDE_VALIDATION_ETAT","DEMANDE_ANNULATION_ETAT","VALIDATION_DEMANDE") AS 
select /*+ NO_MERGE NO_PUSH_PRED */
ID_FORMATION_DEMANDE
, PLAN_GELE
, COLLECTIF
, ID_ENT
, ID_CATALOGUE
, TYPE_DEMANDE
, Q1
, Q2
, Q3
, Q4
, Q5
, Q6
, URGENCE_EXPERT
, URGENCE_MANAGER
, URGENCE_COLLABO
, ID_ECHELLE_COLLABO
, ID_ECHELLE_MANAGER
, STATUT_COLLABO
, STATUT_MANAGER
, STATUT_EXPERT
, TYPE_COUT
, DIF
, DISPOSITION_CIF
, TRAITE_DIF
, CATEGORIE
, ID_ORGANISME
, TOP_SESSIONS_EFFECTUEES
, ID_FORM
, DATE_VALID_COLLABO
, DATE_VALID_MANAGER
, DATE_DEMANDE
, DATE_REPONSE
, COLLABORATEUR
, MANAGER
, EXPERT
, DATE_MAJ
, DATE_TRAITE_DIF
, MAT_TRAITE_DIF
, MATRICULE_MAJ
, OBJECTIF_DEMANDE
, PROGRAMME_FORMATION
, OBJET_DEMANDE
, CODE_STAGE
, LIBELLE_FORMATION
, COMMENTAIRE_EXPERT
, LIBELLE_ORGANISME
, ID_AXE_STRATEG
, MODALITE
, NBRE_COLLECTIF
, SOLDE_COLLECTIF
, ID_REF_COLLECTIF
, DOMAINE
, PROFESSIONNALISATION
, IMPUTABILITE
, ORIGINE_DEMANDE
, DEMANDE_DIF_NUMERO
, ID_FORMATION_REPORT
, ID_FORM_CATALOGUE
, TYPE_PLURIANNUALITE
, NATURE_FORMATION
, CALCUL_AUTO_COUT_SALARIAL
, MODALITE_EVAL_FORMATION
, DATE_EDITION_DESCR_FORM
, DATE_ENVOI_DESCR_FORM
, INTERNE
, FORMATEUR
, CREATED_BY_ROLE
, CREATED_BY_MATRICULE
, DATE_EMAIL_TRAITE_DIF
, CPF
, FORM_CERTIFIANTE
, FORM_QUALIFIANTE
, COMMENTAIRE_EMETTEUR
, WF_DEMANDE_ETAT
, WF_DEMANDE_ANNUL_ETAT
, OBLIGATOIRE
, CPF_TRANSITION
, ALTERNANCE_PRO_A
, CURRENT_STATUS
, ID_FORM_TAL
 , wf.DEMANDE_VALIDATION_ETAT
 , wfAnnul.DEMANDE_ANNULATION_ETAT
 , (case -- Favorable
         when (dem.CREATED_BY_ROLE is null
               or dem.CREATED_BY_ROLE in ('gest', 'xp')
               or dem.COLLECTIF = 1
               or ID_REF_COLLECTIF is not null)
         then 3
         -- En cours de création
         when (wf.DEMANDE_VALIDATION_ETAT is null
               or wfAnnul.DEMANDE_ANNULATION_ETAT = 'O')
         then 1
         -- En attente de validation
         when (wf.DEMANDE_VALIDATION_ETAT = 'W'
               and (wfAnnul.DEMANDE_ANNULATION_ETAT is null or wfAnnul.DEMANDE_ANNULATION_ETAT = 'N'))
         then 2
         -- Favorable
         when (wf.DEMANDE_VALIDATION_ETAT = 'O')
         then 3
         -- Défavorable
         when (wf.DEMANDE_VALIDATION_ETAT = 'N')
         then 4
         -- Ne devrait jamais se produire
         else null
    end) as VALIDATION_DEMANDE
       from T_V5_KRHEF_FORM_DEMANDE dem
  left join (select to_number(ID_REFERENCE) as ID_REFERENCE,
                    DEMANDE_ETAT as DEMANDE_VALIDATION_ETAT
               from T_V5_WF_DEMANDE
              where type_demande = 'FormDemande') wf
            on dem.ID_FORMATION_DEMANDE = wf.ID_REFERENCE
  left join (select to_number(ID_REFERENCE) as ID_REFERENCE,
                    DEMANDE_ETAT as DEMANDE_ANNULATION_ETAT
               from T_V5_WF_DEMANDE
              where type_demande = 'AnnulationFormDemande') wfAnnul
       on dem.ID_FORMATION_DEMANDE = wfAnnul.ID_REFERENCE
 where dem.PLAN_GELE = 0
