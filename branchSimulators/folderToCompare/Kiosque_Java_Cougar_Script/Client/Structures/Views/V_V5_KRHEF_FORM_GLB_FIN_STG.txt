##
V_V5_KRHEF_FORM_GLB_FIN_STG
=SQL=
CREATE OR REPLACE VIEW V_V5_KRHEF_FORM_GLB_FIN_STG ("ID_INSCRIPTION_REF","ID_SESSION_REF","ORDRE_PLAN","TOTAL_FINANCEMENT","TOTAL_REMBOURSEMENT","FIN_MAINTIEN_SALAIRE_STAGIAIRE","FIN_SALAIRE_HTT","FIN_FONCTIONNEMENT_PEDAGO","FIN_HEBERGEMENT_RESTAURATION","FIN_TRANSPORT","FIN_MATERIEL","FIN_TUTORAT","FIN_COUT_FORMATEUR","FIN_FRAIS_PERSO_FORMATEUR_INT","FIN_FRAIS_PERSO_FORMATEUR_EXT","FIN_LOCAUX_ENTRETIEN","FIN_ORGANISATION_ADMIN","RBT_MAINTIEN_SALAIRE_STAGIAIRE","RBT_SALAIRE_HTT","RBT_FONCTIONNEMENT_PEDAGO","RBT_HEBERGEMENT_RESTAURATION","RBT_TRANSPORT","RBT_MATERIEL","RBT_TUTORAT","RBT_COUT_FORMATEUR","RBT_FRAIS_PERSO_FORMATEUR_INT","RBT_FRAIS_PERSO_FORMATEUR_EXT","RBT_LOCAUX_ENTRETIEN","RBT_ORGANISATION_ADMIN") AS 
select md.ID_INSCRIPTION_REF
         , ses.ID_SESSION_REF
         , md.ORDRE_PLAN

           -- Total des financements
         ,   sum(md.MAINTIEN_SALAIRE_STAGIAIRE)
           + sum(md.SALAIRE_HTT)
           + sum(md.FONCTIONNEMENT_PEDAGO)
           + sum(md.HEBERGEMENT_RESTAURATION)
           + sum(md.TRANSPORT)
           + sum(md.MATERIEL)
           + sum(md.TUTORAT)
           + sum(md.COUT_FORMATEUR)
           + sum(md.FRAIS_PERSO_FORMATEUR_INT)
           + sum(md.FRAIS_PERSO_FORMATEUR_EXT)
           + sum(md.LOCAUX_ENTRETIEN)
           + sum(md.ORGANISATION_ADMINISTRATIVE)
         as TOTAL_FINANCEMENT

         -- Total des remboursemements
         ,   sum(md.PEC_MAINTIEN_SALAIRE_STAGIAIRE)
           + sum(md.PEC_SALAIRE_HTT)
           + sum(md.PEC_FONCTIONNEMENT_PEDAGO)
           + sum(md.PEC_HEBERGEMENT_RESTAURATION)
           + sum(md.PEC_TRANSPORT)
           + sum(md.PEC_MATERIEL)
           + sum(md.PEC_TUTORAT)
           + sum(md.PEC_COUT_FORMATEUR)
           + sum(md.PEC_FRAIS_PERSO_FORMATEUR_INT)
           + sum(md.PEC_FRAIS_PERSO_FORMATEUR_EXT)
           + sum(md.PEC_LOCAUX_ENTRETIEN)
           + sum(md.PEC_ORGANISATION_ADMIN)
         as TOTAL_REMBOURSEMENT

           -- Détail des financements
         , sum(md.MAINTIEN_SALAIRE_STAGIAIRE) as FIN_MAINTIEN_SALAIRE_STAGIAIRE
         , sum(md.SALAIRE_HTT) as FIN_SALAIRE_HTT
         , sum(md.FONCTIONNEMENT_PEDAGO) as FIN_FONCTIONNEMENT_PEDAGO
         , sum(md.HEBERGEMENT_RESTAURATION) as FIN_HEBERGEMENT_RESTAURATION
         , sum(md.TRANSPORT) as FIN_TRANSPORT
         , sum(md.MATERIEL) as FIN_MATERIEL
         , sum(md.TUTORAT) as FIN_TUTORAT
         , sum(md.COUT_FORMATEUR) as FIN_COUT_FORMATEUR
         , sum(md.FRAIS_PERSO_FORMATEUR_INT) as FIN_FRAIS_PERSO_FORMATEUR_INT
         , sum(md.FRAIS_PERSO_FORMATEUR_EXT) as FIN_FRAIS_PERSO_FORMATEUR_EXT
         , sum(md.LOCAUX_ENTRETIEN) as FIN_LOCAUX_ENTRETIEN
         , sum(md.ORGANISATION_ADMINISTRATIVE) as FIN_ORGANISATION_ADMIN

         -- Détail des remboursemements
         , sum(md.PEC_MAINTIEN_SALAIRE_STAGIAIRE) as RBT_MAINTIEN_SALAIRE_STAGIAIRE
         , sum(md.PEC_SALAIRE_HTT) as RBT_SALAIRE_HTT
         , sum(md.PEC_FONCTIONNEMENT_PEDAGO) as RBT_FONCTIONNEMENT_PEDAGO
         , sum(md.PEC_HEBERGEMENT_RESTAURATION) as RBT_HEBERGEMENT_RESTAURATION
         , sum(md.PEC_TRANSPORT) as RBT_TRANSPORT
         , sum(md.PEC_MATERIEL) as RBT_MATERIEL
         , sum(md.PEC_TUTORAT) as RBT_TUTORAT
         , sum(md.PEC_COUT_FORMATEUR) as RBT_COUT_FORMATEUR
         , sum(md.PEC_FRAIS_PERSO_FORMATEUR_INT) as RBT_FRAIS_PERSO_FORMATEUR_INT
         , sum(md.PEC_FRAIS_PERSO_FORMATEUR_EXT) as RBT_FRAIS_PERSO_FORMATEUR_EXT
         , sum(md.PEC_LOCAUX_ENTRETIEN) as RBT_LOCAUX_ENTRETIEN
         , sum(md.PEC_ORGANISATION_ADMIN) as RBT_ORGANISATION_ADMIN

      from V_V5_KRHEF_FORM_MONTANT_DUREE md
      join T_V5_KRHEF_FORMATION_INSCR ins
        on ins.ID_INSCRIPTION = md.ID_INSCRIPTION_REF
      join T_V5_KRHEF_SESSION ses
        on ses.ID_SESSION = ins.ID_SESSION

     where md.FROM_FINANCEMENT = 1
       and ins.ID_ACTEUR_FORM is null
  group by md.ID_INSCRIPTION_REF
         , ses.ID_SESSION_REF
         , ORDRE_PLAN
